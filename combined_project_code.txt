
--- START OF FILE: J:/FireRescue\collect_code.py ---

import os

# --- 配置区 ---

# 1. 将此列表修改为您三个项目所在的根目录
#    例如: ['J:/FireRescue', 'J:/RadarThermogram', 'J:/ManageSystemVue']
#    或者，如果它们都在一个文件夹下，比如 'J:/MyProjects'
#    您可以只写: ['J:/MyProjects']
PROJECT_ROOTS = [
    'J:/FireRescue'  # 示例路径，请修改为您的实际路径
    # 'PATH/TO/RadarThermogram', # 取消注释并修改
    # 'PATH/TO/ManageSystemVue'  # 取消注释并修改
]

# 2. 输出文件名
OUTPUT_FILE = 'combined_project_code.txt'

# 3. 要包含的文件扩展名
INCLUDE_EXTENSIONS = {
    '.java', '.py', '.vue', '.ts', '.js', '.html', '.css', '.scss',
    '.xml', '.properties', '.yml', '.yaml'
}

# 4. 要排除的目录（会跳过这些目录下的所有内容）
EXCLUDE_DIRS = {
    '.idea', '.git', '__pycache__', 'node_modules', 'target',
    'out', 'dist', 'build', 'venv', '.vscode'
}

# 5. 要排除的特定文件
EXCLUDE_FILES = {
    '.gitignore', 'mvnw', 'mvnw.cmd', 'yarn.lock',
    'package-lock.json', 'LICENSE'
}


# --- 脚本区 ---

def get_project_files(root_dir):
    """遍历项目目录，收集符合条件的文件路径"""
    file_paths = []
    for dirpath, dirnames, filenames in os.walk(root_dir, topdown=True):

        # 排除目录
        dirnames[:] = [d for d in dirnames if d not in EXCLUDE_DIRS]

        for filename in filenames:
            if filename in EXCLUDE_FILES:
                continue

            file_ext = os.path.splitext(filename)[1]
            if file_ext in INCLUDE_EXTENSIONS:
                full_path = os.path.join(dirpath, filename)
                file_paths.append(full_path)

    return file_paths


def combine_files(project_paths, output_filename):
    """将所有文件内容合并到一个输出文件中"""
    all_files = []
    for path in project_paths:
        if os.path.isdir(path):
            all_files.extend(get_project_files(path))
        elif os.path.isfile(path) and os.path.splitext(path)[1] in INCLUDE_EXTENSIONS:
            all_files.append(path)

    print(f"总共找到 {len(all_files)} 个源文件。正在合并...")

    try:
        with open(output_filename, 'w', encoding='utf-8') as outfile:
            for filepath in all_files:
                # 写入文件头，标明文件路径
                outfile.write(f"\n--- START OF FILE: {filepath} ---\n\n")

                try:
                    with open(filepath, 'r', encoding='utf-8', errors='ignore') as infile:
                        content = infile.read()
                        outfile.write(content)
                except Exception as e:
                    outfile.write(f"[无法读取文件: {e}]\n")

                outfile.write(f"\n\n--- END OF FILE: {filepath} ---\n")

        print(f"成功！所有代码已合并到 {output_filename}")

    except IOError as e:
        print(f"写入输出文件时出错: {e}")
    except Exception as e:
        print(f"发生未知错误: {e}")


if __name__ == "__main__":
    if not PROJECT_ROOTS or PROJECT_ROOTS[0] == '':
        print("错误：请先在脚本中配置 'PROJECT_ROOTS' 变量！")
    else:
        combine_files(PROJECT_ROOTS, OUTPUT_FILE)

--- END OF FILE: J:/FireRescue\collect_code.py ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\pom.xml ---

<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.4</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.skypapaya</groupId>
    <artifactId>FireRescueManageSystem</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>FireRescueManageSystem</name>
    <description>FireRescueManageSystem</description>
    <properties>
        <java.version>17</java.version>
    </properties>

    <dependencies>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.eclipse.paho</groupId>
            <artifactId>org.eclipse.paho.client.mqttv3</artifactId>
            <version>1.2.5</version>
        </dependency>

        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>3.0.3</version>
        </dependency>


        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.5.8</version>
        </dependency>
        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter-test</artifactId>
            <version>3.0.3</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.eclipse.paho</groupId>
            <artifactId>org.eclipse.paho.client.mqttv3</artifactId>
            <version>1.2.0</version>
        </dependency>

        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.1.23</version>
        </dependency>


        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>3.8.1</version>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.8.1</version>

                <configuration>
                    <!-- put your configurations here -->

                    <source>1.17</source>
                    <target>1.17</target>
                </configuration>
            </plugin>

        </plugins>
    </build>

</project>


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\pom.xml ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\FireRescueManageSystemApplication.java ---

package com.skypapaya.firerescuemanagesystem;
import com.skypapaya.firerescuemanagesystem.DAO.EnvironmentDAO;
import com.skypapaya.firerescuemanagesystem.DAO.MessageDAO;
import com.skypapaya.firerescuemanagesystem.DAO.UserDAO;
import com.skypapaya.firerescuemanagesystem.DAO.VitalSignsDAO;
import com.skypapaya.firerescuemanagesystem.mqtt.HuaweiCloudMQTT;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.ApplicationArguments;
import org.springframework.boot.ApplicationRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.RestController;

@RestController
@SpringBootApplication

public class FireRescueManageSystemApplication implements ApplicationRunner {

    @Autowired
    UserDAO userDAO;
    @Autowired
    EnvironmentDAO environmentDAO;
    @Autowired
    VitalSignsDAO vitalSignsDAO;

    @Autowired
    MessageDAO messageDAO; //注入MessageDAO

    public static void main(String[] args) {
        SpringApplication.run(FireRescueManageSystemApplication.class, args);
        System.out.print("start");

    }

    @Override
    public void run(ApplicationArguments args) throws Exception {
//        MqttPostPropertyMessageListener mqttPostPropertyMessageListener = new MqttPostPropertyMessageListener(vitalSignsDAO,environmentDAO);
//        mqttPostPropertyMessageListener.getMessage();
        HuaweiCloudMQTT huaweiCloudMQTT = new HuaweiCloudMQTT(vitalSignsDAO,environmentDAO);
        //huaweiCloudMQTT.saveInf();
        huaweiCloudMQTT.getInf();
    }
}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\FireRescueManageSystemApplication.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\config\CorsConfig.java ---

package com.skypapaya.firerescuemanagesystem.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins("http://localhost:5173")
                .allowedMethods("*")
                .allowedHeaders("*");
    }
}

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\config\CorsConfig.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\config\MyBatisConfig.java ---

package com.skypapaya.firerescuemanagesystem.config;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Configuration;

@Configuration
@MapperScan("com.skypapaya.firerescuemanagesystem.DAO")
public class MyBatisConfig {
}



--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\config\MyBatisConfig.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\AnalyzeDataController.java ---

package com.skypapaya.firerescuemanagesystem.controller;

import com.skypapaya.firerescuemanagesystem.DAO.AnalyzeDataDAO;
import com.skypapaya.firerescuemanagesystem.DO.AnalyzeDataDO;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class AnalyzeDataController {

    @Autowired
    AnalyzeDataDAO analyzeDataDAO;

    //返回指定年份的数据（直接）
//    @GetMapping("/findByYearDe")
//    public AnalyzeDataDO findByYearDe(@RequestParam("year") int year) {
//        return analyzeDataDAO.findByYearDe(year);
//    }

    //返回指定年份的数据（间接）
    @GetMapping("/findByYearIn")
    public AnalyzeDataDO findByYearIn(@RequestParam("year") int year) {
        return analyzeDataDAO.findByYearIn(year);
    }
}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\AnalyzeDataController.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\DeviceController.java ---

package com.skypapaya.firerescuemanagesystem.controller;

import com.skypapaya.firerescuemanagesystem.DAO.DeviceDAO;
import com.skypapaya.firerescuemanagesystem.DO.DeviceDO;
import com.skypapaya.firerescuemanagesystem.model.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/device") // 我们将所有设备相关的API放在 /device 路径下
public class DeviceController {

    @Autowired
    private DeviceDAO deviceDAO;

    /**
     * 获取所有设备列表
     * @return Result 包含设备列表
     */
    @GetMapping("/all")
    public Result getAllDevices() {
        List<DeviceDO> devices = deviceDAO.findAllDevices();
        return Result.success(devices);
    }

    /**
     * 添加一个新设备
     * @param device 从请求体中 JSON 自动转换的设备对象
     * @return Result 包含成功/失败信息
     */
    @PostMapping("/add")
    @ResponseBody
    public Result addDevice(@RequestBody DeviceDO device) {
        int result = deviceDAO.insertDevice(device);
        if (result > 0) {
            // 返回成功，并附带新插入的数据（可能包含自动生成的ID）
            return Result.success(device);
        } else {
            return Result.error("500", "添加设备失败");
        }
    }

    /**
     * 根据ID删除一个设备
     * @param id 从路径中获取的设备ID
     * @return Result 包含成功/失败信息
     */
    @DeleteMapping("/delete/{id}")
    public Result deleteDevice(@PathVariable Long id) {
        int result = deviceDAO.deleteDeviceById(id);
        if (result > 0) {
            return Result.success("删除成功");
        } else {
            return Result.error("500", "删除失败，设备可能不存在");
        }
    }
}

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\DeviceController.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\EnvironmentController.java ---

package com.skypapaya.firerescuemanagesystem.controller;
import com.skypapaya.firerescuemanagesystem.DAO.EnvironmentDAO;
import com.skypapaya.firerescuemanagesystem.DO.EnvironmentDO;
import com.skypapaya.firerescuemanagesystem.model.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;
@CrossOrigin(origins = "http://loclahost:5173")
@RestController
public class EnvironmentController {
    @Autowired
    EnvironmentDAO environmentDAO;
    //查询最新的一条数据
    @GetMapping("environment/getTheLatest")
    public Result getTheLasted() {
        Result result = new Result();
        List<EnvironmentDO> environmentDOS = environmentDAO.getTheLatest();
        if (environmentDOS == null) {
            result.setCode("404");
            result.setMessage("没有数据");
            return result;
        }
        result.setData(environmentDOS);
        return Result.success(environmentDOS);
    }
    //插入数据
    @ResponseBody
    @PostMapping("environment/insertEnvironment")
    public Result insertEnvironmentDO(@RequestBody EnvironmentDO environment) {
        EnvironmentDO environmentDO = new EnvironmentDO();
        int res = environmentDAO.insertEnvironmentDO(environmentDO);
        if (res == 1) {
            return Result.success("插入成功");
        } else {
            return Result.error("插入失败");
        }
    }
}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\EnvironmentController.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\MessageController.java ---

package com.skypapaya.firerescuemanagesystem.controller;

import com.skypapaya.firerescuemanagesystem.DAO.MessageDAO;
import com.skypapaya.firerescuemanagesystem.DO.MessageDO;
import com.skypapaya.firerescuemanagesystem.model.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/message")
public class MessageController {

    @Autowired
    private MessageDAO messageDAO;

    /**
     * 获取所有消息，并按状态 (unread, read, recycle) 分组
     * 这完全匹配 tabs.vue [cite: 683] 的 'state' 结构
     */
    @GetMapping("/all")
    public Result getAllMessages() {
        List<MessageDO> allMessages = messageDAO.findAll();

        List<MessageDO> unread = new ArrayList<>();
        List<MessageDO> read = new ArrayList<>();
        List<MessageDO> recycle = new ArrayList<>();

        for (MessageDO msg : allMessages) {
            switch (msg.getStatus()) {
                case 0: // 未读
                    unread.add(msg);
                    break;
                case 1: // 已读
                    read.add(msg);
                    break;
                case 2: // 回收站
                    recycle.add(msg);
                    break;
            }
        }

        Map<String, List<MessageDO>> result = new HashMap<>();
        result.put("unread", unread);
        result.put("read", read);
        result.put("recycle", recycle);

        return Result.success(result);
    }

    /**
     * 标为已读 (对应 handleRead [cite: 685])
     * 0 -> 1
     */
    @PutMapping("/read/{id}")
    public Result markAsRead(@PathVariable Long id) {
        messageDAO.updateStatusById(id, 1);
        return Result.success();
    }

    /**
     * 删除到回收站 (对应 handleDel [cite: 686])
     * 1 -> 2
     */
    @PutMapping("/recycle/{id}")
    public Result moveToRecycle(@PathVariable Long id) {
        messageDAO.updateStatusById(id, 2);
        return Result.success();
    }

    /**
     * 从回收站还原 (对应 handleRestore [cite: 687])
     * 2 -> 1
     */
    @PutMapping("/restore/{id}")
    public Result restoreFromRecycle(@PathVariable Long id) {
        messageDAO.updateStatusById(id, 1);
        return Result.success();
    }

    /**
     * 全部标为已读 (对应 "全部标为已读" 按钮 [cite: 676-677])
     * 0 -> 1
     */
    @PutMapping("/read-all")
    public Result markAllAsRead() {
        messageDAO.updateAllStatus(0, 1);
        return Result.success();
    }

    /**
     * 删除全部已读 (对应 "删除全部" 按钮 [cite: 679])
     * 1 -> 2
     */
    @PutMapping("/recycle-all-read")
    public Result moveAllReadToRecycle() {
        messageDAO.updateAllStatus(1, 2);
        return Result.success();
    }

    /**
     * 清空回收站 (对应 "清空回收站" 按钮 [cite: 681-682])
     * 2 -> (DELETE)
     */
    @DeleteMapping("/recycle-bin")
    public Result emptyRecycleBin() {
        messageDAO.deleteByStatus(2);
        return Result.success();
    }
}

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\MessageController.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\TodoController.java ---

package com.skypapaya.firerescuemanagesystem.controller;

import com.skypapaya.firerescuemanagesystem.DAO.TodoDAO;
import com.skypapaya.firerescuemanagesystem.DO.TodoDO;
import com.skypapaya.firerescuemanagesystem.model.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/todo")
public class TodoController {

    @Autowired
    private TodoDAO todoDAO;

    // 1. 获取所有待办事项
    @GetMapping("/all")
    public Result getAllTodos() {
        List<TodoDO> todos = todoDAO.findAll();
        return Result.success(todos);
    }

    // 2. 添加新事项
    @PostMapping("/add")
    public Result addTodo(@RequestBody TodoDO todo) {
        // 默认状态为 false (未完成)
        todo.setStatus(false);
        todoDAO.insertTodo(todo);
        return Result.success(todo); // 返回带 ID 的对象
    }

    // 3. 更新事项状态 (checkbox)
    @PutMapping("/update")
    public Result updateTodoStatus(@RequestBody TodoDO todo) {
        todoDAO.updateTodoStatus(todo);
        return Result.success();
    }

    // 4. 删除单个事项 (X)
    @DeleteMapping("/delete/{id}")
    public Result deleteTodo(@PathVariable Long id) {
        todoDAO.deleteTodo(id);
        return Result.success();
    }

    // 5. 全部完成
    @PutMapping("/completeAll")
    public Result completeAll() {
        todoDAO.updateAllStatus(true); // true = 完成
        return Result.success();
    }

    // 6. 删除所有
    @DeleteMapping("/deleteAll")
    public Result deleteAll() {
        todoDAO.deleteAll();
        return Result.success();
    }
}

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\TodoController.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\UserController.java ---

package com.skypapaya.firerescuemanagesystem.controller;

import com.skypapaya.firerescuemanagesystem.DAO.UserDAO;
import com.skypapaya.firerescuemanagesystem.DO.UserDO;
import com.skypapaya.firerescuemanagesystem.model.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/user")
public class UserController {

    @Autowired
    private UserDAO userDAO;

    @PostMapping("/login")
    @ResponseBody
    public Result loginUser(@RequestBody UserDO loginRequest) {
        // 1. 根据用户名查询数据库
        UserDO dbUser = userDAO.findByName(loginRequest.getName());

        // 2. 检查用户是否存在
        if (dbUser == null) {
            return Result.error("404", "用户不存在");
        }

        // 3. 检查密码 (明文比较)
        if (!loginRequest.getPassword().equals(dbUser.getPassword())) {
            return Result.error("401", "密码错误");
        }

        // 4. 登录成功
        // 返回完整的用户信息，前端需要用 authority
        return Result.success(dbUser);
    }

    //编辑用户信息
    @PutMapping("/updateUser")
    @ResponseBody
    public Result updateUser(@RequestBody UserDO user) {
        // 检查 authority 字段，防止普通用户给自己提权
        // (这是一个可选的安全增强)
        // if (user.getAuthority() != null && user.getAuthority().equals("admin")) {
        //    // 在这里添加逻辑：检查当前操作者是否是 admin
        //    // 如果不是，则 return Result.error("403", "权限不足");
        // }

        int result = userDAO.updateUser(user);

        if (result > 0) {
            return Result.success("更新成功");
        } else {
            return Result.error("500", "更新失败，用户可能不存在");
        }
    }

    @PostMapping("/register")
    @ResponseBody
//    public Result registerUser(@RequestBody UserDO user) {
    public Result registerUser(@RequestBody Map<String, Object> body) {
        System.out.println("user:" + body.toString());
        // 检查用户名是否已存在 (可选但推荐)
        // ... (
        //   List<UserDO> users = userDAO.findByName(user.getName());
        //   if (users.size() > 0) {
        //       return Result.error("501", "用户名已存在");
        //   }
        // )
        UserDO user = new UserDO((String) body.get("name"), (String) body.get("eMail"), (String) body.get("phone"), (String) body.get("sex"), (String) body.get("password"), body.get("age") != null ? (int) body.get("age") : 0, (String) body.get("address"));
        System.out.println("user:" + user.toString());
        // 1. 检查用户名
        UserDO dbUserByName = userDAO.findByName(user.getName());
        if (dbUserByName != null) {
            return Result.error("501", "该用户名已被注册");
        }

        // 2. 检查邮箱
        UserDO dbUserByEmail = userDAO.findByEMail(user.getE_mail());
        if (dbUserByEmail != null) {
            return Result.error("502", "该邮箱已被注册");
        }

        // 3. 检查phone
        UserDO dbUserByPhone = userDAO.findByPhone(user.getPhone());
        if (dbUserByPhone != null) {
            return Result.error("503", "该电话已被注册");
        }

        // 3. 【新增逻辑】检查年龄
        // 检查 age 字段是否被提供了 (因为它是可选的)
        // 注意：UserDO.java 中 age 字段是 int 类型，它在 JSON 没传时默认为 0，
        // 如果是 Integer 类型，它默认为 null。我们假设你用的是 int。

        // 如果传来的年龄不为 0 (即用户输入了) 并且小于 18
        if (user.getAge() != 0 && user.getAge() < 18) {
            return Result.error("504", "注册用户年龄必须大于18岁");
        }
        // 如果你的 UserDO.java 中 age 是 Integer 类型，请使用下面的判断：
        /*
        if (user.getAge() != null && user.getAge() < 18) {
             return Result.error("503", "注册用户年龄必须大于18岁");
        }
        */
        // 我们跳过加密，直接插入
        int result = userDAO.registerUser(user);

        if (result > 0) {
            return Result.success("注册成功");
        } else {
            return Result.error("500", "注册失败");
        }
    }

    //返回所有user对象
    @GetMapping("/users")
    public Result findAll() {
        List<UserDO> users = userDAO.findAll();
        return Result.success(users);
    }

    //插入用户，根据user对象
    @PostMapping("/insertUser")
    @ResponseBody
    public int insertUser(@RequestBody UserDO user) {
        return userDAO.insertUser(user);
    }

    //根据id删除用户
    @DeleteMapping("/deleteUser{id}")
    public int delete(@PathVariable Long id) {
        return userDAO.delete(id);
    }

    @GetMapping("/userPage")
    public Result page(@RequestParam("pageNum") int pageNum, @RequestParam("size") int size) {
        pageNum = (pageNum - 1) * size;
        Map<String, Object> res = new HashMap<>();
        res.put("total", userDAO.count());
        res.put("data", userDAO.page(pageNum, size));
        return Result.success(res);
    }


}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\UserController.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\VitalController.java ---

package com.skypapaya.firerescuemanagesystem.controller;

import com.skypapaya.firerescuemanagesystem.DAO.VitalSignsDAO;
import com.skypapaya.firerescuemanagesystem.DO.VitalSignsDO;
import com.skypapaya.firerescuemanagesystem.model.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class VitalController {
    @Autowired
    VitalSignsDAO vitalSignsDAO;

    @GetMapping("vital/getTheLatest")
    public Result getTheLasted() {
        Result result = new Result();
        VitalSignsDO vitalSignsDO = vitalSignsDAO.getTheLastedVitalSigns();
        if (vitalSignsDO == null) {
            result.setCode("404");
            result.setMessage("没有数据");
            return result;
        }
        result.setData(vitalSignsDO);
        return Result.success(vitalSignsDO);
    }
}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\controller\VitalController.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\AnalyzeDataDAO.java ---

package com.skypapaya.firerescuemanagesystem.DAO;

import com.skypapaya.firerescuemanagesystem.DO.AnalyzeDataDO;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface AnalyzeDataDAO {

    //返回指定年份的数据（直接）
    public AnalyzeDataDO findByYearDe(@Param("year") int year);

    //返回指定年份的数据（间接）
    public AnalyzeDataDO findByYearIn(@Param("year") int year);


}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\AnalyzeDataDAO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\DeviceDAO.java ---

package com.skypapaya.firerescuemanagesystem.DAO;

import com.skypapaya.firerescuemanagesystem.DO.DeviceDO;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Mapper
@Repository
public interface DeviceDAO {

    /**
     * 查询所有设备
     * @return 设备列表
     */
    List<DeviceDO> findAllDevices();

    /**
     * 插入一个新设备
     * @param device 设备对象
     * @return 影响的行数
     */
    int insertDevice(DeviceDO device);

    /**
     * 根据ID删除设备
     * @param id 设备ID
     * @return 影响的行数
     */
    int deleteDeviceById(@Param("id") Long id);
}

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\DeviceDAO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\EnvironmentDAO.java ---

package com.skypapaya.firerescuemanagesystem.DAO;

import com.skypapaya.firerescuemanagesystem.DO.EnvironmentDO;
import org.apache.ibatis.annotations.Mapper;
import org.springframework.stereotype.Repository;

import java.util.List;


@Mapper
@Repository
public interface EnvironmentDAO {

    public int insertEnvironmentDO(EnvironmentDO environmentDO);
    public List<EnvironmentDO> getTheLatest();




}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\EnvironmentDAO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\MessageDAO.java ---

package com.skypapaya.firerescuemanagesystem.DAO;

import com.skypapaya.firerescuemanagesystem.DO.MessageDO;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Mapper
@Repository
public interface MessageDAO {

    /**
     * 查询所有消息
     */
    List<MessageDO> findAll();

    /**
     * (可选) 插入新消息
     */
    int insertMessage(MessageDO message);

    /**
     * 根据ID更新单个消息的状态
     * (用于: 标为已读、删除到回收站、还原)
     */
    int updateStatusById(@Param("id") Long id, @Param("status") int status);

    /**
     * 批量更新状态
     * (用于: 全部标为已读、删除全部)
     */
    int updateAllStatus(@Param("fromStatus") int fromStatus, @Param("toStatus") int toStatus);

    /**
     * 按状态删除
     * (用于: 清空回收站)
     */
    int deleteByStatus(@Param("status") int status);
}

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\MessageDAO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\TodoDAO.java ---

package com.skypapaya.firerescuemanagesystem.DAO;

import com.skypapaya.firerescuemanagesystem.DO.TodoDO;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Mapper
@Repository
public interface TodoDAO {
    // 1. 查询所有待办事项
    List<TodoDO> findAll();

    // 2. 新增一个待办事项
    int insertTodo(TodoDO todo);

    // 3. 更新一个待办事项的状态
    int updateTodoStatus(TodoDO todo);

    // 4. 删除一个待办事项
    int deleteTodo(@Param("id") Long id);

    // 5. 更新所有事项的状态 (全部完成)
    int updateAllStatus(@Param("status") Boolean status);

    // 6. 删除所有事项 (清空)
    int deleteAll();
}

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\TodoDAO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\UserDAO.java ---

package com.skypapaya.firerescuemanagesystem.DAO;

import com.skypapaya.firerescuemanagesystem.DO.UserDO;
import org.apache.ibatis.annotations.*;

import java.util.List;

@Mapper
public interface UserDAO {

    public List<UserDO> findAll();

    int insertUser(UserDO user);

    int delete(@Param("id") Long id);

    int registerUser(UserDO user);
    //编辑用户信息
    int updateUser(UserDO user);


    //根据用户名查询用户

    UserDO findByName(@Param("name") String name);

    // 根据eMail查询用户
    UserDO findByEMail(@Param("eMail") String eMail);

    // 根据phone查询用户
    UserDO findByPhone(@Param("phone") String phone);

    //分页查询的实现
    List<UserDO> page(int page, int size);

    //返回数据库的总条数
    @Select("SELECT COUNT(*) from user")
    int count();

}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\UserDAO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\VitalSignsDAO.java ---

package com.skypapaya.firerescuemanagesystem.DAO;

import com.skypapaya.firerescuemanagesystem.DO.VitalSignsDO;
import com.skypapaya.firerescuemanagesystem.model.Result;
import org.apache.ibatis.annotations.Mapper;
import org.springframework.stereotype.Component;
import org.springframework.stereotype.Repository;

import java.rmi.server.RemoteRef;
import java.util.List;

@Mapper
@Repository
public interface VitalSignsDAO {
    public int insertVitalSignsDO(VitalSignsDO vitalSignsDO);

    public VitalSignsDO getTheLastedVitalSigns();
}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DAO\VitalSignsDAO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\AnalyzeDataDO.java ---

package com.skypapaya.firerescuemanagesystem.DO;

import lombok.Data;

import java.time.LocalDateTime;

@Data
public class AnalyzeDataDO {

    int year;
    //直接损失
//    double deJan;
//    double deFeb;
//    double deMar;
//    double deApr;
//    double deMay;
//    double deJun;
//    double deJul;
//    double deAug;
//    double deSep;
//    double deOct;
//    double deNov;
//    double deDec;
    //间接损失
    double inJan;
    double inFeb;
    double inMar;
    double inApr;
    double inMay;
    double inJun;
    double inJul;
    double inAug;
    double inSep;
    double inOct;
    double inNov;
    double inDec;
    LocalDateTime gmtCreated;
    LocalDateTime gmtModified;


}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\AnalyzeDataDO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\DeviceDO.java ---

package com.skypapaya.firerescuemanagesystem.DO;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class DeviceDO {

    private Long id;
    private String name;
    private String location;
    private String status;
    private LocalDateTime gmtCreated;
    private LocalDateTime gmtModified;

    // Lombok 的 @Data 会自动生成 getters, setters, toString, equals, 和 hashCode
}

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\DeviceDO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\EnvironmentDO.java ---

package com.skypapaya.firerescuemanagesystem.DO;

import com.fasterxml.jackson.annotation.JsonManagedReference;
import lombok.Data;

import java.time.LocalDateTime;

@Data
public class EnvironmentDO {

    Long id;
    float co;
    float fire;
    float humidity;
    float risk;
    float smoke;
    float temperature;
    EnvironmentDO environmentDO;
    LocalDateTime createTime;
    LocalDateTime modifyTime;


    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public float getCo() {
        return co;
    }

    public void setCo(float co) {
        this.co = co;
    }

    public float getFire() {
        return fire;
    }

    public void setFire(float fire) {
        this.fire = fire;
    }

    public float getHumidity() {
        return humidity;
    }

    public void setHumidity(float humidity) {
        this.humidity = humidity;
    }

    public float getRisk() {
        return risk;
    }

    public void setRisk(float risk) {
        this.risk = risk;
    }

    public float getSmoke() {
        return smoke;
    }

    public void setSmoke(float smoke) {
        this.smoke = smoke;
    }

    public float getTemperature() {
        return temperature;
    }

    public void setTemperature(float temperature) {
        this.temperature = temperature;
    }

    public EnvironmentDO getEnvironmentDO() {
        return environmentDO;
    }

    public void setEnvironmentDO(EnvironmentDO environmentDO) {
        this.environmentDO = environmentDO;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public LocalDateTime getModifyTime() {
        return modifyTime;
    }

    public void setModifyTime(LocalDateTime modifyTime) {
        this.modifyTime = modifyTime;
    }

    public EnvironmentDO(float co, float fire, float humidity, float risk, float smoke, float temperature) {
        this.co = co;
        this.fire = fire;
        this.humidity = humidity;
        this.risk = risk;
        this.smoke = smoke;
        this.temperature = temperature;
    }

    public EnvironmentDO() {

    }
    
}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\EnvironmentDO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\MessageDO.java ---

package com.skypapaya.firerescuemanagesystem.DO;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class MessageDO {

    private Long id;
    private String title;

    // 对应数据库的 message_time
    private LocalDateTime messageTime;

    // 对应 TINYINT, 0=未读, 1=已读, 2=回收站
    private Integer status;

    private LocalDateTime gmtCreated;
    private LocalDateTime gmtModified;
}

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\MessageDO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\TodoDO.java ---

package com.skypapaya.firerescuemanagesystem.DO;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class TodoDO {
    private Long id;
    private String title;
    private Boolean status;
    private LocalDateTime gmtCreated;
    private LocalDateTime gmtModified;
}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\TodoDO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\UserDO.java ---

package com.skypapaya.firerescuemanagesystem.DO;

import lombok.Data;

import java.time.LocalDateTime;

@Data
public class UserDO {
    Long id;
    String name;
    int age;
    String e_mail;
    String phone;
    String sex;
    String authority;
    String address;
    String password;
    LocalDateTime gmtCreated;
    LocalDateTime gmtModified;

    public UserDO() {}

    public UserDO(String name, String e_mail, String phone, String sex, String password, int age, String address) {
        this.name = name;
        this.e_mail = e_mail;
        this.phone = phone;
        this.sex = sex;
        this.password = password;
        this.age = age;
        this.address = address;
    }

    public String toString() {
        return "UserDO{" +"id=" + id + ", name='" + name + '\'' + ", age=" + age + ", eMail='" + e_mail + '\'' + ", phone='" + phone + '\'' + ", sex='" + sex + '\'' + ", authority='" + authority + '\'' + ", address='" + address + '\'' + ", password='" + password + '\'' + "}";
    }

}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\UserDO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\VitalSignsDO.java ---

package com.skypapaya.firerescuemanagesystem.DO;

import com.fasterxml.jackson.annotation.JsonIgnore;
import lombok.Data;

import java.time.LocalDateTime;

import static java.time.LocalDateTime.now;

@Data
public class VitalSignsDO {
    long id;
    float breathRate;
    Integer heartRate;
    float signalStrength;
    Integer active;
    Integer distance;
    Integer exist;
    Integer life;
    Integer people;
    @JsonIgnore
    VitalSignsDO vitalSignsDO;
    LocalDateTime createTime;
    LocalDateTime modifyTime;

    public VitalSignsDO getVitalSignsDO() {
        return vitalSignsDO;
    }

    public void setVitalSignsDO(VitalSignsDO vitalSignsDO) {
        this.vitalSignsDO = vitalSignsDO;
    }

    public LocalDateTime getCreateTime() {
        return createTime;
    }

    public void setCreateTime(LocalDateTime createTime) {
        this.createTime = createTime;
    }

    public LocalDateTime getModifyTime() {
        return modifyTime;
    }

    public void setModifyTime(LocalDateTime modifyTime) {
        this.modifyTime = modifyTime;
    }

    public long getId() {
        return id;
    }

    public void setId(long id) {
        this.id = id;
    }

    public float getBreathRate() {
        return breathRate;
    }

    public void setBreathRate(float breathRate) {
        this.breathRate = breathRate;
    }

    public Integer getHeartRate() {
        return heartRate;
    }

    public void setHeartRate(Integer heartRate) {
        this.heartRate = heartRate;
    }

    public float getSignalStrength() {
        return signalStrength;
    }

    public void setSignalStrength(float signalStrength) {
        this.signalStrength = signalStrength;
    }

    public Integer getActive() {
        return active;
    }

    public void setActive(Integer active) {
        this.active = active;
    }

    public Integer getDistance() {
        return distance;
    }

    public void setDistance(Integer distance) {
        this.distance = distance;
    }

    public Integer getExist() {
        return exist;
    }

    public void setExist(Integer exist) {
        this.exist = exist;
    }

    public Integer getLife() {
        return life;
    }

    public void setLife(Integer life) {
        this.life = life;
    }

    public Integer getPeople() {
        return people;
    }

    public void setPeople(Integer people) {
        this.people = people;
    }


    public VitalSignsDO(float breathRate, Integer heartRate, float signalStrength, Integer active, Integer distance, Integer exist, Integer life, Integer people) {
        this.breathRate = breathRate;
        this.heartRate = heartRate;
        this.signalStrength = signalStrength;
        this.active = active;
        this.distance = distance;
        this.exist = exist;
        this.life = life;
        this.people = people;
        this.createTime = now();
        this.modifyTime = now();
    }

    public VitalSignsDO() {
    }


}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\DO\VitalSignsDO.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\model\Result.java ---

package com.skypapaya.firerescuemanagesystem.model;

public class Result {
    //状态码
    String code;
    //发送的信息
    String message;
    //返回的数据
    Object data;

    public Result(String code, String message, Object data) {
        this.code = code;
        this.message = message;
        this.data = data;
    }

    public Result(String code, String message) {
        this.code = code;
        this.message = message;
    }

    public Result() {
    }


    public String getCode() {
        return code;
    }

    public void setCode(String code) {
        this.code = code;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }

    public Object getData() {
        return data;
    }

    public void setData(Object data) {
        this.data = data;
    }

    //传输成功
    public static Result success() {
        return new Result("200", "success");
    }

    public static Result success(Object data) {
        return new Result("200", "success", data);
    }

    public static Result error(String message) {
        return new Result("500", message);
    }

    public static Result error(String code, String message) {
        return new Result(code, message);
    }

    //传输失败
    public static Result fail() {
        return new Result("500", "fail");
    }
}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\model\Result.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\mqtt\HuaweiCloudMQTT.java ---

package com.skypapaya.firerescuemanagesystem.mqtt;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.skypapaya.firerescuemanagesystem.DAO.EnvironmentDAO;
import com.skypapaya.firerescuemanagesystem.DAO.VitalSignsDAO;
import com.skypapaya.firerescuemanagesystem.DO.EnvironmentDO;
import com.skypapaya.firerescuemanagesystem.DO.VitalSignsDO;
import org.eclipse.paho.client.mqttv3.*;
import org.eclipse.paho.client.mqttv3.persist.MemoryPersistence;


public class HuaweiCloudMQTT {
    private EnvironmentDAO environmentDAO;
    private VitalSignsDAO vitalSignsDAO;
    private String data;

    public HuaweiCloudMQTT(VitalSignsDAO vitalSignsDAO, EnvironmentDAO environmentDAO) {
        this.vitalSignsDAO = vitalSignsDAO;
        this.environmentDAO = environmentDAO;
    }



    public void getInf() {

        String broker = "ssl://5e1d9e2307.st1.iotda-device.cn-north-4.myhuaweicloud.com:8883";
        String clientId = "65feba432ccc1a58387dee47_java_server_02_0_0_2024071905";
        String topic = "$devices/java_server_02/user/get_post";  // 替换为你要发布和订阅的主题
        //String content = "Message from MqttPublishSample";
        int qos = 2;
        String username = "65feba432ccc1a58387dee47_java_server_02";
        String password = "476b330a901c119c9ca15c3cd8eeb0cac9cd60b9f974b998df3310a3e32687a2";

        MemoryPersistence persistence = new MemoryPersistence();

        try {
            MqttClient client = new MqttClient(broker, clientId, persistence);
            MqttConnectOptions connOpts = new MqttConnectOptions();
            connOpts.setCleanSession(true);
            connOpts.setUserName(username);
            connOpts.setPassword(password.toCharArray());
            connOpts.setKeepAliveInterval(60);
            connOpts.setConnectionTimeout(30);

            //System.out.println("Connecting to broker: " + broker);
            client.connect(connOpts);
            //System.out.println("Connected");

            // 订阅主题
            client.subscribe(topic, qos);
            client.setCallback(new MqttCallback() {


                @Override
                public void connectionLost(Throwable throwable) {

                }

                //消息内容
                @Override
                public void messageArrived(String topic, MqttMessage message) {
                    try {
                        // 解析消息
                        data = new String(message.getPayload());

                        // 打印收到的数据
                        System.out.println("Received data: " + data);

                        // 尝试将字符串解析为 JSON 对象
                        JSONObject jsonObject = JSON.parseObject(data);
                        JSONArray servicesArray = jsonObject.getJSONArray("services");

                        if (servicesArray != null && !servicesArray.isEmpty()) {
                            JSONObject serviceObject = servicesArray.getJSONObject(0);
                            JSONObject propertiesObject = serviceObject.getJSONObject("properties");

                            // 获取各个属性的值并处理
                            //环境信息数据
                            float smoke = propertiesObject.getFloatValue("smoke");
                            float co = propertiesObject.getFloatValue("CO");
                            float fire = propertiesObject.getFloatValue("FIRE");
                            float temperature = propertiesObject.getFloatValue("temperature");
                            float humidity = propertiesObject.getFloatValue("Humidity");
                            //生命体征数据
                            float breathRate = propertiesObject.getFloatValue("BreathRate");

                            Integer heartRate = propertiesObject.getInteger("HeartRate");
                            float signalStrength = propertiesObject.getFloatValue("SignalStrength");


                            Integer active = propertiesObject.getInteger("active");
                            Integer distance = propertiesObject.getInteger("distance");
                            Integer exist = propertiesObject.getInteger("exist");
                            Integer life = propertiesObject.getInteger("life");
                            Integer people = propertiesObject.getInteger("people");

                            System.out.println(life);

                            // 插入数据库
                            EnvironmentDO environmentDO = new EnvironmentDO(co, fire, humidity, 0, smoke, temperature);
                            environmentDAO.insertEnvironmentDO(environmentDO);
                            VitalSignsDO vitalSignsDO = new VitalSignsDO( breathRate,heartRate,  signalStrength,  active,  distance,  exist,  life,  people);
                            vitalSignsDAO.insertVitalSignsDO(vitalSignsDO);

                            System.out.println("Environment data inserted successfully.");
                        } else {
                            System.out.println("No services found in the JSON data.");
                        }
                    } catch (ClassCastException e) {
                        System.out.println("ClassCastException caught: " + e.getMessage());
                        //e.printStackTrace();  // 打印堆栈信息
                    } catch (Exception e) {
                        System.out.println("Exception caught: " + e.getMessage());
                        //e.printStackTrace();  // 打印堆栈信息
                    }
                }


                @Override
                public void deliveryComplete(IMqttDeliveryToken token) {
                   // System.out.println("Delivery complete. " + token.isComplete());
                }
            });

            // 发布消息
            /*
            MqttMessage message = new MqttMessage(content.getBytes());
            message.setQos(qos);

            //System.out.println("Publishing message: " + content);
            client.publish(topic, message);
            //System.out.println("Message published");

             */
            // 保持连接以接收消息
            Thread.sleep(60000000);//保持连接1分钟
            client.disconnect();
            //System.out.println("Disconnected");
            System.exit(0);

        } catch (MqttException | InterruptedException me) {
            //System.out.println("reason " + me.getReasonCode());
            System.out.println("msg " + me.getMessage());
            System.out.println("loc " + me.getLocalizedMessage());
            System.out.println("cause " + me.getCause());
            System.out.println("excep " + me);
            me.printStackTrace();
        }
    }
    public void saveInf(){

        /*
        try{
            JSONObject jsonObject = JSON.parseObject(data);
            JSONArray servicesArray = jsonObject.getJSONArray("services");

            float breathingRate = Float.parseFloat(jsonObject.getJSONObject("checkFailedData").getJSONObject("BreathingRate").getString("value"));
            Integer heartRate = Integer.parseInt(jsonObject.getJSONObject("checkFailedData").getJSONObject("HeartRate").getString("value"));
            float signalStrength = Float.parseFloat(jsonObject.getJSONObject("checkFailedData").getJSONObject("SignalStrength").getString("value"));
            Integer active = Integer.parseInt(jsonObject.getJSONObject("checkFailedData").getJSONObject("active").getString("value"));
            Integer distance = Integer.parseInt(jsonObject.getJSONObject("checkFailedData").getJSONObject("distance").getString("value"));
            Integer exist = Integer.parseInt(jsonObject.getJSONObject("checkFailedData").getJSONObject("exist").getString("value"));
            Integer life = Integer.parseInt(jsonObject.getJSONObject("checkFailedData").getJSONObject("life").getString("value"));
            Integer people = Integer.parseInt(jsonObject.getJSONObject("checkFailedData").getJSONObject("people").getString("value"));

            VitalSignsDO vitalSignsDO = new VitalSignsDO(breathingRate, heartRate, signalStrength, active, distance, exist, life, people);
            vitalSignsDAO.insertVitalSignsDO(vitalSignsDO);

            float co = Float.parseFloat(jsonObject.getJSONObject("checkFailedData").getJSONObject("CO").getString("value"));
            float fire = Float.parseFloat(jsonObject.getJSONObject("checkFailedData").getJSONObject("FIRE").getString("value"));
            float humidity = Float.parseFloat(jsonObject.getJSONObject("checkFailedData").getJSONObject("Humidity").getString("value"));
            float risk = Float.parseFloat(jsonObject.getJSONObject("checkFailedData").getJSONObject("Risk").getString("value"));
            float smoke = Float.parseFloat(jsonObject.getJSONObject("checkFailedData").getJSONObject("smoke").getString("value"));
            float temperature = Float.parseFloat(jsonObject.getJSONObject("checkFailedData").getJSONObject("temperature").getString("value"));

            System.out.println(co);
            EnvironmentDO environmentDO = new EnvironmentDO(co, fire, humidity, risk, smoke, temperature);
            environmentDAO.insertEnvironmentDO(environmentDO);
        }catch (Exception e){
            e.printStackTrace();
        }


         */
        getInf();
        //System.out.println(data);

        JSONObject jsonObject = JSON.parseObject(data);
        JSONArray servicesArray = jsonObject.getJSONArray("services");

        if (servicesArray != null && !servicesArray.isEmpty()) {
            JSONObject serviceObject = servicesArray.getJSONObject(0);
            JSONObject propertiesObject = serviceObject.getJSONObject("properties");

            System.out.println(data);
            // 获取各个属性的值
            float smoke = propertiesObject.getFloatValue("smoke");
            float co = propertiesObject.getFloatValue("CO");
            float fire = propertiesObject.getFloatValue("FIRE");
            int people = propertiesObject.getIntValue("people");
            float temperature = propertiesObject.getFloatValue("temperature");
            float humidity = propertiesObject.getFloatValue("Humidity");

            // 输出结果
            System.out.println("Smoke: " + smoke);
            System.out.println("CO: " + co);
            System.out.println("FIRE: " + fire);
            System.out.println("People: " + people);
            System.out.println("Temperature: " + temperature);
            System.out.println("Humidity: " + humidity);
        } else {
            System.out.println("No services found in the JSON data.");
        }


    }


}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\mqtt\HuaweiCloudMQTT.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\service\EnvirnomentService.java ---

package com.skypapaya.firerescuemanagesystem.service;

public class EnvirnomentService{
}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\service\EnvirnomentService.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\service\UserService.java ---

package com.skypapaya.firerescuemanagesystem.service;

import org.springframework.stereotype.Service;

@Service
public class UserService {

}


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\java\com\skypapaya\firerescuemanagesystem\service\UserService.java ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\application.properties ---

spring.application.name=FireRescueManageSystem
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://106.14.144.103:3306/fire?serverTimezone=GMT%2B8
spring.datasource.username=SkyPapaya
spring.datasource.password=Whm161122309

mybatis.mapper-locations=classpath:com/skypapaya/firerescuemanagesystem/*.xml,classpath:com/skypapaya/firerescuemanagesystem/dao/*.xml

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\application.properties ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\mybatis-config.xml ---

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"></transactionManager>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://106.14.144.103:3306/fire?serverTimezone=GMT%2B8"/>
                <property name="username" value="SkyPapaya"/>
                <property name="password" value="Whm161122309"/>
            </dataSource>

        </environment>
    </environments>
    <mappers>
        <mapper resource="com/skypapaya/firerescuemanagesystem.DAO/*.xml"/>
        <package name="com.skypapaya.firerescuemanagesystem.DAO"/>
    </mappers>
</configuration>

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\mybatis-config.xml ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\AnalyzeData.xml ---

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skypapaya.firerescuemanagesystem.DAO.AnalyzeDataDAO">
    <resultMap id="analyzeDataResultMap" type="com.skypapaya.firerescuemanagesystem.DO.AnalyzeDataDO">
        <id column="year" property="year"/>
                <result column="de_jan" property="deJan"/>
                <result column="de_feb" property="deFeb"/>
                <result column="de_mar" property="deMar"/>
                <result column="de_apr" property="deApr"/>
                <result column="de_may" property="deMay"/>
                <result column="de_jun" property="deJun"/>
                <result column="de_jul" property="deJul"/>
                <result column="de_aug" property="deAug"/>
                <result column="de_sep" property="deSep"/>
                <result column="de_oct" property="deOct"/>
                <result column="de_nov" property="deNov"/>
                <result column="de_dec" property="deDec"/>
        <result column="in_jan" property="inJan"/>
        <result column="in_feb" property="inFeb"/>
        <result column="in_mar" property="inMar"/>
        <result column="in_apr" property="inApr"/>
        <result column="in_may" property="inMay"/>
        <result column="in_jun" property="inJun"/>
        <result column="in_jul" property="inJul"/>
        <result column="in_aug" property="inAug"/>
        <result column="in_sep" property="inSep"/>
        <result column="in_oct" property="inOct"/>
        <result column="in_nov" property="inNov"/>
        <result column="in_dec" property="inDec"/>

    </resultMap>
    <select id="findByYearDe" resultMap="analyzeDataResultMap">
        SELECT *
        from financial_loss_direct
        where year = #{year}

    </select>
    <select id="findByYearIn" resultMap="analyzeDataResultMap">
        SELECT *
        from financial_loss_indirect
        where year = #{year}

    </select>

</mapper>

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\AnalyzeData.xml ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\Device.xml ---

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skypapaya.firerescuemanagesystem.DAO.DeviceDAO">

    <resultMap id="deviceResultMap" type="com.skypapaya.firerescuemanagesystem.DO.DeviceDO">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="location" property="location"/>
        <result column="status" property="status"/>
        <result column="gmt_created" property="gmtCreated"/>
        <result column="gmt_modified" property="gmtModified"/>
    </resultMap>

    <select id="findAllDevices" resultMap="deviceResultMap">
        SELECT * FROM device ORDER BY gmt_created DESC
    </select>

    <insert id="insertDevice" parameterType="com.skypapaya.firerescuemanagesystem.DO.DeviceDO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO device (name, location, status, gmt_created, gmt_modified)
        VALUES (#{name}, #{location}, #{status}, now(), now())
    </insert>

    <delete id="deleteDeviceById">
        DELETE FROM device WHERE id = #{id}
    </delete>

</mapper>

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\Device.xml ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\Environment.xml ---

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skypapaya.firerescuemanagesystem.DAO.EnvironmentDAO">

    <resultMap id="environmentResultMap" type="com.skypapaya.firerescuemanagesystem.DO.EnvironmentDO">
        <id column="id" property="id"/>
        <result column="co" property="co"/>
        <result column="fire" property="fire"/>
        <result column="humidity" property="humidity"/>
        <result column="risk" property="risk"/>
        <result column="smoke" property="smoke"/>
        <result column="temperature" property="temperature"/>
        <result column="gmt_created" property="createTime"/>
        <result column="gmt_modified" property="modifyTime"/>
    </resultMap>

    <select id="getTheLatest" resultMap="environmentResultMap">
        SELECT *
        from environment
            ORDER BY gmt_created DESC
                LIMIT 1,1
    </select>
    <insert id="insertEnvironmentDO" parameterType="com.skypapaya.firerescuemanagesystem.DO.EnvironmentDO">
        INSERT INTO environment (co, fire, humidity, risk, smoke, temperature, gmt_created, gmt_modified)
        VALUES (#{co}, #{fire}, #{humidity}, #{risk}, #{smoke}, #{temperature}, now(), now())
    </insert>

</mapper>

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\Environment.xml ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\Message.xml ---

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skypapaya.firerescuemanagesystem.DAO.MessageDAO">

    <resultMap id="messageResultMap" type="com.skypapaya.firerescuemanagesystem.DO.MessageDO">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="message_time" property="messageTime"/>
        <result column="status" property="status"/>
        <result column="gmt_created" property="gmtCreated"/>
        <result column="gmt_modified" property="gmtModified"/>
    </resultMap>

    <select id="findAll" resultMap="messageResultMap">
        SELECT * FROM message ORDER BY message_time DESC
    </select>

    <insert id="insertMessage" parameterType="com.skypapaya.firerescuemanagesystem.DO.MessageDO">
        INSERT INTO message (title, message_time, status, gmt_created, gmt_modified)
        VALUES (#{title}, #{messageTime}, 0, now(), now())
    </insert>

    <update id="updateStatusById">
        UPDATE message
        SET status = #{status}, gmt_modified = now()
        WHERE id = #{id}
    </update>

    <update id="updateAllStatus">
        UPDATE message
        SET status = #{toStatus}, gmt_modified = now()
        WHERE status = #{fromStatus}
    </update>

    <delete id="deleteByStatus">
        DELETE FROM message WHERE status = #{status}
    </delete>

</mapper>

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\Message.xml ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\Todo.xml ---

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skypapaya.firerescuemanagesystem.DAO.TodoDAO">

    <resultMap id="todoResultMap" type="com.skypapaya.firerescuemanagesystem.DO.TodoDO">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="status" property="status"/>
        <result column="gmt_created" property="gmtCreated"/>
        <result column="gmt_modified" property="gmtModified"/>
    </resultMap>

    <select id="findAll" resultMap="todoResultMap">
        SELECT * FROM todo ORDER BY gmt_created DESC
    </select>

    <insert id="insertTodo" parameterType="com.skypapaya.firerescuemanagesystem.DO.TodoDO"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO todo (title, status, gmt_created, gmt_modified)
        VALUES (#{title}, #{status}, now(), now())
    </insert>

    <update id="updateTodoStatus" parameterType="com.skypapaya.firerescuemanagesystem.DO.TodoDO">
        UPDATE todo
        SET status = #{status}, gmt_modified = now()
        WHERE id = #{id}
    </update>

    <delete id="deleteTodo">
        DELETE FROM todo WHERE id = #{id}
    </delete>

    <update id="updateAllStatus">
        UPDATE todo
        SET status = #{status}, gmt_modified = now()
        WHERE status != #{status}
    </update>

    <delete id="deleteAll">
        TRUNCATE TABLE todo
    </delete>

</mapper>

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\Todo.xml ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\User.xml ---

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skypapaya.firerescuemanagesystem.DAO.UserDAO">
    <resultMap id="userResultMap" type="com.skypapaya.firerescuemanagesystem.DO.UserDO">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="age" property="age" jdbcType="INTEGER"/>
        <result column="e_mail" property="e_mail" jdbcType="VARCHAR"/>
        <result column="phone" property="phone" jdbcType="VARCHAR"/>
        <result column="address" property="address" jdbcType="VARCHAR"/>
        <result column="sex" property="sex" jdbcType="VARCHAR"/>
        <result column="authority" property="authority" jdbcType="VARCHAR"/>
        <result column="password" property="password" jdbcType="VARCHAR"/>
        <result column="gmt_created" property="gmtCreated"/>
        <result column="gmt_modified" property="gmtModified"/>
    </resultMap>

    <insert id="insertUser" parameterType="com.skypapaya.firerescuemanagesystem.DO.UserDO" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO user (name, age, e_mail, phone, address, sex, authority, gmt_created, gmt_modified)
        VALUES (#{name}, #{age}, #{e_mail}, #{phone}, #{address}, #{sex}, #{authority}, now(), now())
    </insert>

    <update id="updateUser" parameterType="com.skypapaya.firerescuemanagesystem.DO.UserDO">
        UPDATE user
        SET name         = #{name},
            age          = #{age},
            e_mail       = #{e_mail},
            phone        = #{phone},
            address      = #{address},
            sex          = #{sex},
            authority    = #{authority},
            gmt_modified = now()
        WHERE id = #{id}
    </update>

    <insert id="registerUser" parameterType="com.skypapaya.firerescuemanagesystem.DO.UserDO" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO user (name, password, authority,
                          age, e_mail, phone, sex, address,
                          gmt_created, gmt_modified)
        VALUES (#{name}, #{password}, 'user',
                #{age}, #{e_mail}, #{phone}, #{sex}, #{address},
                now(), now())
    </insert>

    <select id="findByName" resultMap="userResultMap">
        SELECT *
        FROM user
        WHERE name = #{name} LIMIT 1
    </select>

    <select id="findByEMail" resultMap="userResultMap">
        SELECT *
        FROM user
        WHERE e_mail = #{eMail} LIMIT 1
    </select>

    <select id="findByPhone" resultMap="userResultMap">
        SELECT *
        FROM user
        WHERE phone = #{phone} LIMIT 1
    </select>

    <select id="findAll" parameterType="int" resultMap="userResultMap">
        SELECT *
        FROM user
    </select>

    <delete id="delete">
        delete
        from user
        where id = #{id}
    </delete>

    <select id="page" resultMap="userResultMap">
        SELECT * FROM user LIMIT #{page}, #{size}
    </select>
</mapper>


--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\User.xml ---

--- START OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\VitalSigns.xml ---

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.skypapaya.firerescuemanagesystem.DAO.VitalSignsDAO">
    <resultMap id="VitalSignsResultMap" type="com.skypapaya.firerescuemanagesystem.DO.VitalSignsDO">
        <id column="id" property="id"/>
        <result column="breath_rate" property="breathRate"/>
        <result column="heart_rate" property="heartRate"/>
        <result column="signal_strength" property="signalStrength"/>
        <result column="active" property="active"/>
        <result column="distance" property="distance"/>
        <result column="exist" property="exist"/>
        <result column="life" property="life"/>
        <result column="people" property="people"/>
        <result column="gmt_created" property="createTime"/>
        <result column="gmt_modified" property="modifyTime"/>
    </resultMap>
    <select id="getTheLastedVitalSigns" resultMap="VitalSignsResultMap">
        SELECT *
        FROM vital_signs
        ORDER BY gmt_created DESC
         LIMIT 1
    </select>
    <insert id="insertVitalSignsDO" parameterType="com.skypapaya.firerescuemanagesystem.DO.VitalSignsDO" keyProperty="id">
        INSERT INTO vital_signs (breath_rate, heart_rate, signal_strength, active, distance, exist, life, people,gmt_created,gmt_modified)
        VALUES (#{breathRate}, #{heartRate}, #{signalStrength}, #{active}, #{distance}, #{exist}, #{life}, #{people},now(), now())
    </insert>

</mapper>

--- END OF FILE: J:/FireRescue\FIreRescueManageSystem\FireRescueManageSystem\src\main\resources\com\skypapaya\firerescuemanagesystem\VitalSigns.xml ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\auto-imports.d.ts ---

// Generated by 'unplugin-auto-import'
export {}
declare global {

}


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\auto-imports.d.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\components.d.ts ---

// generated by unplugin-vue-components
// We suggest you to commit this file into source control
// Read more: https://github.com/vuejs/core/pull/3399
import '@vue/runtime-core'

export {}

declare module '@vue/runtime-core' {
  export interface GlobalComponents {
    ElAvatar: typeof import('element-plus/es')['ElAvatar']
    ElButton: typeof import('element-plus/es')['ElButton']
    ElCard: typeof import('element-plus/es')['ElCard']
    ElCheckbox: typeof import('element-plus/es')['ElCheckbox']
    ElCol: typeof import('element-plus/es')['ElCol']
    ElDatePicker: typeof import('element-plus/es')['ElDatePicker']
    ElDescriptions: typeof import('element-plus/es')['ElDescriptions']
    ElDescriptionsItem: typeof import('element-plus/es')['ElDescriptionsItem']
    ElDialog: typeof import('element-plus/es')['ElDialog']
    ElDropdown: typeof import('element-plus/es')['ElDropdown']
    ElDropdownItem: typeof import('element-plus/es')['ElDropdownItem']
    ElDropdownMenu: typeof import('element-plus/es')['ElDropdownMenu']
    ElForm: typeof import('element-plus/es')['ElForm']
    ElFormItem: typeof import('element-plus/es')['ElFormItem']
    ElIcon: typeof import('element-plus/es')['ElIcon']
    ElImage: typeof import('element-plus/es')['ElImage']
    ElInput: typeof import('element-plus/es')['ElInput']
    ElLink: typeof import('element-plus/es')['ElLink']
    ElMenu: typeof import('element-plus/es')['ElMenu']
    ElMenuItem: typeof import('element-plus/es')['ElMenuItem']
    ElOption: typeof import('element-plus/es')['ElOption']
    ElPagination: typeof import('element-plus/es')['ElPagination']
    ElProgress: typeof import('element-plus/es')['ElProgress']
    ElRow: typeof import('element-plus/es')['ElRow']
    ElSelect: typeof import('element-plus/es')['ElSelect']
    ElSubMenu: typeof import('element-plus/es')['ElSubMenu']
    ElTable: typeof import('element-plus/es')['ElTable']
    ElTableColumn: typeof import('element-plus/es')['ElTableColumn']
    ElTabPane: typeof import('element-plus/es')['ElTabPane']
    ElTabs: typeof import('element-plus/es')['ElTabs']
    ElText: typeof import('element-plus/es')['ElText']
    ElTooltip: typeof import('element-plus/es')['ElTooltip']
    Header: typeof import('./src/components/header.vue')['default']
    RouterLink: typeof import('vue-router')['RouterLink']
    RouterView: typeof import('vue-router')['RouterView']
    Sidebar: typeof import('./src/components/sidebar.vue')['default']
    TableDetail: typeof import('./src/components/table-detail.vue')['default']
    TableEdit: typeof import('./src/components/table-edit.vue')['default']
    Tags: typeof import('./src/components/tags.vue')['default']
  }
}


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\components.d.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\index.html ---

<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>vue-manage-system后台管理系统</title>
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_830376_qzecyukz0s.css">
</head>

<body>
  <noscript>
    <strong>We're sorry but <%= htmlWebpackPlugin.options.title %> doesn't work properly without JavaScript enabled.
      Please enable it to continue.</strong>
  </noscript>
  <div id="app"></div>
  <script type="module" src="/src/main.ts"></script>
  <!-- built files will be auto injected -->
</body>

</html>

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\index.html ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\vite.config.ts ---

import { defineConfig } from 'vite';
import vue from '@vitejs/plugin-vue';
import VueSetupExtend from 'vite-plugin-vue-setup-extend';
import AutoImport from 'unplugin-auto-import/vite';
import Components from 'unplugin-vue-components/vite';
import { ElementPlusResolver } from 'unplugin-vue-components/resolvers';



export default defineConfig({
	build: {
		chunkSizeWarningLimit: 16000
	},

	base: './',
	plugins: [
		vue(),
		VueSetupExtend(),
		AutoImport({
			resolvers: [ElementPlusResolver()]
		}),
		Components({
			resolvers: [ElementPlusResolver()]
		})
	],
	optimizeDeps: {
		include: ['schart.js']
	},
	//跨域代理
	server:{
		//端口号
		port: 5173,
		proxy: {
			// 代理所有以 /api 开头的请求
			'/api': {
				target: 'http://localhost:8080', // 你的后端 API 地址
				changeOrigin: true,
				rewrite: (path) => path.replace(/^\/api/, ''), // 可选：移除 /api 前缀
			},
		},
	},


});


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\vite.config.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\.github\FUNDING.yml ---

# These are supported funding model platforms

github: # Replace with up to 4 GitHub Sponsors-enabled usernames e.g., [user1, user2]
patreon: # Replace with a single Patreon username
open_collective: # Replace with a single Open Collective username
ko_fi: # Replace with a single Ko-fi username
tidelift: # Replace with a single Tidelift platform-name/package-name e.g., npm/babel
community_bridge: # Replace with a single Community Bridge project-name e.g., cloud-foundry
liberapay: # Replace with a single Liberapay username
issuehunt: # Replace with a single IssueHunt username
otechie: # Replace with a single Otechie username
custom: https://lin-xin.gitee.io/images/weixin.jpg


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\.github\FUNDING.yml ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\App.vue ---

<template>
	<el-config-provider :locale="zhCn">
		<router-view />
	</el-config-provider>
</template>

<script setup lang="ts">
import { ElConfigProvider } from 'element-plus';
import zhCn from 'element-plus/es/locale/lang/zh-cn';
import * as echarts from 'echarts';
</script>
<style>
@import './assets/css/main.css';
@import './assets/css/color-dark.scss';
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\App.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\main.ts ---

import { createApp } from 'vue';
import { createPinia } from 'pinia';
import * as ElementPlusIconsVue from '@element-plus/icons-vue';
import App from './App.vue';
import router from './router';
import 'element-plus/dist/index.css';
import './assets/css/icon.css';

const app = createApp(App);
app.use(createPinia());
app.use(router);

// 注册elementplus图标
for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
    app.component(key, component);
}
app.mount('#app');


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\main.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\vite-env.d.ts ---

/// <reference types="vite/client" />

declare module '*.vue' {
  import type { DefineComponent } from 'vue'
  const component: DefineComponent<{}, {}, any>
  export default component
}

declare module 'vue-schart';
declare module 'vue-cropperjs';

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\vite-env.d.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\api\index.ts ---

import request from '../utils/request';

export const fetchData = () => {
    return request({
        url: 'https://www.fastmock.site/mock/dc695d037038802def4b989ba4650c3f/vms/getUser',
        method: 'post'
    });
};


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\api\index.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\assets\css\color-dark.scss ---

.header{
    background-color: #242f42;
}
.login-wrap{
    background: #324157;
}
.plugins-tips{
    background: #eef1f6;
}
.plugins-tips a{
    color: var(--el-color-primary);
}

.tags-li.active {
    border: 1px solid var(--el-color-primary);
    background-color: var(--el-color-primary);
}
.message-title{
    color: var(--el-color-primary);
}
.collapse-btn:hover{
    background: rgb(40,52,70);
}

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\assets\css\color-dark.scss ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\assets\css\icon.css ---

[class*=" el-icon-lx"],
[class^=el-icon-lx] {
    font-family: lx-iconfont !important;
}

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\assets\css\icon.css ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\assets\css\main.css ---

* {
    margin: 0;
    padding: 0;
}

html,
body,
#app,
.wrapper {
    width: 100%;
    height: 100%;
    overflow: hidden;
}

body {
    font-family: 'PingFang SC', "Helvetica Neue", Helvetica, "microsoft yahei", arial, STHeiTi, sans-serif;
}

a {
    text-decoration: none
}


.content-box {
    position: absolute;
    left: 250px;
    right: 0;
    top: 70px;
    bottom: 0;
    padding-bottom: 30px;
    -webkit-transition: left .3s ease-in-out;
    transition: left .3s ease-in-out;
    background: #f0f0f0;
}

.content {
    width: auto;
    height: 100%;
    padding: 10px;
    overflow-y: scroll;
    box-sizing: border-box;
}

.content-collapse {
    left: 65px;
}

.container {
    padding: 30px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.crumbs {
    margin: 10px 0;
}

.el-table th {
    background-color: #f5f7fa !important;
}

.pagination {
    margin: 20px 0;
    text-align: right;
}

.plugins-tips {
    padding: 20px 10px;
    margin-bottom: 20px;
}

.el-button+.el-tooltip {
    margin-left: 10px;
}

.mgb20 {
    margin-bottom: 20px;
}

.move-enter-active,
.move-leave-active {
    transition: opacity .1s ease;
}

.move-enter-from,
.move-leave-to {
    opacity: 0;
}

/*BaseForm*/

.form-box {
    width: 600px;
}

.form-box .line {
    text-align: center;
}

.el-time-panel__content::after,
.el-time-panel__content::before {
    margin-top: -7px;
}

.el-time-spinner__wrapper .el-scrollbar__wrap:not(.el-scrollbar__wrap--hidden-default) {
    padding-bottom: 0;
}


[class*=" el-icon-"], [class^=el-icon-] {
    font-style: normal;
    font-weight: 400;
    font-variant: normal;
    text-transform: none;
    line-height: 1;
    vertical-align: baseline;
    display: inline-block;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}
.el-sub-menu [class^=el-icon-] {
    vertical-align: middle;
    margin-right: 5px;
    width: 24px;
    text-align: center;
    font-size: 18px;
}

[hidden]{
    display: none !important;
}

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\assets\css\main.css ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\areaCharts.vue ---

<template>
  <div class="area-chart" ref="chart"></div>
</template>

<script setup lang="ts">
import {ref, onMounted} from 'vue';
import * as echarts from 'echarts';
import {LinearGradient} from "echarts/types/dist/shared";

type EChartsOption = echarts.EChartsOption;

let option: {
  yAxis: { type: string; boundaryGap: [number, string] };
  xAxis: { data: any[]; type: string; boundaryGap: boolean };
  series: {
    symbol: string;
    areaStyle: { color: LinearGradient };
    data: number[];
    sampling: string;
    name: string;
    itemStyle: { color: string };
    type: string
  }[];
  tooltip: { trigger: string; position: (pt) => [number, string] };
  toolbox: { feature: { saveAsImage: {}; restore: {}; dataZoom: { yAxisIndex: string } } };
  dataZoom: ({ start: number; end: number; type: string } | { start: number; end: number })[];
  title: { left: string; text: string }
};

let base = +new Date();
let oneDay = 24 * 3600 * 1000;
let date = [];
let data = [Math.random() * 300];
var now = new Date((base -= oneDay));
const money = [114,450,124,187,845,126,665,425,788,115,351,251,452,321,612,351,327,368,218]
for (let i = 1; i < 20; i++) {
  now = new Date(base -= oneDay);

  date.push([now.getFullYear(), now.getMonth() + 1, now.getDate()].join('/'));
  data.push (money[i]);
}

// 反转日期和数据数组
date.reverse();
data.reverse();

const chart = ref<HTMLDivElement | null>(null);

// myChart和其他函数要放在onMounted里面，否则会报错
onMounted(() => {
  const myChart = echarts.init(chart.value!);

  window.addEventListener('resize', () => {
    myChart.resize();
  })

  option = {
    tooltip: {
      trigger: 'axis',
      position: function (pt) {
        return [pt[0], '10%'];
      }
    },
    title: {
      left: 'center',
      text: '火灾造成的经济损失'
    },
    toolbox: {
      feature: {
        dataZoom: {
          yAxisIndex: 'none'
        },
        restore: {},
        saveAsImage: {}
      }
    },
    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: date
    },
    yAxis: {
      type: 'value',
      boundaryGap: [0, '100%']
    },
    dataZoom: [
      {
        type: 'inside',
        start: 0,
        end: 10
      },
      {
        start: 0,
        end: 10
      }
    ],
    series: [
      {
        name: 'Fake Data',
        type: 'line',
        symbol: 'none',
        sampling: 'lttb',
        itemStyle: {
          color: 'rgb(255, 70, 131)'
        },
        areaStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
            {
              offset: 0,
              color: 'rgb(255, 158, 68)'
            },
            {
              offset: 1,
              color: 'rgb(255, 70, 131)'
            }
          ])
        },
        data: data
      }
    ]
  };

  myChart.setOption(option);
});
</script>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\areaCharts.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\breathRateChart.vue ---

<template>
  <div class="area-chart" ref="chart"></div>
</template>

<script setup lang="ts">
import * as echarts from 'echarts';
import {ref, onMounted} from 'vue';
import service from "../utils/request";

const chart = ref<HTMLDivElement | null>(null);
let now = new Date();
let data: any[] = [];
let xAxisData: string[] = [];
let option: {
  yAxis: { min: number; max: number; splitLine: { show: boolean }; type: string; boundaryGap: [number, string] };
  xAxis: { data: string[]; splitLine: { show: boolean }; type: string };
  series: { showSymbol: boolean; data: any[]; lineStyle: { color: string }; name: string; type: string }[];
  tooltip: { formatter: (params) => string; axisPointer: { animation: boolean }; trigger: string };
  title: { text: string }
};
let breathRate;

// 生成带有轻微波动的数据
function generateFluctuatedData(originalData: number[]): number[] {
  return originalData.map((value) => value + Math.random() * 10 - 5);
}

// 获取呼吸频率
function getBreathRate() {
  now = new Date(now.getTime() + 1000);
  return {
    // 以时分秒作为横坐标
    name: now.toLocaleTimeString(),
    value: [
      now.toLocaleTimeString(),
      Math.round(breathRate)
    ]
  };
}

// 初始化图表数据
for (var i = 0; i < 100; i++) {
  const newData = getBreathRate();
  data.push(newData.value[1]);
  xAxisData.push(newData.name);
}

// 加载数据
const load = () => {
  service.get('/vital/getTheLatest').then((res) => {
    breathRate = res.data.breathRate;
  });
}

onMounted(() => {
  const myChart = echarts.init(chart.value!);
  window.addEventListener('resize', () => {
    myChart.resize();
  });

  setInterval(() => {
    load();

    // 更新额外线的数据
    const newData = getBreathRate();
    data.shift();
    xAxisData.shift();
    data.push(newData.value[1]);
    xAxisData.push(newData.name);

    // 更新额外线的数据
    const fluctuatedData2 = generateFluctuatedData(data);
    const fluctuatedData3 = generateFluctuatedData(data);
    const fluctuatedData4 = generateFluctuatedData(data);
    const fluctuatedData5 = generateFluctuatedData(data);

    myChart.setOption({
      xAxis: {
        data: xAxisData
      },
      series: [
        {data: data},
        {data: fluctuatedData2},
        {data: fluctuatedData3},
        {data: fluctuatedData4},
        {data: fluctuatedData5}
      ]
    });

    // 更新标记点的位置
    myChart.setOption({
      graphic: [{
        type: 'text',
        left: 'center',
        top: 10,
        style: {
          text: `实时呼吸频率: ${newData.value[1]}`,
          textAlign: 'center',
          fill: '#4afafa',
          fontSize: 24
        }
      }]
    });
  }, 1000); // 每1秒刷新一次

  myChart.setOption(option);
});

option = {
  title: {
    text: '呼吸频率',
  },
  tooltip: {
    trigger: 'axis',
    formatter: function (params) {
      params = params[0];
      var date = new Date(params.name);
      return (
          date.getHours() +
          ':' +
          (date.getMinutes()) +
          ':' +
          date.getSeconds() +
          ' ' +
          params.value[1]
      );
    },
    axisPointer: {
      animation: false
    }
  },
  xAxis: {
    type: 'category',
    splitLine: {
      show: true
    },
    data: xAxisData
  },
  yAxis: {
    type: 'value',
    boundaryGap: [0, '100%'],
    splitLine: {
      show: false
    },
    min: 0,
    max: 200
  },
  series: [
    {
      name: 'Breath Rate',
      type: 'line',
      showSymbol: false,
      data: data,
      lineStyle: {
        color: '#ffa02c'
      }
    },
    // {
    //   name: '线 2',
    //   type: 'line',
    //   showSymbol: true, // 显示数据点
    //   symbol: 'circle', // 数据点样式
    //   symbolSize: 6, // 数据点大小
    //   data.txt: [], // 数据在组件挂载后更新
    //   lineStyle: {
    //     color: '#ffa02c'
    //   }
    // },
    // {
    //   name: '线 3',
    //   type: 'line',
    //   showSymbol: true, // 显示数据点
    //   symbol: 'circle', // 数据点样式
    //   symbolSize: 6, // 数据点大小
    //   data.txt: [], // 数据在组件挂载后更新
    //   lineStyle: {
    //     color: '#4afafa'
    //   }
    // },
    // {
    //   name: '线 4',
    //   type: 'line',
    //   showSymbol: true, // 显示数据点
    //   symbol: 'circle', // 数据点样式
    //   symbolSize: 6, // 数据点大小
    //   data.txt: [], // 数据在组件挂载后更新
    //   lineStyle: {
    //     color: '#ff5f72'
    //   }
    // },
    // {
    //   name: '线 5',
    //   type: 'line',
    //   showSymbol: true, // 显示数据点
    //   symbol: 'circle', // 数据点样式
    //   symbolSize: 6, // 数据点大小
    //   data.txt: [], // 数据在组件挂载后更新
    //   lineStyle: {
    //     color: '#8663e1'
    //   }
    // }
  ]
};
</script>

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\breathRateChart.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\device.vue ---

<template>
  <div ref="chart"></div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import * as echarts from 'echarts';
import service from "../utils/request";
import {ElNotification} from "element-plus";

const chart = ref<HTMLDivElement | null>(null);
type EChartsOption = echarts.EChartsOption;
let option: {
  yAxis: { min: number; max: number };
  xAxis: { axisLabel: { rotate: number; interval: number }; type: string };
  series: {
    encode: { x: string; y: string };
    datasetIndex: number;
    itemStyle: { color: (params: any) => (string) };
    type: string
  };
  tooltip: { formatter: (params) => string; axisPointer: { type: string }; trigger: string };
  title: { text: string };
  dataset: ({ source: (string | number)[][]; dimensions: string[] } | {
    transform: { type: string; config: { dimension: string; order: string } }
  })[]
} = {
  title: {
    text: '设备数据'
  },
  dataset: [
    {
      dimensions: ['name', 'value'],
      source: [
        ['湿度', 55],
        ['温度', 34.2],
        ['火情', 0],
        ['CO浓度', 0.2],
        ['烟雾浓度', 0.3],
      ]
    },
    {
      // 根据第二个数据进行排序
      transform: {
        type: 'sort',
        config: {dimension: 'value', order: 'desc'}
      }
    }
  ],
  xAxis: {
    type: 'category',
    axisLabel: {interval: 0, rotate: 30}
  },
  yAxis: {
    min: 0,
    max: 100
  },
  // 编码修改为正确的名称
  series: {
    type: 'bar',
    encode: {x: 'name', y: 'value'},
    datasetIndex: 1,
    itemStyle: {
      color: function (params: any) {
        const name = params.data[0]; // 获取名称
        const value = params.data[1]; // 获取 y 值
        if (name === '湿度') {
          return 'blue'; // 湿度柱状图颜色保持蓝色
        } else if (name === '温度' && value > 70) {
          return 'red';
        } else if (value > 45) {
          return 'red';
        } else if (value > 30) {
          return 'yellow';
        } else {
          return 'blue';
        }
        if(name === 'co' && value > 20) {
          return 'red';
        }
        if(name === 'smoke' && value > 30) {
          return 'red';
        }
      }
    }
  },

  tooltip: {
    trigger: 'axis',
    axisPointer: {type: 'shadow'},
    formatter: function (params) {
      const data = params[0].data;
      return `${data[0]}：<br/>${data[1]}`;
    }
  }
};
let humidity = 1;
let temperature;
let fire;
let co;
let smoke;
//获取数据
const load = () => {
  service.get('environment/getTheLatest').then((res) => {
   //console.log(res.data[0].co);
    humidity = res.data[0].humidity;
    temperature = res.data[0].temperature;
    fire = res.data[0].fire * 100;
    co = res.data[0].co;
    smoke = res.data[0].smoke;
    // 替换数据

    option.dataset[0].source = [
      ['湿度', humidity],
      ['温度', temperature],
      ['火情', fire],
      ['有害气体浓度', co],
      ['烟雾浓度', smoke],
    ];


  });
}
let type = "火灾类型是：00"
onMounted(() => {
  const myChart = echarts.init(chart.value!);
  load();
  myChart.setOption(option);

  setInterval(() => {
    load();
    // 根据第二个数据排序
    //option.dataset[0].source.sort((a: any, b: any) => b[1] - a[1]);
    // 更新图表
    myChart.setOption(option);
    //弹窗设置
    if(temperature > 50 || fire > 0.01 || co > 20 || smoke > 30) {
      ElNotification({
        title: 'Warning',
        message: '有火情',
        type: 'error',
        duration:1000
      });
    }
  }, 1000);

});
</script>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\device.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\heatRateChart.vue ---

<template>
  <div class="area-chart" ref="chart"></div>
</template>

<script setup lang="ts">
import * as echarts from 'echarts';
import {ref, onMounted} from 'vue';
import service from "../utils/request";

// 定义图表容器
const chart = ref<HTMLDivElement | null>(null);
// 初始化当前时间
let now = new Date();
// 初始化数据数组
let data: any[] = [];
// 初始化 x 轴数据数组
let xAxisData: string[] = [];
// 初始化 echarts 选项
let option: {
  yAxis: { min: number; max: number; splitLine: { show: boolean }; type: string; boundaryGap: [number, string] };
  xAxis: { data: string[]; splitLine: { show: boolean }; type: string };
  series: {
    symbol: string;
    showSymbol: boolean;
    data: any[];
    lineStyle: { color: string };
    symbolSize: number;
    name: string;
    type: string
  }[];
  tooltip: { formatter: (params) => string; axisPointer: { animation: boolean }; trigger: string };
  title: { text: string }
};

// 定义心率变量
let heartRate;
// 加载心率数据的函数
const load = () => {
  service.get('/vital/getTheLatest').then((res) => {
    heartRate = res.data.heartRate;
  });
};

// 生成随机数据的函数
function randomData() {
  now = new Date(now.getTime() + 1000);
  return {
    name: now.toLocaleTimeString(),
    value: [
      now.toLocaleTimeString(),
      Math.round(heartRate)
    ]
  };
}

// 生成带有轻微波动的数据
function generateFluctuatedData(originalData: number[]): number[] {
  return originalData.map((value) => value + Math.random() * 10 - 5);
}

// 初始化额外线的数据数组
let data2: any[] = [];
let data3: any[] = [];
let data4: any[] = [];
let data5: any[] = [];

// 初始化数据
for (var i = 0; i < 100; i++) {
  const newData = randomData();
  data.push(newData.value[1]); // 仅将心率值推送到数据数组
  xAxisData.push(newData.name);
}

// 组件挂载后的操作
onMounted(() => {
  const myChart = echarts.init(chart.value!);
  window.addEventListener('resize', () => {
    myChart.resize();
  });

  // 定时刷新数据
  setInterval(function () {
    load();
    const newData = randomData();
    data.shift();
    xAxisData.shift();
    data.push(newData.value[1]); // 仅将心率值推送到数据数组
    xAxisData.push(newData.name);

    // 更新额外线的数据
    data2 = generateFluctuatedData(data);
    data3 = generateFluctuatedData(data);
    data4 = generateFluctuatedData(data);
    data5 = generateFluctuatedData(data);

    myChart.setOption({
      series: [
        {name: '心率', data: data},
        {name: '线 2', data: data2},
        {name: '线 3', data: data3},
        {name: '线 4', data: data4},
        {name: '线 5', data: data5}
      ],
      xAxis: [{data: xAxisData}]
    });

    // 更新文本标签
    myChart.setOption({
      graphic: [{
        type: 'text',
        left: 'center',
        top: 10,
        style: {
          text: `实时心率: ${newData.value[1]}`,
          textAlign: 'center',
          fill: '#ef3b3b',
          fontSize: 24
        }
      }]
    });
  }, 1000); // 每秒刷新一次

  myChart.setOption(option);
});

// 初始化图表选项
option = {
  title: {
    text: '心率'
  },
  tooltip: {
    trigger: 'axis',
    formatter: function (params) {
      const date = new Date(params[0].name);
      let tooltip = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds() + '<br/>';
      params.forEach(function (item) {
        tooltip += item.seriesName + ': ' + item.value[1] + '<br/>';
      });
      return tooltip;
    },
    axisPointer: {
      animation: false
    }
  },
  xAxis: {
    type: 'category',
    splitLine: {
      show: true
    },
    data: xAxisData
  },
  yAxis: {
    type: 'value',
    boundaryGap: [0, '100%'],
    splitLine: {
      show: false
    },
    min: 0,
    max: 200
  },
  series: [
    {
      name: '心率',
      type: 'line',
      showSymbol: true, // 显示数据点
      symbol: 'circle', // 数据点样式
      symbolSize: 6, // 数据点大小
      data: data,
      lineStyle: {
        color: '#ef3b3b'
      }

      // {
      //   name: '线 2',
      //   type: 'line',
      //   showSymbol: true, // 显示数据点
      //   symbol: 'circle', // 数据点样式
      //   symbolSize: 6, // 数据点大小
      //   data.txt: data2,
      //   lineStyle: {
      //     color: '#ffa02c'
      //   }
      // },
      // {
      //   name: '线 3',
      //   type: 'line',
      //   showSymbol: true, // 显示数据点
      //   symbol: 'circle', // 数据点样式
      //   symbolSize: 6, // 数据点大小
      //   data.txt: data3,
      //   lineStyle: {
      //     color: '#4afafa'
      //   }

      // {
      //   name: '线 4',
      //   type: 'line',
      //   showSymbol: true, // 显示数据点
      //   symbol: 'circle', // 数据点样式
      //   symbolSize: 6, // 数据点大小
      //   data.txt: data4,
      //   lineStyle: {
      //     color: '#ff5f72'
      //   }
      // },
      // {
      //   name: '线 5',
      //   type: 'line',
      //   showSymbol: true, // 显示数据点
      //   symbol: 'circle', // 数据点样式
      //   symbolSize: 6, // 数据点大小
      //   data.txt: data5,
      //   lineStyle: {
      //     color: '#8663e1'
      //   }
    }
  ]
};
</script>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\heatRateChart.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\riskChart.vue ---

<template>
  <div class="area-chart" ref="chart"></div>
</template>

<script setup lang="ts">
import * as echarts from 'echarts';
import { ref, onMounted } from 'vue';
import { ElNotification } from "element-plus";
import service from "../utils/request";

const chart = ref<HTMLDivElement | null>(null);
let now = new Date();
let data: any[] = [];
let xAxisData: string[] = [];
let option: {
  yAxis: { min: number; max: number; splitLine: { show: boolean }; type: string; boundaryGap: [number, string] };
  xAxis: { data: string[]; splitLine: { show: boolean }; type: string };
  series: { showSymbol: boolean; data: any[]; name: string; type: string }[];
  tooltip: { formatter: (params) => string; axisPointer: { animation: boolean }; trigger: string };
  title: { text: string }
};
let risk = 1;

const load = () => {
  service.get('environment/getTheLatest').then((res) => {
    risk = res.data.risk;
  });
};

function randomData() {
  now = new Date(now.getTime() + 1000);
  return {
    name: now.toLocaleTimeString(),
    value: [now.toLocaleTimeString(), risk]
  };
}

for (var i = 0; i < 100; i++) {
  const newData = randomData();
  data.push(newData.value);
  xAxisData.push(newData.name);
}

onMounted(() => {
  const myChart = echarts.init(chart.value!);
  window.addEventListener('resize', () => {
    myChart.resize();
  });

  setInterval(function () {
    load(); // 更新risk数据
    checkFire(); // 检查火灾风险
    let newData = randomData();
    data.shift();
    xAxisData.shift();
    data.push(newData.value);
    xAxisData.push(newData.name);
    myChart.setOption({
      series: [
        {
          data: data
        }
      ],
      xAxis: [
        {
          data: xAxisData
        }
      ]
    });
  }, 1000);

  myChart.setOption(option);
});

const checkFire = () => {
  if (risk === 1) {
    ElNotification({
      title: 'Warning ',
      message: '有火灾风险',
      type: 'error',
      duration: 10000,
    });
  }
};

option = {
  title: {
    text: '发生火灾的风险'
  },
  tooltip: {
    trigger: 'axis',
    formatter: function (params) {
      params = params[0];
      var date = new Date(params.name);
      return (
          date.getHours() +
          ':' +
          (date.getMinutes()) +
          ':' +
          date.getSeconds() +
          ' ' +
          params.value[1]
      );
    },
    axisPointer: {
      animation: false
    }
  },
  xAxis: {
    type: 'category',
    splitLine: {
      show: true
    },
    data: xAxisData // 不再需要格式化为日期格式
  },
  yAxis: {
    type: 'value',
    boundaryGap: [0, '100%'],
    splitLine: {
      show: false
    },
    min: 0,
    max: 1
  },
  series: [
    {
      name: 'Fake Data',
      type: 'line',
      showSymbol: false,
      data: data
    }
  ]
};
</script>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\riskChart.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\signalChart.vue ---

<template>
  <div ref="chart" id="chart"></div>
</template>

<script setup lang="ts">
import {ref, onMounted} from 'vue';
import * as echarts from 'echarts';
import service from "../utils/request";

type EChartsOption = echarts.EChartsOption;
let option: {
  series: {
    data: { name: string; value: string }[];
    name: string;
    progress: { show: boolean };
    detail: { formatter: string; textStyle: { fontSize: number } };
    type: string
  }[];
  tooltip: { formatter: string };
  title: { left: string; text: string; textStyle: { color: string; fontSize: number } }
};
const chart = ref<HTMLDivElement | null>(null);

let signalStrength;

const load = () => {
  service.get('/vital/getTheLatest').then((res) => {
    signalStrength = res.data.signalStrength
    console.log("--------" + signalStrength)
  })

}
onMounted(() => {
  load()
  const myChart = echarts.init(chart.value!);
  // 定义初始数据
  let value = 50;
  // 设置定时器，每隔一段时间更新数据
  setInterval(() => {
    // 生成一个介于-2到2之间的随机数
    const randomDelta = (Math.random() - 0.6) * 4;
    // 计算新的值
    value += randomDelta;
    // 限制数据在30到80之间
    value = Math.max(30, Math.min(80, value));
    // 更新图表数据
    myChart.setOption({
      series: [{
        data: [signalStrength + 100]
      }]
    });
  }, 1000); // 间隔为2秒

  option = {
    title: {
      text: '信号强度',
      left: 'center',

      textStyle: {
        color: '#00c4ff',
        fontSize: 20
      }
    },


    tooltip: {
      formatter: ' <br/>{b}{c}db'
    },

    series: [{
      name: 'sign',
      type: 'gauge',
      progress: {
        show: true
      },
      detail: {
        formatter: '{value}',
        textStyle: {
          fontSize: 14
        }
      },
      data: [{
        value: value.toFixed(1),
        name: 'SCORE'
      }]
    }]
  };

  option && myChart.setOption(option);
});
</script>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\signalChart.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\typeChart.vue ---

<template>
  <div ref="chart"></div>
</template>
<script setup lang="ts">
import { ref, onMounted, onBeforeUnmount } from 'vue';
import * as echarts from 'echarts';

var chartDom = document.getElementById('chart');

var option;
const chart = ref<HTMLDivElement | null>(null);

// 生成随机数据的函数
function generateRandomData() {
  // 定义时间范围
  const timeRange = Array.from({ length: 13 }, (_, i) => i < 10 ? '0' + i : '' + i);
  // 定义产品名称
  const products = ['电器', '粉尘', '电瓶', '厨房'];
  // 生成随机数据
  const sourceData = [timeRange];
  products.forEach(product => {
    const productData = [product];
    for (let i = 0; i < 12; i++) {
      const randomNumber = Math.random() * 100;
      productData.push(randomNumber.toFixed(1)); // 保留一位小数
    }
    sourceData.push(productData);
  });
  return sourceData;
}

onMounted(() => {
  const myChart = echarts.init(chart.value!);

  function refreshData() {
    option.dataset.source = generateRandomData(); // 刷新数据
    myChart.setOption(option);
  }

  // 每60秒钟刷新一次数据
  const interval = setInterval(refreshData, 60000);
  option = {
    title: { text: '火灾类型统计' },
    legend: {},
    tooltip: {
      trigger: 'axis',
      showContent: false
    },
    dataset: {
      source: generateRandomData() // 使用随机数据
    },
    xAxis: { type: 'category' },
    yAxis: { gridIndex: 0 },
    grid: { top: '55%' },
    series: [
      {
        type: 'line',
        smooth: true,
        seriesLayoutBy: 'row',
        emphasis: { focus: 'series' }
      },
      {
        type: 'line',
        smooth: true,
        seriesLayoutBy: 'row',
        emphasis: { focus: 'series' }
      },
      {
        type: 'line',
        smooth: true,
        seriesLayoutBy: 'row',
        emphasis: { focus: 'series' }
      },
      {
        type: 'line',
        smooth: true,
        seriesLayoutBy: 'row',
        emphasis: { focus: 'series' }
      },
      {
        type: 'pie',
        id: 'pie',
        radius: '30%',
        center: ['50%', '25%'],
        emphasis: {
          focus: 'self'
        },
        label: {
          formatter: '{b}: {@2012} ({d}%)'
        },
        encode: {
          itemName: 'product',
          value: '2012',
          tooltip: '2012'
        }
      }
    ]
  };
  /*
  myChart.on('updateAxisPointer', function (event) {
    const xAxisInfo = event.axesInfo[0];
    if (xAxisInfo) {
      const dimension = xAxisInfo.value + 1;
      myChart.setOption({
        series: {
          id: 'pie',
          label: {
            formatter: '{b}: {@[' + dimension + ']} ({d}%)'
          },
          encode: {
            value: dimension,
            tooltip: dimension
          }
        }
      });
    }
  });
  */
  myChart.setOption(option);

  // 页面销毁时清除定时器
  onBeforeUnmount(() => {
    clearInterval(interval);
  });
})
</script>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\charts\typeChart.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\components\header.vue ---

<template>
  <div class="header">
    <div class="collapse-btn" @click="collapseChage">
      <el-icon v-if="sidebar.collapse"><Expand /></el-icon>
      <el-icon v-else><Fold /></el-icon>
    </div>
    <div class="logo">觅生者后台管理系统</div>
    <div class="header-right">
      <div class="header-user-con">
        <div class="btn-bell" @click="router.push('/tabs')">
          <el-tooltip
              effect="dark"
              :content="message ? `有${message}条未读消息` : `消息中心`"
              placement="bottom"
          >
            <i class="el-icon-lx-notice"></i>
          </el-tooltip>
          <span class="btn-bell-badge" v-if="message"></span>
        </div>
        <el-avatar class="user-avator" :size="30" :src="imgurl" />
        <el-dropdown class="user-name" trigger="click" @command="handleCommand">
          <span class="el-dropdown-link">
            {{ username }}
            <el-icon class="el-icon--right">
              <arrow-down />
            </el-icon>
          </span>
          <template #dropdown>
            <el-dropdown-menu>
              <el-dropdown-item command="user">个人中心</el-dropdown-item>
              <el-dropdown-item divided command="loginout"
              >退出登录</el-dropdown-item
              >
            </el-dropdown-menu>
          </template>
        </el-dropdown>
      </div>
    </div>
  </div>
</template>
<script setup lang="ts">
import { onMounted } from "vue";
import { useSidebarStore } from "../store/sidebar";
import { useRouter } from "vue-router";
import imgurl from "../assets/img/img.jpg";
// 1. 导入新的 userStore
import { useUserStore } from "../store/userStore";

const username: string | null = localStorage.getItem("ms_username");
const message: number = 2;

const sidebar = useSidebarStore();
// 侧边栏折叠
const collapseChage = () => {
  sidebar.handleCollapse();
};

onMounted(() => {
  if (document.body.clientWidth < 1500) {
    collapseChage();
  }
});

// 2. 获取 userStore 实例
const userStore = useUserStore();
const router = useRouter();

// 用户名下拉菜单选择事件
const handleCommand = (command: string) => {
  if (command == "loginout") {
    // 3. 【核心改动】调用 clearAuth 清除所有登录信息
    userStore.clearAuth();

    // 4. 跳转到登录页
    router.push("/login");

    // 5. 刷新页面以重置路由
    // 这是清除动态添加的路由的最简单方法
    window.location.reload();

  } else if (command == "user") {
    router.push("/user");
  }
};
</script>
<style scoped>
/* (样式保持不变) */
.header {
  position: relative;
  box-sizing: border-box;
  width: 100%;
  height: 70px;
  font-size: 22px;
  color: #fff;
}
.collapse-btn {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  float: left;
  padding: 0 21px;
  cursor: pointer;
}
.header .logo {
  float: left;
  width: 250px;
  line-height: 70px;
}
.header-right {
  float: right;
  padding-right: 50px;
}
.header-user-con {
  display: flex;
  height: 70px;
  align-items: center;
}
.btn-fullscreen {
  transform: rotate(45deg);
  margin-right: 5px;
  font-size: 24px;
}
.btn-bell,
.btn-fullscreen {
  position: relative;
  width: 30px;
  height: 30px;
  text-align: center;
  border-radius: 15px;
  cursor: pointer;
  display: flex;
  align-items: center;
}
.btn-bell-badge {
  position: absolute;
  right: 4px;
  top: 0px;
  width: 8px;
  height: 8px;
  border-radius: 4px;
  background: #f56c6c;
  color: #fff;
}
.btn-bell .el-icon-lx-notice {
  color: #fff;
}
.user-name {
  margin-left: 10px;
}
.user-avator {
  margin-left: 20px;
}
.el-dropdown-link {
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
}
.el-dropdown-menu__item {
  text-align: center;
}
</style>

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\components\header.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\components\sidebar.vue ---

<template>
  <div class="sidebar" style="background-color: #99CCFF">
    <el-menu
        class="sidebar-el-menu"
        :default-active="onRoutes"
        :collapse="sidebar.collapse"
        background-color="#324157"
        text-color="#bfcbd9"
        active-text-color="#20a0ff"
        unique-opened
        router
    >
      <template v-for="item in sidebarItems">
        <template v-if="item.children && item.children.length > 0">

          <el-sub-menu
              :index="item.path"
              :key="item.path"
          >
            <template #title>
              <el-icon>
                <component :is="item.meta.icon"></component>
              </el-icon>
              <span>{{ item.meta.title }}</span>
            </template>

            <template v-for="subItem in item.children">

              <el-sub-menu
                  v-if="subItem.children && subItem.children.length > 0"
                  :index="subItem.path"
                  :key="subItem.path"
              >
                <template #title>
                  <span>{{ subItem.meta.title }}</span>
                </template>

                <el-menu-item
                    v-for="(threeItem, i) in subItem.children"
                    :key="i"
                    :index="threeItem.path"
                >
                  <span>{{ threeItem.meta.title }}</span>
                </el-menu-item>

              </el-sub-menu>

              <el-menu-item
                  v-else
                  :index="subItem.path"
                  :key="subItem.path + '-item'"
              >
                <span>{{ subItem.meta.title }}</span>
              </el-menu-item>
            </template>
          </el-sub-menu>
        </template>

        <template v-else>
          <el-menu-item
              :index="item.path"
              :key="item.path + '-main'"
          >
            <el-icon>
              <component :is="item.meta.icon"></component>
            </el-icon>
            <template #title>{{ item.meta.title }}</template>
          </el-menu-item>
        </template>
      </template>
    </el-menu>
  </div>
</template>

<script setup lang="ts">
import { computed } from "vue";
import { useSidebarStore } from "../store/sidebar";
import { useRoute }from "vue-router";
// 1. 导入 userStore
import { useUserStore } from "../store/userStore";

// 2. ⬇️ ⬇️ ⬇️ 删除静态的 'items' 数组 ⬇️ ⬇️ ⬇️
// const items = [ ... (整个数组被删除) ... ];
// ⬆️ ⬆️ ⬆️

const route = useRoute();
const onRoutes = computed(() => {
  return route.path;
});

const sidebar = useSidebarStore();
// 3. 获取 userStore 实例
const userStore = useUserStore();

// 4. 【核心改动】从 userStore 动态计算菜单项
const sidebarItems = computed(() => {
  // 'accessibleRoutes' 包含了所有路由
  // 我们只关心 'Home' 路由 (path: '/') 下的 children
  const homeRoute = userStore.accessibleRoutes.find(r => r.name === 'Home');

  if (homeRoute && homeRoute.children) {
    // 过滤掉 meta.hidden = true 的路由 (如果需要的话)
    return homeRoute.children.filter(
        route => !route.meta || !route.meta.hidden
    );
  }
  return []; // 返回空数组
});

</script>

<style scoped>
/* (样式保持不变) */
.sidebar {
  display: block;
  position: absolute;
  left: 0;
  top: 70px;
  bottom: 0;
  overflow-y: scroll;
}

.sidebar::-webkit-scrollbar {
  width: 0;
}

.sidebar-el-menu:not(.el-menu--collapse) {
  width: 250px;
}

.sidebar > ul {
  height: 100%;
}
</style>

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\components\sidebar.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\components\table-detail.vue ---

<template>
  <el-descriptions title="" :column="2" border>
    <el-descriptions-item>
      <template #label> 用户ID </template>
      {{ data.id }}
    </el-descriptions-item>
    <el-descriptions-item>
      <template #label> 用户名 </template>
      {{ data.name }}
    </el-descriptions-item>
    <el-descriptions-item>
      <template #label> 邮箱 </template>
      {{ data.e_mail || '未提供' }}
    </el-descriptions-item>
    <el-descriptions-item>
      <template #label> 电话号码 </template>
      {{ data.phone || '未提供' }}
    </el-descriptions-item>
    <el-descriptions-item :span="2">
      <template #label> 权限 </template>
      {{ data.authority || 'N/A' }}
    </el-descriptions-item>
    <el-descriptions-item>
      <template #label> 地址 </template>
      {{ data.address || '未提供' }}
    </el-descriptions-item>
    <el-descriptions-item>
      <template #label> 注册时间 </template>
      {{ data.gmtCreated || 'N/A' }}
    </el-descriptions-item>
  </el-descriptions>
</template>

<script lang="ts" setup>
const props = defineProps({
  data: {
    type: Object,
    required: true
  }
});
</script>

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\components\table-detail.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\components\table-edit.vue ---

<template>

  <el-form ref="formRef" :model="form" :rules="rules" label-width="100px">
    <el-form-item label="用户名" prop="name">
      <el-input v-model="form.name"></el-input>
    </el-form-item>

    <el-form-item label="性别" prop="sex">
      <el-input v-model="form.sex"></el-input>
    </el-form-item>

    <el-form-item label="ID" prop="id">
      <el-input v-model.number="form.id"></el-input>
    </el-form-item>

    <el-form-item label="邮箱" prop="e_mail">
      <el-input v-model.number="form.e_mail"></el-input>
    </el-form-item>

    <el-form-item label="电话号码" prop="phone">
      <el-input v-model="form.phone"></el-input>
    </el-form-item>

    <el-form-item label="权限" prop="authority">
      <el-input v-model="form.authority"></el-input>
    </el-form-item>

    <el-form-item label="地址" prop="authority">
      <el-input v-model="form.address"></el-input>
    </el-form-item>

    <el-form-item label="注册日期" prop="date">
      <el-date-picker type="date" v-model="form.date" value-format="YYYY-MM-DD"></el-date-picker>
    </el-form-item>

    <el-form-item>
      <el-button type="primary" @click="saveEdit(formRef)">保 存</el-button>
    </el-form-item>
  </el-form>
</template>

<script lang="ts" setup>
import {ElMessage, FormInstance, FormRules, UploadProps} from 'element-plus';
import {ref} from 'vue';

const props = defineProps({
  data: {
    type: Object,
    required: true
  },
  edit: {
    type: Boolean,
    required: false
  },
  update: {
    type: Function,
    required: true
  }
});

const defaultData = {
  id: 0,
  name: '',
  e_mail: '',
  phone: '',
  authority: 'user', // 默认为 'user'
  address: '',
  sex: '未知', // 与 login.vue 保持一致
  createdTime: Date.now()
};

const form = ref({...(props.edit ? props.data : defaultData)});

const rules: FormRules = {
  name: [{required: true, message: '用户名', trigger: 'blur'}]
};
const formRef = ref<FormInstance>();
const saveEdit = (formEl: FormInstance | undefined) => {
  if (!formEl) return;
  formEl.validate(valid => {
    if (!valid) return false;
    props.update(form.value);
    ElMessage.success('保存成功！');
  });
};

const handleAvatarSuccess: UploadProps['onSuccess'] = (response, uploadFile) => {
  form.value.thumb = URL.createObjectURL(uploadFile.raw!);
};

const beforeAvatarUpload: UploadProps['beforeUpload'] = rawFile => {
  if (rawFile.type !== 'image/jpeg') {
    ElMessage.error('Avatar picture must be JPG format!');
    return false;
  } else if (rawFile.size / 1024 / 1024 > 2) {
    ElMessage.error('Avatar picture size can not exceed 2MB!');
    return false;
  }
  return true;
};
</script>

<style>
.avatar-uploader .el-upload {
  border: 1px dashed var(--el-border-color);
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: var(--el-transition-duration-fast);
}

.avatar-uploader .el-upload:hover {
  border-color: var(--el-color-primary);
}

.el-icon.avatar-uploader-icon {
  font-size: 28px;
  color: #8c939d;
  width: 178px;
  height: 178px;
  text-align: center;
}
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\components\table-edit.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\components\tags.vue ---

<template>
	<div class="tags" v-if="tags.show">
		<ul>
			<li
				class="tags-li"
				v-for="(item, index) in tags.list"
				:class="{ active: isActive(item.path) }"
				:key="index"
			>
				<router-link :to="item.path" class="tags-li-title">{{ item.title }}</router-link>
				<el-icon @click="closeTags(index)"><Close /></el-icon>
			</li>
		</ul>
		<div class="tags-close-box">
			<el-dropdown @command="handleTags">
				<el-button size="small" type="primary">
					标签选项
					<el-icon class="el-icon--right">
						<arrow-down />
					</el-icon>
				</el-button>
				<template #dropdown>
					<el-dropdown-menu size="small">
						<el-dropdown-item command="other">关闭其他</el-dropdown-item>
						<el-dropdown-item command="all">关闭所有</el-dropdown-item>
					</el-dropdown-menu>
				</template>
			</el-dropdown>
		</div>
	</div>
</template>

<script setup lang="ts">
import { useTagsStore } from '../store/tags';
import { onBeforeRouteUpdate, useRoute, useRouter } from 'vue-router';

const route = useRoute();
const router = useRouter();
const isActive = (path: string) => {
	return path === route.fullPath;
};

const tags = useTagsStore();
// 关闭单个标签
const closeTags = (index: number) => {
	const delItem = tags.list[index];
	tags.delTagsItem(index);
	const item = tags.list[index] ? tags.list[index] : tags.list[index - 1];
	if (item) {
		delItem.path === route.fullPath && router.push(item.path);
	} else {
		router.push('/');
	}
};

// 设置标签
const setTags = (route: any) => {
	const isExist = tags.list.some(item => {
		return item.path === route.fullPath;
	});
	if (!isExist) {
		if (tags.list.length >= 8) tags.delTagsItem(0);
		tags.setTagsItem({
			name: route.name,
			title: route.meta.title,
			path: route.fullPath
		});
	}
};
setTags(route);
onBeforeRouteUpdate(to => {
	setTags(to);
});

// 关闭全部标签
const closeAll = () => {
	tags.clearTags();
	router.push('/');
};
// 关闭其他标签
const closeOther = () => {
	const curItem = tags.list.filter(item => {
		return item.path === route.fullPath;
	});
	tags.closeTagsOther(curItem);
};
const handleTags = (command: string) => {
	command === 'other' ? closeOther() : closeAll();
};

</script>

<style>
.tags {
	position: relative;
	height: 30px;
	overflow: hidden;
	background: #fff;
	padding-right: 120px;
	box-shadow: 0 5px 10px #ddd;
}

.tags ul {
	box-sizing: border-box;
	width: 100%;
	height: 100%;
}

.tags-li {
	display: flex;
	align-items: center;
	float: left;
	margin: 3px 5px 2px 3px;
	border-radius: 3px;
	font-size: 12px;
	overflow: hidden;
	cursor: pointer;
	height: 23px;
	border: 1px solid #e9eaec;
	background: #fff;
	padding: 0 5px 0 12px;
	color: #666;
	-webkit-transition: all 0.3s ease-in;
	-moz-transition: all 0.3s ease-in;
	transition: all 0.3s ease-in;
}

.tags-li:not(.active):hover {
	background: #f8f8f8;
}

.tags-li.active {
	color: #fff;
}

.tags-li-title {
	float: left;
	max-width: 80px;
	overflow: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
	margin-right: 5px;
	color: #666;
}

.tags-li.active .tags-li-title {
	color: #fff;
}

.tags-close-box {
	position: absolute;
	right: 0;
	top: 0;
	box-sizing: border-box;
	padding-top: 1px;
	text-align: center;
	width: 110px;
	height: 30px;
	background: #fff;
	box-shadow: -3px 0 15px 3px rgba(0, 0, 0, 0.1);
	z-index: 10;
}
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\components\tags.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\router\index-routes.ts ---

// 这是一个新文件，存放路由定义
import { RouteRecordRaw } from 'vue-router';
import Home from '../views/home.vue';

/**
 * 公共路由
 */
export const publicRoutes: RouteRecordRaw[] = [
    {
        path: '/login',
        name: 'Login',
        meta: {
            title: '登录',
        },
        component: () => import(/* webpackChunkName: "login" */ '../views/login.vue'),
    },
    {
        path: '/403',
        name: '403',
        meta: {
            title: '没有权限',
        },
        component: () => import(/* webpackChunkName: "403" */ '../views/403.vue'),
    },
    {
        path: '/404',
        name: '404',
        meta: {
            title: '未找到页面',
        },
        component: () => import(/* webpackChunkName: "404" */ '../views/404.vue'),
    },

];

/**
 * 异步路由 (即 权限路由)
 */
export const asyncRoutes: RouteRecordRaw[] = [
    {
        path: '/',
        name: 'Home',
        component: Home,
        redirect: '/dashboard',
        meta: {
            title: '系统首页',
            icon: 'Odometer',
            roles: ['admin', 'user']
        },
        children: [
            {
                path: '/dashboard',
                name: 'dashboard',
                meta: {
                    title: '系统首页',
                    icon: 'Odometer',
                    roles: ['admin', 'user']
                },
                component: () => import(/* webpackChunkName: "dashboard" */ '../views/dashboard.vue'),
            },
            {
                path: '/management',
                name: 'management',
                meta: {
                    title: '人员及设备管理',
                    icon: 'Calendar',
                    roles: ['admin']
                },
                redirect: '/management/table',
                children: [
                    {
                        path: '/management/table',
                        name: 'basetable',
                        meta: {
                            title: '人员管理',
                            roles: ['admin']
                        },
                        component: () => import(/* webpackChunkName: "table" */ '../views/table.vue'),
                    },
                    {
                        path: '/management/device-management',
                        name: 'deviceManagement',
                        meta: {
                            title: '设备列表管理',
                            roles: ['admin']
                        },
                        component: () => import(/* webpackChunkName: "deviceManagement" */ '../views/deviceManagement.vue'),
                    },
                    {
                        path: '/management/device-monitor',
                        name: 'deviceMonitor',
                        meta: {
                            title: '设备实时监控',
                            roles: ['admin']
                        },
                        redirect: '/management/device-monitor/njupt',
                        children: [
                            {
                                path: '/management/device-monitor/njupt',
                                name: 'device in NUJPT',
                                meta: {
                                    title: '万达茂设备监控',
                                    roles: ['admin'],
                                },
                                component: () => import(/* webpackChunkName: "table" */ '../views/WanDaMao.vue'),
                            },
                            {
                                path: '/management/device-monitor/nju',
                                name: 'device in NJU',
                                meta: {
                                    title: '金鹰设备监控',
                                    roles: ['admin'],
                                },
                                component: () => import(/* webpackChunkName: "table" */ '../views/JingYin.vue'),
                            },
                        ]
                    }
                ]
            },
            {
                path: '/tabs',
                name: 'tabs',
                meta: {
                    title: '消息中心',
                    icon: 'DocumentCopy',
                    roles: ['admin', 'user']
                },
                component: () => import(/* webpackChunkName: "tabs" */ '../views/tabs.vue'),
            },
            {
                path: '/charts',
                name: 'basecharts',
                meta: {
                    title: '火情数据统计',
                    icon: 'PieChart',
                    roles: ['admin', 'user']
                },
                component: () => import(/* webpackChunkName: "charts" */ '../views/charts.vue'),
            },
            {
                path: '/monitor',
                name: 'monitor',
                meta: {
                    title: '生命体征监测',
                    icon: 'CoffeeCup',
                    roles: ['admin', 'user']
                },
                component: () => import(/* webpackChunkName: "donate" */ '../views/monitor.vue'),
            },
            {
                path: '/control',
                name: 'control',
                meta: {
                    title: '设备控制',
                    icon: 'Tools',
                    roles: ['admin', 'user']
                },
                component: () => import(/* webpackChunkName: "donate" */ '../views/control.vue'),
            },
            {
                path: '/map',
                name: 'map',
                meta: {
                    title: '逃生路线',
                    icon: 'el-icon-picture-outline',
                    roles: ['admin', 'user']
                },
                component: () => import(/* webpackChunkName: "dashboard" */ '../views/map.vue'),
            },
            {
                path: '/user',
                name: 'user',
                meta: {
                    title: '个人中心',
                    icon: 'User',
                    hidden: true,
                    roles: ['admin', 'user']
                },
                component: () => import(/* webpackChunkName: "user" */ '../views/user.vue'),
            },
        ],
    },
];

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\router\index-routes.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\router\index.ts ---

// 文件路径: src/router/index.ts (最终的生产版本)

import { createRouter, createWebHashHistory, RouteRecordRaw } from 'vue-router';
import { useUserStore } from '../store/userStore'; // 导入 store
import NProgress from 'nprogress';
import 'nprogress/nprogress.css';

// 1. 从我们分离的路由文件中导入路由
import { publicRoutes, asyncRoutes } from './index-routes';

/**
 * 递归过滤异步路由
 * @param routes 待过滤的路由 (asyncRoutes)
 * @param authority 用户的角色 (例如 'admin')
 * @returns 该角色可以访问的路由
 */
function filterAsyncRoutes(routes: RouteRecordRaw[], authority: string): RouteRecordRaw[] {
    const accessibleRoutes: RouteRecordRaw[] = [];
    routes.forEach(route => {
        // 复制一份，避免污染
        const tmp = { ...route };

        // 检查 meta.roles 是否定义，以及 authority 是否在 roles 列表中
        // 如果没有 meta.roles，则默认允许访问
        const hasPermission = !tmp.meta || !tmp.meta.roles || (tmp.meta.roles as string[]).includes(authority);

        if (hasPermission) {
            if (tmp.children) {
                // 如果有子路由，递归过滤
                tmp.children = filterAsyncRoutes(tmp.children, authority);
            }
            accessibleRoutes.push(tmp);
        }
    });
    return accessibleRoutes;
}


// 2. 创建 router 实例时，只加载公共路由
const router = createRouter({
    history: createWebHashHistory(),
    routes: publicRoutes, // 初始只加载公共路由
});

// 3. 标志位，防止路由重复添加
let routesAdded = false;


const catchAllRoute: RouteRecordRaw = {
    path: '/:pathMatch(.*)*',
    name: 'NotFound',
    redirect: '/404'
};


/**
 * 4. 核心：全局路由守卫
 */
router.beforeEach(async (to, from, next) => {
    NProgress.start();

    // 必须在守卫内部获取 store 实例
    const userStore = useUserStore();
    const authority = userStore.authority; // (等同于 localStorage.getItem('ms_authority'))

    if (authority) {
        // --- 1. 用户已登录 ---
        if (to.path === '/login') {
            // 如果已登录，访问 /login 则重定向到首页
            next('/');
            NProgress.done();
        } else {
            // 检查路由是否已动态添加
            if (!routesAdded) {
                try {
                    // 1. 根据角色过滤路由
                    const finalRoutes = filterAsyncRoutes(asyncRoutes, authority);

                    // 2. 动态添加过滤后的路由
                    finalRoutes.forEach(route => {
                        router.addRoute(route);
                    });

                    router.addRoute(catchAllRoute);

                    // 3. 将完整路由列表存入 Pinia (供 sidebar.vue 使用)
                    userStore.setAccessibleRoutes(publicRoutes.concat(finalRoutes));

                    // 4. 设置标志位
                    routesAdded = true;

                    // 5. 使用 ...to, replace: true 确保路由已完全加载
                    next({ ...to, replace: true });

                } catch (error) {
                    console.error('动态添加路由失败:', error);
                    // 添加失败，清除登录状态并重定向到登录页
                    userStore.clearAuth();
                    next('/login');
                    NProgress.done();
                }
            } else {
                // 路由已添加，直接放行
                next();
            }
        }
    } else {
        // --- 2. 用户未登录 ---
        if (to.path === '/login' || to.path === '/404' || to.path === '/403') {
            // 访问登录页或错误页，放行
            next();
        } else {
            // 其他页面，全部重定向到登录页
            next('/login');
            NProgress.done();
        }
    }
});

router.afterEach(() => {
    NProgress.done();
});

// (注意: header.vue 中的 window.location.reload() 会自动重置 routesAdded 标志位)

export default router;

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\router\index.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\store\sidebar.ts ---

import { defineStore } from 'pinia';

export const useSidebarStore = defineStore('sidebar', {
	state: () => {
		return {
			collapse: false
		};
	},
	getters: {},
	actions: {
		handleCollapse() {
			this.collapse = !this.collapse;
		}
	}
});


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\store\sidebar.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\store\tags.ts ---

import { defineStore } from 'pinia';

interface ListItem {
	name: string;
	path: string;
	title: string;
}

export const useTagsStore = defineStore('tags', {
	state: () => {
		return {
			list: <ListItem[]>[]
		};
	},
	getters: {
		show: state => {
			return state.list.length > 0;
		},
		nameList: state => {
			return state.list.map(item => item.name);
		}
	},
	actions: {
		delTagsItem(index: number) {
			this.list.splice(index, 1);
		},
		setTagsItem(data: ListItem) {
			this.list.push(data);
		},
		clearTags() {
			this.list = [];
		},
		closeTagsOther(data: ListItem[]) {
			this.list = data;
		},
		closeCurrentTag(data: any) {
			for (let i = 0, len = this.list.length; i < len; i++) {
				const item = this.list[i];
				if (item.path === data.$route.fullPath) {
					if (i < len - 1) {
						data.$router.push(this.list[i + 1].path);
					} else if (i > 0) {
						data.$router.push(this.list[i - 1].path);
					} else {
						data.$router.push('/');
					}
					this.list.splice(i, 1);
					break;
				}
			}
		}
	}
});


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\store\tags.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\store\userStore.ts ---

// 文件路径: src/store/userStore.ts
// (请确保文件名和路径正确)

import { defineStore } from 'pinia';

export const useUserStore = defineStore('user', {
    state: () => {
        return {
            // 1. 从 localStorage 读取 'ms_authority' 作为初始值
            authority: localStorage.getItem('ms_authority') || '',

            // 2. 存储由 router/index.ts 计算出的、该角色可以访问的路由
            accessibleRoutes: [] as any[]
        };
    },
    actions: {
        /**
         * 登录时调用 (由 login.vue 调用)
         * @param auth - 用户角色 (例如 'admin' 或 'user')
         */
        setAuthority(auth: string) {
            this.authority = auth;
            localStorage.setItem('ms_authority', auth);
        },

        /**
         * 动态生成路由时调用 (由 router/index.ts 调用)
         * @param routes - 该角色被允许访问的完整路由列表
         */
        setAccessibleRoutes(routes: any[]) {
            this.accessibleRoutes = routes;
        },

        /**
         * 退出登录时调用 (由 header.vue 调用)
         */
        clearAuth() {
            this.authority = '';
            this.accessibleRoutes = [];
            localStorage.removeItem('ms_authority');
            localStorage.removeItem('ms_username');
        }
    },
    getters: {
        /**
         * 检查当前用户是否拥有指定角色之一
         */
        hasPermission: (state) => (roles: string[]) => {
            if (state.authority) {
                return roles.includes(state.authority);
            }
            return false;
        }
    }
});

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\store\userStore.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\utils\request.ts ---

import axios, {AxiosInstance, AxiosError, AxiosResponse, AxiosRequestConfig} from 'axios';

const service: AxiosInstance = axios.create({
    baseURL: 'http://localhost:8080', // 只需指定主机名和端口号
    timeout: 5000
});

//可能出现错误

// @ts-ignore

service.interceptors.request.use(


    (config: AxiosRequestConfig) => {
        return config;
    },


    (error: AxiosError) => {
        console.error('Request Error:', error);
        return Promise.reject(error);
    }
);





service.interceptors.response.use(
    (response: AxiosResponse) => {
        if (response.status === 200) {
            let res = response.data;

            return res;
        } else {
            return Promise.reject('Response Error: Non-200 status code');
        }
    },
    (error: AxiosError) => {
        console.error('Response Error:', error);
        return Promise.reject(error);
    }
);

export default service;


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\utils\request.ts ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\403.vue ---

<template>
	<div class="error-page">
		<div class="error-code">4<span>0</span>3</div>
		<div class="error-desc">啊哦~ 你没有权限访问该页面哦</div>
		<div class="error-handle">
			<router-link to="/">
				<el-button type="primary" size="large">返回首页</el-button>
			</router-link>
			<el-button class="error-btn" type="primary" size="large" @click="goBack">返回上一页</el-button>
		</div>
	</div>
</template>

<script setup lang="ts" name="403">
import { useRouter } from 'vue-router';

const router = useRouter();
const goBack = () => {
	router.go(-2);
};
</script>

<style scoped>
.error-page {
	display: flex;
	justify-content: center;
	align-items: center;
	flex-direction: column;
	width: 100%;
	height: 100%;
	background: #f3f3f3;
	box-sizing: border-box;
}
.error-code {
	line-height: 1;
	font-size: 250px;
	font-weight: bolder;
	color: #f02d2d;
}
.error-code span {
	color: #00a854;
}
.error-desc {
	font-size: 30px;
	color: #777;
}
.error-handle {
	margin-top: 30px;
	padding-bottom: 200px;
}
.error-btn {
	margin-left: 100px;
}
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\403.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\404.vue ---

<template>
	<div class="error-page">
		<div class="error-code">4<span>0</span>4</div>
		<div class="error-desc">啊哦~ 你所访问的页面不存在</div>
		<div class="error-handle">
			<router-link to="/">
				<el-button type="primary" size="large">返回首页</el-button>
			</router-link>
			<el-button class="error-btn" type="primary" size="large" @click="goBack">返回上一页</el-button>
		</div>
	</div>
</template>

<script setup lang="ts" name="404">
import { useRouter } from 'vue-router';

const router = useRouter();
const goBack = () => {
	router.go(-1);
};
</script>

<style scoped>
.error-page {
	display: flex;
	justify-content: center;
	align-items: center;
	flex-direction: column;
	width: 100%;
	height: 100%;
	background: #f3f3f3;
	box-sizing: border-box;
}
.error-code {
	line-height: 1;
	font-size: 250px;
	font-weight: bolder;
	color: #2d8cf0;
}
.error-code span {
	color: #00a854;
}
.error-desc {
	font-size: 30px;
	color: #777;
}
.error-handle {
	margin-top: 30px;
	padding-bottom: 200px;
}
.error-btn {
	margin-left: 100px;
}
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\404.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\charts.vue ---

<template>
  <div class="container" style="display: flex ; flex-wrap: wrap ; justify-content: space-between">

    <div id="area-chart" class="chart">
      <areaCharts style="width: 100% ; height: 100%"></areaCharts>
    </div>

    <div id="environment-chart" class="chart">
      <environmentChart style="width: 100% ; height: 100%"></environmentChart>
    </div>

    <div id="type-chart" class="chart">
      <typeChart style="width: 100% ; height: 100%"> 66</typeChart>
    </div>

    <div class="chart">
      <deviceChart style="width: 100% ; height: 100%"></deviceChart>
    </div>

  </div>
</template>

<script setup lang="ts" name="basecharts">
import areaCharts from '../charts/areaCharts.vue';
import environmentChart from '../charts/riskChart.vue';
import typeChart from '../charts/typeChart.vue';
import deviceChart from '../charts/device.vue';

const option = areaCharts

</script>

<style scoped>
.container{
  width:100%;
  height: 100%;
}
.chart {
  margin-top: 10px;
  width: 45%;
  height: 45%;
  margin-right: 10px;
}

</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\charts.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\control.vue ---

<template>
  <el-button plain @click="click3" class="search-button"  :style="{ backgroundColor: background }">
    <LocationInformation style="width: 8em; height: 8em; margin-right: 8px"/>
  </el-button>
  <el-text type="success" class="text1"  v-show="text_visible">{{ status }}</el-text>
  <el-text type="danger" class="text2"  v-show="!text_visible">{{ status }}</el-text>
  <el-button plain @click="click1" class="warning-button">
    <Warning style="width: 8em; height: 8em; margin-right: 8px"/>
  </el-button>
  <div>
    <el-input v-model="input" style="width: 240px" placeholder="输入地区以查询终端数据" class="input"/>
    <el-button plain @click="click2" class="check-button">
      <Search style="width: 1.2em; height: 1.2em; margin-right: 8px;border: 2px" />
    </el-button>
  </div>
  <el-table
      :data="state.tableData"
      style="width: 100%; font-size: 20px; display: block; color: black; margin-left: 15%;;width:67%;margin-top: 10px"
      :row-class-name="tableRowClassName"
      :header-cell-style="{color:'black'}"
      v-show="visible"
  >
    <el-table-column prop="humidity" label="湿度" width="180px" align="center" style="color: black"/>
    <el-table-column prop="temperature" label="最高温度" width="180px" align="center"/>
    <el-table-column prop="fire" label="是否存在火源" width="180px" align="center"/>
    <el-table-column prop="smoke" label="烟雾浓度" width="180px" align="center"/>
    <el-table-column prop="co" label="有害气体浓度" width="180px" align="center"/>
    <el-table-column prop="risk" label="火灾风险" width="180px" align="center"/>
  </el-table>
</template>

<script lang="ts" setup>
import { ElNotification } from 'element-plus'
import {LocationInformation, Warning} from "@element-plus/icons-vue";
import { reactive, ref, onMounted } from "vue";
import service from "../utils/request";

const input = ref('');

interface environment {
  humidity: number;
  temperature: number;
  fire: number;
  smoke: number;
  co: number;
  risk: number;
}

let humidity; //8
let temperature; //50
let fire; //0
let smoke; //8
let co; //20
let risk; //0
const state = reactive({
  tableData: [],
  form: {},
});
const activeIndex = ref("1");
const activeIndex2 = ref("1");
const count = ref(0);

const tableRowClassName = ({
                             row,
                             rowIndex,
                           }: {
  row: environment;
  rowIndex: number;
}) => {
  if (row.risk === 1 || row.co > 20 || row.fire === 1) {
    return "warning-row";
  }
  return "";
};

// 请求后台数据
const load = () => {
  service.get('/environment/getTheLatest').then((res) => {
    const newData = res.data;
    // 清空表格数据
    state.tableData = [];
    // 将获得的五条数据添加到表格数据中
    for (let i = 0; i < newData.length; i++) {
      state.tableData.push(newData[i]);
    }
    // 更新数据到界面
    humidity = state.tableData[state.tableData.length - 1].humidity;
    temperature = state.tableData[state.tableData.length - 1].temperature;
    fire = state.tableData[state.tableData.length - 1].fire;
    smoke = state.tableData[state.tableData.length - 1].smoke;
    co = state.tableData[state.tableData.length - 1].co;
    risk = state.tableData[state.tableData.length - 1].risk;
  });
};

// 初始加载数据
onMounted(() => {
  load();
});

// 每三秒刷新一次数据
setInterval(() => {
  state.tableData.shift();
  state.tableData.shift();
  state.tableData.shift();
  state.tableData.shift();
  state.tableData.shift();
  load();
  if (humidity > 80 || temperature > 50 || fire === 1 || smoke > 80 || co > 20 || risk === 1) {
    ElNotification({
      title: 'Warning',
      message: '有火情',
      type: 'error',
    })
  }
}, 60000);

const click1 = () => {
  ElNotification({
    title: 'Warning',
    message: '已向终端设备发送警报',
    type: 'error',
  })
}

let visible = true
const click2 = () => {
  visible = !visible
  load();
}

let status1 = '觅生者处于监控状态'
let status2 = '觅生者处于搜寻状态'
let status = status1
let text_visible = true
let background = 'green'
const click3 = () => {
  if (text_visible){
    status = status2
  }
  else {
    status = status1
  }
  text_visible = !text_visible
  background = background === 'red' ? 'green' : 'red'; // Toggle background color
  load();
}
</script>

<style scoped>
.warning-button {
  background-color: #f56c6c;
  color: white;
  border-color: #f56c6c;
  width:15%;
  height:15%;
  margin-left: 25%;
  margin-top: 5%;
  border-radius: 10px;
}

.check-button {
  color: white;
  border-color: #64d8ff;
  background-color: #64d8ff;
  margin-left: 5px;
  border-radius: 20px;
  margin-top: 5%;
}

.search-button {
  background-color: #31b033;
  color: white;
  border-color: #31b033;
  height: 15%;
  width: 15%;
  margin-left: 15%;
  margin-top: 5%;
  border-radius: 10px;
}

.text1, .text2 {
  position: absolute;
  font-size: 20px;
  margin-top: 8%;
  margin-left: 40px;
  border-color: #8c939d;
}

.input{
  margin-left: 15%;
  border-radius: 10px;
  margin-top: 5%;
}
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\control.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\dashboard.vue ---

<!--
待办的添加与删除
@member: ljx
-->

<!--
ljx:使用新的template，替换旧的template

<template>
  <div>
    <el-row :gutter="20">
      <el-col :span="8">
        <el-card shadow="hover" class="mgb20" style="height: 252px">
          <div class="user-info">
            <el-avatar :size="120" :src="imgurl"/>
            <div class="user-info-cont">
              <div class="user-info-name">{{ name }}</div>
              <div>{{ role }}</div>
            </div>
          </div>
          <div class="user-info-list">
            上次登录时间：
            <span>2024-10-01</span>
          </div>
          <div class="user-info-list">
            上次登录地点：
            <span>南京</span>
          </div>
        </el-card>
        <el-card shadow="hover" style="height: 252px">
          <template #header>
            <div class="clearfix">
              <span>火灾类型详细</span>
            </div>
          </template>
          厨房
          <el-progress :percentage="79.4" color="#42b983"></el-progress>
          电器
          <el-progress :percentage="14" color="#f1e05a"></el-progress>
          粉尘
          <el-progress :percentage="5.6"></el-progress>
          气体
          <el-progress :percentage="1" color="#f56c6c"></el-progress>
        </el-card>
      </el-col>
      <el-col :span="16">
        <el-row :gutter="20" class="mgb20">
          <el-col :span="8">
            <el-card shadow="hover" :body-style="{ padding: '0px' }">
              <div class="grid-content grid-con-1">
                <el-icon class="grid-con-icon">
                  <User/>
                </el-icon>
                <div class="grid-cont-right">
                  <div class="grid-num">1234</div>
                  <div>用户访问量</div>
                </div>
              </div>
            </el-card>
          </el-col>
          <el-col :span="8">
            <el-card shadow="hover" :body-style="{ padding: '0px' }">
              <div class="grid-content grid-con-2">
                <el-icon class="grid-con-icon">
                  <ChatDotRound/>
                </el-icon>
                <div class="grid-cont-right">
                  <div class="grid-num">321</div>
                  <div>系统消息</div>
                </div>
              </div>
            </el-card>
          </el-col>
          <el-col :span="8">
            <el-card shadow="hover" :body-style="{ padding: '0px' }">
              <div class="grid-content grid-con-3">
                <el-icon class="grid-con-icon">
                  <Goods/>
                </el-icon>
                <div class="grid-cont-right">
                  <div class="grid-num">5000</div>
                  <div>火灾发生数量</div>
                </div>
              </div>
            </el-card>
          </el-col>
        </el-row>
        <el-card shadow="hover" style="height: 403px">
          <template #header>
            <div class="clearfix">
              <span>待办事项</span>
              <el-button style="float: right; padding: 3px 0" text
              >添加
              </el-button
              >
            </div>
          </template>

          <el-table :show-header="false" :data="todoList" style="width: 100%">
            <el-table-column width="40">
              <template #default="scope">
                <el-checkbox v-model="scope.row.status"></el-checkbox>
              </template>
            </el-table-column>
            <el-table-column>
              <template #default="scope">
                <div
                    class="todo-item"
                    :class="{
                    'todo-item-del': scope.row.status,
                  }"
                >
                  {{ scope.row.title }}
                </div>
              </template>
            </el-table-column>
          </el-table>
        </el-card>
      </el-col>
    </el-row>
    <el-row :gutter="20">
      <el-col :span="12">
        <el-card shadow="hover">
          <schart
              ref="bar"
              class="schart"
              canvasId="bar"
              :options="options"
          ></schart>
        </el-card>
      </el-col>
      <el-col :span="12">
        <el-card shadow="hover">
          <schart
              ref="line"
              class="schart"
              canvasId="line"
              :options="options2"
          ></schart>
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>
-->
<template>
  <div>
    <el-row :gutter="20">
      <el-col :span="8">
        <el-card shadow="hover" class="mgb20" style="height: 252px">
          <div class="user-info">
            <el-avatar :size="120" :src="imgurl"/>
            <div class="user-info-cont">
              <div class="user-info-name">{{ name }}</div>
              <div>{{ role }}</div>
            </div>
          </div>
          <div class="user-info-list">
            上次登录时间：
            <span>2024-10-01</span>
          </div>
          <div class="user-info-list">
            上次登录地点：
            <span>南京</span>
          </div>
        </el-card>
        <el-card shadow="hover" style="height: 252px">
          <template #header>
            <div class="clearfix">
              <span>火灾类型详细</span>
            </div>
          </template>
          厨房
          <el-progress :percentage="79.4" color="#42b983"></el-progress>
          电器
          <el-progress :percentage="14" color="#f1e05a"></el-progress>
          粉尘
          <el-progress :percentage="5.6"></el-progress>
          气体
          <el-progress :percentage="1" color="#f56c6c"></el-progress>
        </el-card>
      </el-col>
      <el-col :span="16">
        <el-row :gutter="20" class="mgb20">
          <el-col :span="8">
            <el-card shadow="hover" :body-style="{ padding: '0px' }">
              <div class="grid-content grid-con-1">
                <el-icon class="grid-con-icon">
                  <User/>
                </el-icon>
                <div class="grid-cont-right">
                  <div class="grid-num">1234</div>
                  <div>用户访问量</div>
                </div>
              </div>
            </el-card>
          </el-col>
          <el-col :span="8">
            <el-card shadow="hover" :body-style="{ padding: '0px' }">
              <div class="grid-content grid-con-2">
                <el-icon class="grid-con-icon">
                  <ChatDotRound/>
                </el-icon>
                <div class="grid-cont-right">
                  <div class="grid-num">321</div>
                  <div>系统消息</div>
                </div>
              </div>
            </el-card>
          </el-col>
          <el-col :span="8">
            <el-card shadow="hover" :body-style="{ padding: '0px' }">
              <div class="grid-content grid-con-3">
                <el-icon class="grid-con-icon">
                  <Goods/>
                </el-icon>
                <div class="grid-cont-right">
                  <div class="grid-num">5000</div>
                  <div>火灾发生数量</div>
                </div>
              </div>
            </el-card>
          </el-col>
        </el-row>
        
        <el-card shadow="hover">
          <template #header>
            <div class="clearfix">
              <span>待办事项</span>
              <el-button style="float: right; padding: 3px 0" text @click="handleAdd">
                添加
              </el-button>
            </div>
          </template>

          <div class="todo-list-wrapper">
            <el-table :show-header="false" :data="todoList" style="width: 100%">
              
              <el-table-column width="40">
                <template #default="scope">
                  <el-checkbox 
                    v-model="scope.row.status" 
                    @change="handleStatusChange(scope.row)"
                  ></el-checkbox>
                </template>
              </el-table-column>

              <el-table-column>
                <template #default="scope">
                  <div class="todo-item-wrapper">
                      <div
                          class="todo-item"
                          :class="{'todo-item-del': scope.row.status}"
                      >
                        {{ scope.row.title }}
                      </div>
                      <el-icon class="todo-delete-icon" @click="handleDelete(scope.row)">
                          <Close />
                      </el-icon>
                  </div>
                </template>
              </el-table-column>
              
            </el-table>

            <div class="todo-buttons">
              <el-button type="success" size="small" @click="handleCompleteAll">全部完成</el-button>
              <el-button type="danger" size="small" @click="handleDeleteAll">删除所有</el-button>
            </div>
          </div>
          
        </el-card>
      </el-col>
    </el-row>
    <el-row :gutter="20">
      <el-col :span="12">
        <el-card shadow="hover">
          <schart
              ref="bar"
              class="schart"
              canvasId="bar"
              :options="options"
          ></schart>
        </el-card>
      </el-col>
      <el-col :span="12">
        <el-card shadow="hover">
          <schart
              ref="line"
              class="schart"
              canvasId="line"
              :options="options2"
          ></schart>
        </el-card>
      </el-col>
    </el-row>

    <el-dialog v-model="dialogVisible" title="添加待办事项" width="30%">
      <el-input
          v-model="newTodoTitle"
          placeholder="请输入待办事项..."
          @keyup.enter="handleAddItem"
      />
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="dialogVisible = false">取 消</el-button>
          <el-button type="primary" @click="handleAddItem">
            确 定
          </el-button>
        </span>
      </template>
    </el-dialog>
    
  </div>
</template>

<!--
ljx:使用新的script，替换下面旧的script

<script setup lang="ts" name="dashboard">
import Schart from "vue-schart";
import {reactive} from "vue";
import imgurl from "../assets/img/img.jpg";

const name = localStorage.getItem("ms_username");
const role: string = name === "admin" ? "超级管理员" : "普通用户";

const options = {
  type: 'bar',
  title: {
    text: '造成火灾的原因'
  },
  bgColor: '#fbfbfb',
  labels: ['一季度', '二季度', '三季度', '四季度'],
  datasets: [
    {
      label: '电瓶车',
      fillColor: 'rgba(241, 49, 74, 0.5)',
      data: [234, 278, 270, 190, 230]
    },
    {
      label: '电器',
      data: [164, 178, 190, 135, 160]
    },
    {
      label: '粉尘',
      data: [144, 198, 150, 235, 120]
    }
  ]
};
const options2 = {
  type: 'line',
  title: {
    text: '火灾造成的经济损失'
  },
  bgColor: '#fbfbfb',
  labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
  datasets: [
    {
      label: '直接经济损失',
      data: [234, 278, 270, 190, 230, 550, 150, 592, 150, 589, 151, 111, 125]
    },
    {
      label: '间接经济损失',
      data: [164, 178, 190, 135, 160, 148, 11, 125, 114, 116, 31, 55]
    }

  ]
};
const todoList = reactive([
  {
    title: "木瓜小区火情",
    status: false,
  },
  {
    title: "44栋发生燃气泄露",
    status: false,
  },
  {
    title: "海绵小区消防栓维修",
    status: false,
  },

  {
    title: "海绵小区消防通道堵塞",
    status: true,
  },
  {
    title: "海绵小区消防设施检查",
    status: true,
  },
]);
</script>
-->
<script setup lang="ts" name="dashboard">
import Schart from "vue-schart";
// 1. 导入 onMounted 用于页面加载时获取数据
import { reactive, ref, onMounted } from "vue"; 
import { ElMessage, ElMessageBox } from "element-plus";
import imgurl from "../assets/img/img.jpg";
// 2. 导入 service (axios)
import service from "../utils/request"; 

const name = localStorage.getItem("ms_username");
const role: string = name === "admin" ? "超级管理员" : "普通用户";

// ... (省略了 options 和 options2 的图表配置, 保持不变) ...
const options = {
  type: 'bar',
  title: {
    text: '造成火灾的原因'
  },
  bgColor: '#fbfbfb',
  labels: ['一季度', '二季度', '三季度', '四季度'],
  datasets: [
    {
      label: '电瓶车',
      fillColor: 'rgba(241, 49, 74, 0.5)',
      data: [234, 278, 270, 190, 230]
    },
    {
      label: '电器',
      data: [164, 178, 190, 135, 160]
    },
    {
      label: '粉尘',
      data: [144, 198, 150, 235, 120]
    }
  ]
};
const options2 = {
  type: 'line',
  title: {
    text: '火灾造成的经济损失'
  },
  bgColor: '#fbfbfb',
  labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
  datasets: [
    {
      label: '直接经济损失',
      data: [234, 278, 270, 190, 230, 550, 150, 592, 150, 589, 151, 111, 125]
    },
    {
      label: '间接经济损失',
      data: [164, 178, 190, 135, 160, 148, 11, 125, 114, 116, 31, 55]
    }

  ]
};

// 3. 将 todoList 从 reactive 改为 ref()
const todoList = ref([]); // 初始为空数组

// 4. 新增：从后端加载数据的函数
const loadTodos = async () => {
    try {
        const res = await service.get('/todo/all');
        if (res.code === '200') {
            todoList.value = res.data;
        } else {
            ElMessage.error(res.message || '加载待办事项失败');
        }
    } catch (e) {
        ElMessage.error('网络请求失败');
    }
};

// 5. 新增：在组件挂载时调用加载函数
onMounted(() => {
    loadTodos();
});


// --- "添加"功能逻辑 (已修改) ---
const dialogVisible = ref(false);
const newTodoTitle = ref('');
const handleAdd = () => {
    newTodoTitle.value = ''; 
    dialogVisible.value = true;
};
const handleAddItem = async () => {
    if (!newTodoTitle.value) {
        ElMessage.warning('请输入待办事项内容');
        return;
    }
    try {
        // 6. 调用后端 "add" API
        const res = await service.post('/todo/add', { title: newTodoTitle.value });
        if (res.code === '200') {
            // 7. 成功后, 重新加载列表 (而不是本地 unshift)
            await loadTodos(); 
            ElMessage.success('添加成功');
        } else {
            ElMessage.error(res.message || '添加失败');
        }
        dialogVisible.value = false;
    } catch (e) {
        ElMessage.error('添加失败');
    }
};


// --- "删除"和"清空"功能逻辑 (已修改) ---

// 8. 新增：处理 Checkbox 状态变更
// (需要在 template 的 el-checkbox 上添加 @change="handleStatusChange(scope.row)")
const handleStatusChange = async (row) => {
    try {
        // 立即调用API更新状态
        await service.put('/todo/update', { id: row.id, status: row.status });
    } catch (e) {
        ElMessage.error('更新状态失败');
        // 失败时回滚本地状态
        row.status = !row.status;
    }
};

// 9. 修改：删除单个待办事项
// (需要在 template 的删除图标上修改为 @click="handleDelete(scope.row)")
const handleDelete = async (row) => {
    try {
        // 10. 调用后端 "delete" API
        await service.delete(`/todo/delete/${row.id}`);
        // 11. 成功后, 重新加载列表 (而不是本地 splice)
        await loadTodos();
        ElMessage.success('删除成功');
    } catch (e) {
        ElMessage.error('删除失败');
    }
};

// 12. 修改：全部完成
const handleCompleteAll = async () => {
    try {
        await service.put('/todo/completeAll');
        await loadTodos(); // 重新加载
    } catch (e) {
        ElMessage.error('操作失败');
    }
};

// 13. 修改：删除所有
const handleDeleteAll = () => {
    ElMessageBox.confirm(
        '你确定要删除所有待办事项吗？此操作不可恢复。',
        '警告',
        {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning',
        }
    )
    .then(async () => {
        try {
            // 14. 调用后端 "deleteAll" API
            await service.delete('/todo/deleteAll');
            await loadTodos(); // 重新加载
            ElMessage.success('已删除所有待办事项');
        } catch (e) {
            ElMessage.error('清空失败');
        }
    })
    .catch(() => {
        ElMessage.info('已取消删除');
    });
};
</script>

<!--
ljx:使用新的style，替换旧的style

<style scoped>
.el-row {
  margin-bottom: 20px;
}

.grid-content {
  display: flex;
  align-items: center;
  height: 100px;
}

.grid-cont-right {
  flex: 1;
  text-align: center;
  font-size: 14px;
  color: #999;
}

.grid-num {
  font-size: 30px;
  font-weight: bold;
}

.grid-con-icon {
  font-size: 50px;
  width: 100px;
  height: 100px;
  text-align: center;
  line-height: 100px;
  color: #fff;
}

.grid-con-1 .grid-con-icon {
  background: rgb(45, 140, 240);
}

.grid-con-1 .grid-num {
  color: rgb(45, 140, 240);
}

.grid-con-2 .grid-con-icon {
  background: rgb(100, 213, 114);
}

.grid-con-2 .grid-num {
  color: rgb(100, 213, 114);
}

.grid-con-3 .grid-con-icon {
  background: rgb(242, 94, 67);
}

.grid-con-3 .grid-num {
  color: rgb(242, 94, 67);
}

.user-info {
  display: flex;
  align-items: center;
  padding-bottom: 20px;
  border-bottom: 2px solid #ccc;
  margin-bottom: 20px;
}

.user-info-cont {
  padding-left: 50px;
  flex: 1;
  font-size: 14px;
  color: #999;
}

.user-info-cont div:first-child {
  font-size: 30px;
  color: #222;
}

.user-info-list {
  font-size: 14px;
  color: #999;
  line-height: 25px;
}

.user-info-list span {
  margin-left: 70px;
}

.mgb20 {
  margin-bottom: 20px;
}

.todo-item {
  font-size: 14px;
}

.todo-item-del {
  text-decoration: line-through;
  color: #999;
}

.schart {
  width: 100%;
  height: 300px;
}
</style>
-->
<style scoped>
.todo-list-wrapper {
  /* 这个高度是估算的卡片body区域高度。
    你可以根据需要调整 280px 这个值。
  */
  height: 280px; 
  overflow-y: auto; /* 当内容超出高度时，显示Y轴滚动条 */
}

.todo-item-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.todo-delete-icon {
  cursor: pointer;
  color: #f56c6c;
  display: none; /* 默认隐藏 */
}

.todo-item-wrapper:hover .todo-delete-icon {
  display: block;
}

.todo-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.el-row {
  margin-bottom: 20px;
}

.grid-content {
  display: flex;
  align-items: center;
  height: 100px;
}

.grid-cont-right {
  flex: 1;
  text-align: center;
  font-size: 14px;
  color: #999;
}

.grid-num {
  font-size: 30px;
  font-weight: bold;
}

.grid-con-icon {
  font-size: 50px;
  width: 100px;
  height: 100px;
  text-align: center;
  line-height: 100px;
  color: #fff;
}

.grid-con-1 .grid-con-icon {
  background: rgb(45, 140, 240);
}

.grid-con-1 .grid-num {
  color: rgb(45, 140, 240);
}

.grid-con-2 .grid-con-icon {
  background: rgb(100, 213, 114);
}

.grid-con-2 .grid-num {
  color: rgb(100, 213, 114);
}

.grid-con-3 .grid-con-icon {
  background: rgb(242, 94, 67);
}

.grid-con-3 .grid-num {
  color: rgb(242, 94, 67);
}

.user-info {
  display: flex;
  align-items: center;
  padding-bottom: 20px;
  border-bottom: 2px solid #ccc;
  margin-bottom: 20px;
}

.user-info-cont {
  padding-left: 50px;
  flex: 1;
  font-size: 14px;
  color: #999;
}

.user-info-cont div:first-child {
  font-size: 30px;
  color: #222;
}

.user-info-list {
  font-size: 14px;
  color: #999;
  line-height: 25px;
}

.user-info-list span {
  margin-left: 70px;
}

.mgb20 {
  margin-bottom: 20px;
}

.todo-item {
  font-size: 14px;
}

.todo-item-del {
  text-decoration: line-through;
  color: #999;
}

.schart {
  width: 100%;
  height: 300px;
}
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\dashboard.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\deviceManagement.vue ---

<template>
  <div>
    <div class="container">
      <div class="search-box">
        <el-button type="warning" :icon="CirclePlusFilled" @click="handleAdd">
          新增设备
        </el-button>
      </div>
      <el-table
          :data="deviceList"
          border
          class="table"
          header-cell-class-name="table-header"
      >
        <el-table-column prop="id" label="ID" width="55" align="center"></el-table-column>
        <el-table-column prop="name" label="设备名称" align="center"></el-table-column>
        <el-table-column prop="location" label="位置" align="center"></el-table-column>
        <el-table-column prop="status" label="状态" align="center"></el-table-column>
        <el-table-column prop="gmtCreated" label="创建时间" align="center"></el-table-column>

        <el-table-column label="操作" width="180" align="center">
          <template #default="scope">
            <el-button
                type="danger"
                size="small"
                :icon="Delete"
                @click="handleDelete(scope.row.id)"
            >
              删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>

    </div>

    <el-dialog title="新增设备" v-model="dialogVisible" width="30%">
      <el-form :model="newDeviceForm" label-width="80px">
        <el-form-item label="设备名称">
          <el-input v-model="newDeviceForm.name"></el-input>
        </el-form-item>
        <el-form-item label="设备位置">
          <el-input v-model="newDeviceForm.location"></el-input>
        </el-form-item>
        <el-form-item label="初始状态">
          <el-input v-model="newDeviceForm.status" placeholder="例如: online"></el-input>
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="dialogVisible = false">取 消</el-button>
          <el-button type="primary" @click="submitAddDevice">确 定</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts" name="deviceManagement">
import { ref, reactive, onMounted } from "vue";
import { ElMessage, ElMessageBox } from "element-plus";
import { Delete, CirclePlusFilled } from "@element-plus/icons-vue";
import service from '../utils/request';

// 设备接口类型
interface DeviceItem {
  id: number;
  name: string;
  location: string;
  status: string;
  gmtCreated: string;
}

// 设备列表
const deviceList = ref<DeviceItem[]>([]);

// 对话框可见性
const dialogVisible = ref(false);

// 新设备表单
const newDeviceForm = reactive({
  name: "",
  location: "",
  status: "online",
});

// 从后端获取设备数据
const getDeviceData = async () => {
  try {
    const res = await service.get('/device/all'); // 调用后端接口
    if (res.code === '200') {
      deviceList.value = res.data;
    } else {
      ElMessage.error(res.message || '加载设备列表失败');
    }
  } catch (error) {
    ElMessage.error("连接后端失败");
  }
};

// 页面加载时执行
onMounted(() => {
  getDeviceData();
});

// 处理删除
const handleDelete = (id: number) => {
  ElMessageBox.confirm("确定要删除这个设备吗？", "提示", {
    type: "warning",
  })
      .then(async () => {
        // 确认删除
        try {
          const res = await service.delete(`/device/delete/${id}`);
          if (res.code === '200') {
            ElMessage.success("删除成功");
            getDeviceData(); // 刷新列表
          } else {
            ElMessage.error(res.message || '删除失败');
          }
        } catch (error) {
          ElMessage.error("请求失败");
        }
      })
      .catch(() => {
        // 取消删除
      });
};

// 处理新增（打开弹窗）
const handleAdd = () => {
  // ========== 在这里添加权限检查 ==========
  const authority = localStorage.getItem('ms_authority');
  if (authority !== 'admin') {
    ElMessage.error('权限不够，只有管理员才能新增设备');
    return; // 阻止函数继续执行
  }
  // ======================================

  // 重置表单
  newDeviceForm.name = "";
  newDeviceForm.location = "";
  newDeviceForm.status = "online";
  dialogVisible.value = true;
};

// 提交新增设备
const submitAddDevice = async () => {
  try {
    const res = await service.post('/device/add', newDeviceForm);
    if (res.code === '200') {
      ElMessage.success("添加成功");
      dialogVisible.value = false;
      getDeviceData(); // 刷新列表
    } else {
      ElMessage.error(res.message || '添加失败');
    }
  } catch (error) {
    ElMessage.error("请求失败");
  }
};
</script>

<style scoped>
.search-box {
  margin-bottom: 20px;
}
</style>

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\deviceManagement.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\donate.vue ---

<template>
  <div class="container">


  </div>
</template>

<script setup lang="ts" name="donate"></script>

<style></style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\donate.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\editor.vue ---

<template>
    <div class="container">

        <div style="border: 1px solid #ccc; margin-bottom: 10px">
            <Toolbar style="border-bottom: 1px solid #ccc" :editor="editorRef" :defaultConfig="toolbarConfig" />
            <Editor
                style="height: 500px; overflow-y: hidden"
                v-model="valueHtml"
                :defaultConfig="editorConfig"
                @onCreated="handleCreated"
            />
        </div>
        <el-button type="primary" @click="syncHTML">提交</el-button>
    </div>
</template>

<script setup lang="ts" name="editor">
import '@wangeditor/editor/dist/css/style.css'; // 引入 css
import { onBeforeUnmount, ref, reactive, shallowRef, onMounted } from 'vue';
import { Editor, Toolbar } from '@wangeditor/editor-for-vue';
// 编辑器实例，必须用 shallowRef
const editorRef = shallowRef();

// 内容 HTML
const valueHtml = ref('<p>hello</p>');

// 模拟 ajax 异步获取内容
onMounted(() => {
    setTimeout(() => {
        valueHtml.value = '<p>模拟 Ajax 异步设置内容</p>';
    }, 1500);
});

const toolbarConfig = {};
const editorConfig = { placeholder: '请输入内容...' };

// 组件销毁时，也及时销毁编辑器
onBeforeUnmount(() => {
    const editor = editorRef.value;
    if (editor == null) return;
    editor.destroy();
});

const handleCreated = (editor: any) => {
    editorRef.value = editor; // 记录 editor 实例，重要！
};
const syncHTML = () => {
    console.log(valueHtml.value);
};
</script>

<style></style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\editor.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\home.vue ---

<template>
	<v-header />
	<v-sidebar />
	<div class="content-box" :class="{ 'content-collapse': sidebar.collapse }">
		<v-tags></v-tags>
		<div class="content">
			<router-view v-slot="{ Component }">
				<transition name="move" mode="out-in">
					<keep-alive :include="tags.nameList">
						<component :is="Component"></component>
					</keep-alive>
				</transition>
			</router-view>
		</div>
	</div>
</template>
<script setup lang="ts">
import { useSidebarStore } from '../store/sidebar';
import { useTagsStore } from '../store/tags';
import vHeader from '../components/header.vue';
import vSidebar from '../components/sidebar.vue';
import vTags from '../components/tags.vue';

const sidebar = useSidebarStore();
const tags = useTagsStore();
</script>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\home.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\JingYin.vue ---

<template>
  <el-container class="layout-container-demo" style="height: 100%">
    <el-container>
      <div style="display:block">
        <el-table
            :data="state.tableData"
            style="width: 100%; font-size: 20px; display: block; color: black"
            :row-class-name="tableRowClassName"
            :header-cell-style="{color:'black'}"
        >

          <el-table-column prop="humidity" label="湿度" width="180px" align="center" style="color: black"/>
          <el-table-column prop="temperature" label="最高温度" width="180px" align="center"/>
          <el-table-column prop="fire" label="是否存在火源" width="180px" align="center"/>
          <el-table-column prop="smoke" label="烟雾浓度" width="180px" align="center"/>
          <el-table-column prop="co" label="有害气体浓度" width="180px" align="center"/>
          <el-table-column prop="risk" label="火灾风险" width="180px" align="center"/>
        </el-table>
      </div>

    </el-container>
    <div class="example-pagination-block"
         style="padding-left: 10px; width: 100px;height: 50px; position: absolute; left: 10px ; bottom: 250px ">
      <div class="example-demonstration"></div>
      <el-pagination layout="prev, pager, next" :total="50" page-count="10" @current-change="handleCurrentChange"/>
    </div>

  </el-container>
</template>

<script setup lang="ts">
import {reactive, ref, onMounted} from "vue";
import service from "../utils/request";
import {ElNotification} from 'element-plus'

interface environment {
  humidity: number;
  temperature: number;
  fire: number;
  smoke: number;
  co: number;
  risk: number;
}

let humidity; //8
let temperature; //50
let fire; //0
let smoke; //8
let co; //20
let risk; //0
const state = reactive({
  tableData: [],
  form: {},
});
const activeIndex = ref("1");
const activeIndex2 = ref("1");
const count = ref(0);

const tableRowClassName = ({
                             row,
                             rowIndex,
                           }: {
  row: environment;
  rowIndex: number;
}) => {
  if (row.risk === 1 || row.co > 20 || row.fire === 1) {
    return "warning-row";
  }


  return "";
};

// 请求后台数据
const load = () => {
  service.get('/environment/getTheLatest').then((res) => {
    const newData = res.data;
    // 清空表格数据
    state.tableData = [];
    // 将获得的五条数据添加到表格数据中
    for (let i = 0; i < newData.length; i++) {
      state.tableData.push(newData[i]);
    }
    // 更新数据到界面
    humidity = state.tableData[state.tableData.length - 1].humidity;
    temperature = state.tableData[state.tableData.length - 1].temperature;
    fire = state.tableData[state.tableData.length - 1].fire;
    smoke = state.tableData[state.tableData.length - 1].smoke;
    co = state.tableData[state.tableData.length - 1].co;
    risk = state.tableData[state.tableData.length - 1].risk;
  });
};

// 初始加载数据
onMounted(() => {
  load();
});

// 每三秒刷新一次数据
setInterval(() => {
  state.tableData.shift();
  state.tableData.shift();
  state.tableData.shift();
  state.tableData.shift();
  state.tableData.shift();
  load();
  if (humidity > 80 || temperature > 50 || fire === 1 || smoke > 80 || co > 20 || risk === 1) {
    ElNotification({
      title: 'Warning',
      message: '有火情',
      type: 'error',
    })
  }
}, 10000);

// 处理分页变化
const handleCurrentChange = (val) => {
  // 这里添加处理分页变化的逻辑，你可以在这个函数中重新加载数据
  // 例如：每次加载五条数据，根据当前页数计算加载的起始索引，然后获取对应数据
}
</script>

<style>
.el-table .warning-row {
  --el-table-tr-bg-color: var(--el-color-warning-light-9);
  background-color: #cc0033;
  color: #cccccc;
}

.el-table .success-row {
  --el-table-tr-bg-color: var(--el-color-success-light-9);
}
</style>

<style scoped>
.layout-container-demo .el-header {
  position: relative;
  color: var(--el-text-color-primary);
  width: 100%;
}

.layout-container-demo .el-aside {
  color: var(--el-text-color-primary);
}

.layout-container-demo .el-menu {
  border-right: none;
}

.layout-container-demo .el-main {
  padding: 0;
}

.layout-container-demo .toolbar {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  right: 20px;
}
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\JingYin.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\login.vue ---

<template>
  <div class="login-wrap">
    <div class="ms-login">
      <div class="ms-title">{{ isRegister ? '注册新用户' : '后台管理系统' }}</div>
      <el-form :model="param" :rules="rules" ref="loginFormRef" label-width="0px" class="ms-content">

        <el-form-item prop="username">
          <el-input v-model="param.username" placeholder="用户名">
            <template #prepend>
              <el-button :icon="User"></el-button>
            </template>
          </el-input>
        </el-form-item>

        <el-form-item prop="password">
          <el-input
              type="password"
              placeholder="密码"
              v-model="param.password"
              @keyup.enter="handleSubmit(loginFormRef)"
          >
            <template #prepend>
              <el-button :icon="Lock"></el-button>
            </template>
          </el-input>
        </el-form-item>

        <el-form-item v-if="isRegister" prop="confirmPassword">
          <el-input
              type="password"
              placeholder="确认密码"
              v-model="param.confirmPassword"
              @keyup.enter="handleSubmit(loginFormRef)"
          >
            <template #prepend>
              <el-button :icon="Lock"></el-button>
            </template>
          </el-input>
        </el-form-item>

        <el-form-item v-if="isRegister" prop="e_mail">
          <el-input v-model="param.e_mail" placeholder="邮箱 (e_mail)">
            <template #prepend><el-button :icon="Message"></el-button></template>
          </el-input>
        </el-form-item>

        <el-form-item v-if="isRegister" prop="phone">
          <el-input v-model="param.phone" placeholder="电话 (phone)">
            <template #prepend><el-button :icon="Phone"></el-button></template>
          </el-input>
        </el-form-item>

        <el-form-item v-if="isRegister" prop="sex">
          <el-select v-model="param.sex" placeholder="请选择性别" style="width: 100%">
            <template #prefix>
              <el-icon class="el-input__icon"><Male /></el-icon>
            </template>
            <el-option key="unknown" label="未知" value="未知"></el-option>
            <el-option key="male" label="男" value="男"></el-option>
            <el-option key="female" label="女" value="女"></el-option>
          </el-select>
        </el-form-item>

        <el-form-item v-if="isRegister" prop="age">
          <el-input v-model="param.age" placeholder="年龄 (age)" type="number">
            <template #prepend><el-button :icon="InfoFilled"></el-button></template>
          </el-input>
        </el-form-item>

        <el-form-item v-if="isRegister" prop="address">
          <el-input v-model="param.address" placeholder="地址 (address)">
            <template #prepend><el-button :icon="Location"></el-button></template>
          </el-input>
        </el-form-item>

        <div class="login-btn">
          <el-button type="primary" @click="handleSubmit(loginFormRef)">
            {{ isRegister ? '注册' : '登录' }}
          </el-button>
        </div>

        <div class="login-tips-right">
          <el-link type="primary" @click="toggleRegister">
            {{ isRegister ? '已有账户？去登录' : '没有账户？去注册' }}
          </el-link>
        </div>
      </el-form>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { useTagsStore } from '../store/tags';
// 1. 【导入新 Store】
import { useUserStore } from '../store/userStore';
import { useRouter } from 'vue-router';
import { ElMessage } from 'element-plus';
import type { FormInstance, FormRules } from 'element-plus';
import service from '../utils/request';
// 2. 【导入新图标】
import { Lock, User, Message, Phone, Male, InfoFilled, Location } from '@element-plus/icons-vue';

// 登录/注册状态切换
const isRegister = ref(false);

const router = useRouter();
// 3. 【更新 param】
const param = reactive({
  username: '',
  password: '',
  confirmPassword: '',
  e_mail: '',
  phone: '',
  sex: '未知', // 默认值
  age: '',
  address: '',
});

// 确认密码的验证器
const validatePassConfirm = (rule: any, value: any, callback: any) => {
  if (value === '') {
    callback(new Error('请再次输入密码'));
  } else if (value !== param.password) {
    callback(new Error('两次输入密码不一致!'));
  } else {
    callback();
  }
};

// 4. 【更新 rules】
const rules = reactive<FormRules>({
  username: [
    { required: true, message: '请输入用户名', trigger: 'blur' },
  ],
  password: [
    { required: true, message: '请输入密码', trigger: 'blur' },
    { min: 6, message: '密码长度不能少于6位', trigger: 'blur' }
  ],
  confirmPassword: [
    { required: true, validator: validatePassConfirm, trigger: 'blur' }
  ],
  e_mail: [
    { required: true, message: '请输入邮箱地址', trigger: 'blur' },
    { message: '请输入正确的邮箱格式', trigger: ['blur', 'change'] }
  ],
  phone: [
    { required: true, message: '请输入电话号码', trigger: 'blur' }
  ],
});

const loginFormRef = ref<FormInstance>();
// 5. 【使用新 Store】
const userStore = useUserStore();

// 切换登录/注册模式
const toggleRegister = () => {
  isRegister.value = !isRegister.value;
  loginFormRef.value?.resetFields();
};

// 统一的提交处理
const handleSubmit = (formEl: FormInstance | undefined) => {
  if (!formEl) return;
  formEl.validate((valid: boolean) => {
    if (valid) {
      if (isRegister.value) {
        submitRegister(); // 调用注册
      } else {
        submitLogin(); // 调用登录
      }
    } else {
      ElMessage.error('表单验证失败');
      return false;
    }
  });
};

// 6. 【新的登录逻辑】
const submitLogin = async () => {
  try {
    const res = await service.post('/user/login', {
      name: param.username,
      password: param.password
    });
    if (res.code === '200') {
      ElMessage.success('登录成功');
      const userData = res.data;

      localStorage.setItem('ms_username', userData.name);

      // 【核心】调用新 Store 的 Action
      userStore.setAuthority(userData.authority || 'user');

      router.push('/');
    } else {
      ElMessage.error(res.message || '登录失败');
    }
  } catch (error) {
    console.error(error);
    ElMessage.error('登录请求失败，请检查后端服务。');
  }
};

// 7. 【新的注册逻辑】
const submitRegister = async () => {
  try {
    const res = await service.post('/user/register', {
      name: param.username,
      password: param.password,
      eMail: param.eMail,
      phone: param.phone,
      sex: param.sex,
      age: param.age ? parseInt(param.age) : 0, // 确保 age 是数字
      address: param.address
      // authority 将由后端自动设为 'user'
    });
    if (res.code === '200') {
      ElMessage.success('注册成功！请登录。');
      isRegister.value = false; // 自动切换回登录界面
      loginFormRef.value?.resetFields(); // 清空表单
    } else {
      ElMessage.error(res.message || '注册失败');
    }
  } catch (error) {
    console.error(error);
    ElMessage.error('注册请求失败，请检查后端服务是否运行。');
  }
};

const tags = useTagsStore();
tags.clearTags();
</script>

<style scoped>
/* (样式保持不变) */
.login-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  background-image: url(../assets/img/login-bg.jpg);
  background-size: 100%;
}
.ms-title {
  line-height: 50px;
  text-align: center;
  font-size: 20px;
  color: #333;
  font-weight: bold;
  padding-top: 10px;
}
.ms-login {
  width: 350px;
  border-radius: 5px;
  background: #fff;
}
.ms-content {
  padding: 10px 30px 30px;
}
.login-btn {
  text-align: center;
}
.login-btn button {
  width: 100%;
  height: 36px;
  margin-bottom: 10px;
}
.login-tips-right {
  font-size: 12px;
  color: #333;
  text-align: right;
}
</style>

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\login.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\map.vue ---

<template>

 <div class="map">
   <img  src="../img/map.png" :key="imageKey">/>
 </div>
</template>

<style>
.map{

  height: 60px;
  width: 60px;
}
</style>
<script>
import { ref, onMounted } from "vue";

export default {
  setup() {
    const imageSrc = ref("");
    const imageKey = ref("");
    const load = () => {
      // Appending a timestamp to force the browser to reload the image
      imageSrc.value = `../img/map.png?timestamp=${new Date().getTime()}`;
      imageKey.value = new Date().getTime();
    };

    onMounted(() => {
      load(); // Initial load
      // Set interval to update the image source every 100ms
      setInterval(() => {
        location.reload();
        console.log("refresh")
      }, 3000);
    });

    return {
      imageSrc,
    };
  },
};
</script>

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\map.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\monitor.vue ---

<template>
  <div class="container">
    <el-image class="heart" style="width: 100px; height: 100px ; display: inline ; position: absolute" :src="urlHeart"
              :fit="fit "/>
    <sign class="chart"></sign>
    <img class="breath" style="width: 115px; height: 90px ; display: inline ; position: absolute" src="../img/nose.gif"/>
    <heat class="chart"></heat>
    <breath class="chart"></breath>
    <div class="chart">
      <el-card :style="{ width: '480px', margin: '30px', color: distanceColor }" shadow="hover">{{
          distanceContent
        }}
      </el-card>
      <el-card :style="{ width: '480px', margin: '30px', color: actionColor }" shadow="hover">{{
          actionContent
        }}
      </el-card>
      <el-card :style="{ width: '480px', margin: '30px', color: warningColor }" shadow="hover">{{
          warningContent
        }}
      </el-card>
    </div>
  </div>
</template>

<script setup lang="ts">
import {ref, onMounted} from 'vue';
import sign from '../charts/signalChart.vue'
import heat from '../charts/heatRateChart.vue'
import breath from '../charts/breathRateChart.vue'
import service from "../utils/request";

const fit = ['fill', 'contain', 'cover', 'none', 'scale-down']
const urlHeart = 'https://www.bing.com/th/id/OGC.f7cd7f65fa8e2f5802dfd72331b41bd9?pid=1.7&rurl=https%3a%2f%2fwimg.588ku.com%2fgif%2f20%2f08%2f03%2f89debc955a204f3ef20ca5c7192dbc2e.gif&ehk=iGwXJVDKxVEosD3vWAtCOXDVvqgtqx2vf1slUpJcHeY%3d'
const urlBreath = '../img/nose.gif'
const actionContent = ref("Initial content");
const warningContent = ref("Initial content");
const distanceContent = ref("Initial content");

const actionColor = ref("black");
const warningColor = ref("black");
const distanceColor = ref("black");

let distance;
let active;

const load = () => {
  service.get('/vital/getTheLatest').then((res) => {
    distance = res.data.distance;
    active = res.data.active;
  });
};

onMounted(() => {
  // 设置定时器每秒更新一次数据
  setInterval(() => {
    load();

    // 随机切换 actionContent 和 warningContent 的值
    const actionValues = {
      0: {value: "无人", color: "black"},
      1: {value: "静息", color: "#00c4ff"},
      2: {value: "安静", color: "#4bfc4e"},
      3: {value: "动作", color: "#ffa02c"},
      4: {value: "持续动作", color: "red"}
    };

    const warningValues = ["正常", "异常"];
    actionContent.value = actionValues[active].value;
    //设置为设备状态正常
    warningContent.value = warningValues[0];

    // 设置字体颜色
    actionColor.value = actionValues[active].color;
    warningColor.value = warningContent.value === "异常" ? "red" : "black";

    // 随机生成距离，保留一位小数，范围在 0 到 10 之间
    distanceContent.value = `距离: ${distance} cm`;
    distanceColor.value = "black"; // 默认将字体颜色设置为黑色
  }, 1000);
});
</script>

<style>
.chart {
  margin-top: 10px;
  width: 45%;
  height: 45%;
}

.container {
  width: 100%;
  height: 100%;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between
}

.heart {
  right: 27%;
  top: 5%;
}

.breath {
  border-radius: 20px;
  left: 9%;
  bottom:40%;

}
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\monitor.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\permission.vue ---

<template>
	<div class="container">
		<div class="plugins-tips">通过 v-permiss 自定义指令实现权限管理，使用非 admin 账号登录，可查看效果。</div>
		<div class="mgb20">
			<span class="label">角色：</span>
			<el-select v-model="role" @change="handleChange">
				<el-option label="超级管理员" value="admin"></el-option>
				<el-option label="普通用户" value="user"></el-option>
			</el-select>
		</div>
		<div class="mgb20 tree-wrapper">
			<el-tree
				ref="tree"
				:data="data"
				node-key="id"
				default-expand-all
				show-checkbox
				:default-checked-keys="checkedKeys"
			/>
		</div>
		<el-button type="primary" @click="onSubmit">保存权限</el-button>
	</div>
</template>

<script setup lang="ts" name="permission">
import { ref } from 'vue';
import { ElTree } from 'element-plus';
const role = ref<string>('admin');

interface Tree {
	id: string;
	label: string;
	children?: Tree[];
}

const data: Tree[] = [
	{
		id: '1',
		label: '系统首页'
	},
	{
		id: '2',
		label: '基础表格',
		children: [
			{
				id: '15',
				label: '编辑'
			},
			{
				id: '16',
				label: '删除'
			}
		]
	},
	{
		id: '3',
		label: 'tab选项卡'
	},
	{
		id: '4',
		label: '表单相关',
		children: [
			{
				id: '5',
				label: '基本表单'
			},
			{
				id: '6',
				label: '文件上传'
			},
			{
				id: '7',
				label: '三级菜单',
				children: [
					{
						id: '8',
						label: '富文本编辑器'
					},
					{
						id: '9',
						label: 'markdown编辑器'
					}
				]
			}
		]
	},
	{
		id: '10',
		label: '自定义图标'
	},
	{
		id: '11',
		label: 'schart图表'
	},

	{
		id: '13',
		label: '权限管理'
	},
	{
		id: '14',
		label: '支持作者'
	}
];

const permiss = usePermissStore();

// 获取当前权限
const checkedKeys = ref<string[]>([]);
const getPremission = () => {
	// 请求接口返回权限
	checkedKeys.value = permiss.defaultList[role.value];
};
getPremission();

// 保存权限
const tree = ref<InstanceType<typeof ElTree>>();
const onSubmit = () => {
	// 获取选中的权限
	console.log(tree.value!.getCheckedKeys(false));
};

const handleChange = (val: string[]) => {
	tree.value!.setCheckedKeys(permiss.defaultList[role.value]);
};
</script>

<style scoped>
.tree-wrapper {
	max-width: 500px;
}
.label {
	font-size: 14px;
}
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\permission.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\table.vue ---

<template>
  <div>
    <div class="container">
      <div class="search-box">
        <el-input
            v-model="query.name"
            placeholder="用户名"
            class="search-input mr10"
            clearable
        ></el-input>
        <el-button
            type="warning"
            :icon="CirclePlusFilled"
            @click="handleAdd"
        >新增
        </el-button
        >
      </div>
      <el-table
          :data="tableData"
          border
          class="table"
          ref="multipleTable"
          header-cell-class-name="table-header"
      >
        <el-table-column
            prop="id"
            label="ID"
            width="55"
            align="center"
        ></el-table-column>
        <el-table-column
            prop="name"
            label="用户名"
            align="center"
        ></el-table-column>
        <el-table-column label="邮箱" prop="e_mail" align="center">
        </el-table-column>
        <el-table-column label="电话号码" prop="phone" align="center">
        </el-table-column>
        <el-table-column label="权限" prop="authority" align="center">
        </el-table-column>
        <el-table-column
            prop="address"
            label="地址"
            align="center"
        ></el-table-column>

        <el-table-column
            prop="gmtCreated"
            label="注册时间"
            align="center"
        ></el-table-column>

        <el-table-column label="操作" width="280" align="center">
          <template #default="scope">
            <el-button
                type="warning"
                size="small"
                :icon="View"
                @click="handleView(scope.row)"
            >
              查看
            </el-button>
            <el-button
                type="primary"
                size="small"
                :icon="Edit"
                @click="handleEdit(scope.$index, scope.row)"
                v-permiss="15"
            >
              编辑
            </el-button>
          </template>
        </el-table-column>
      </el-table>
      <div class="pagination">
        <el-pagination
            background
            layout="total, prev, pager, next"
            :current-page="query.pageIndex"
            :page-size="query.pageSize"
            :total="pageTotal"
            @current-change="handlePageChange"
        ></el-pagination>
      </div>
    </div>

    <el-dialog
        :title="idEdit ? '编辑用户' : '新增用户'"
        v-model="visible"
        width="30%"
        @close="closeDialog"
        destroy-on-close
    >
      <table-edit
          :data="rowData"
          :edit="idEdit"
          :update="updateData"
      ></table-edit>
    </el-dialog>

    <el-dialog title="查看详情" v-model="visible1" width="30%">
      <table-detail :data="rowData"></table-detail>
    </el-dialog>

  </div>
</template>

<script setup lang="ts" name="basetable">
import { ref, reactive } from "vue";
import { ElMessage, ElMessageBox } from "element-plus";
import {
  Delete,
  Edit,
  Search,
  CirclePlusFilled,
  View,
} from "@element-plus/icons-vue";

// 导入我们需要的组件和 service
import TableEdit from '../components/table-edit.vue';
import TableDetail from '../components/table-detail.vue';
import service from '../utils/request';


interface TableItem {
  id: number;
  name: string;
  e_mail: string;
  phone: string;
  authority: string; // 确保类型匹配
  address: string;
  gmtCreated: string; // 确保这个字段名和后端返回的一致
}

const query = reactive({
  address: "",
  name: "",
  pageIndex: 1,
  pageSize: 10,
});

const tableData = ref<TableItem[]>([]);
const pageTotal = ref(0);
const visible = ref(false);
let idx: number = -1;
const idEdit = ref(false);
const rowData = ref<TableItem>();
const visible1 = ref(false);


const getData = async () => {
  try {
    // 请求后端的 /user/userPage 接口，并传入分页参数
    const res = await service.get('/user/userPage', {
      params: {
        pageNum: query.pageIndex,
        size: query.pageSize
      }
    });

    // 你的后端 /userPage 接口返回的数据结构是 { code: "200", data: { total: ..., data: [...] } }
    if (res.code === '200') {
      tableData.value = res.data.data;  // 列表数据
      pageTotal.value = res.data.total; // 总数
    } else {
      ElMessage.error(res.message || '加载数据失败');
    }
  } catch (error) {
    console.error("获取真实数据失败", error);
    ElMessage.error("后端数据加载失败");
  }
};
// ===============================================


const handleSearch = () => {
  query.pageIndex = 1;
  getData();
};
const handlePageChange = (val: number) => {
  query.pageIndex = val;
  getData();
};


const handleEdit = (index: number, row: TableItem) => {
  idx = index;
  rowData.value = { ...row }; // 使用副本以防取消时修改
  idEdit.value = true;
  visible.value = true;
};

// 【已更新】包含 "新增" 和 "编辑" 的数据库逻辑
const updateData = async (row: TableItem) => {
  if (idEdit.value) {
    // 【编辑用户】的逻辑
    try {
      await service.put('/user/updateUser', row);
      ElMessage.success('修改成功');
      getData(); // 重新加载数据
    } catch (error) {
      console.error(error);
      ElMessage.error('修改失败');
    }
  } else {
    // 【新增用户】的逻辑
    try {
      await service.post('/user/insertUser', row);
      ElMessage.success('新增成功');
      getData(); // Geluidsdata
    } catch (error) {
      console.error(error);
      ElMessage.error('新增失败');
    }
  }
  closeDialog();
};

const closeDialog = () => {
  visible.value = false;
  idEdit.value = false;
};


const handleView = (row: TableItem) => {
  rowData.value = row;
  visible1.value = true;
};

// 【已更新】新增时，清空表单
const handleAdd = () => {
  // ========== 在这里添加权限检查 ==========
  const authority = localStorage.getItem('ms_authority');
  if (authority !== 'admin') {
    ElMessage.error('权限不够，只有管理员才能新增用户');
    return; // 阻止函数继续执行
  }
  // ======================================

  rowData.value = {} as TableItem; // 清空表单
  idEdit.value = false;
  visible.value = true;
};

// 页面加载时获取数据
getData();

</script>

<style scoped>
.search-box {
  margin-bottom: 20px;
}

.search-input {
  width: 200px;
}

.mr10 {
  margin-right: 10px;
}

.table-td-thumb {
  display: block;
  margin: auto;
  width: 40px;
  height: 40px;
}
</style>

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\table.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\tabs.vue ---

<template>
  <div class="container">
    <el-tabs v-model="message">
      <el-tab-pane :label="`未读消息(${state.unread.length})`" name="first">
        <el-table :data="state.unread" :show-header="false" style="width: 100%">
          <el-table-column>
            <template #default="scope">
              <span class="message-title">{{ scope.row.title }}</span>
            </template>
          </el-table-column>
          <el-table-column prop="messageTime" width="180"></el-table-column> <el-table-column width="120">
          <template #default="scope">
            <el-button size="small" @click="handleRead(scope.row.id, scope.$index)">标为已读</el-button>
          </template>
        </el-table-column>
        </el-table>
        <div class="handle-row">
          <el-button type="primary" @click="handleReadAll">全部标为已读</el-button>
        </div>
      </el-tab-pane>

      <el-tab-pane :label="`已读消息(${state.read.length})`" name="second">
        <template v-if="message === 'second'">
          <el-table :data="state.read" :show-header="false" style="width: 100%">
            <el-table-column>
              <template #default="scope">
                <span class="message-title">{{ scope.row.title }}</span>
              </template>
            </el-table-column>
            <el-table-column prop="messageTime" width="180"></el-table-column> <el-table-column width="120">
            <template #default="scope">
              <el-button type="danger" size="small" @click="handleDel(scope.row.id, scope.$index)">删除</el-button>
            </template>
          </el-table-column>
          </el-table>
          <div class="handle-row">
            <el-button type="danger" @click="handleRecycleAllRead">删除全部</el-button>
          </div>
        </template>
      </el-tab-pane>

      <el-tab-pane :label="`回收站(${state.recycle.length})`" name="third">
        <template v-if="message === 'third'">
          <el-table :data="state.recycle" :show-header="false" style="width: 100%">
            <el-table-column>
              <template #default="scope">
                <span class="message-title">{{ scope.row.title }}</span>
              </template>
            </el-table-column>
            <el-table-column prop="messageTime" width="180"></el-table-column> <el-table-column width="120">
            <template #default="scope">
              <el-button size="small" @click="handleRestore(scope.row.id, scope.$index)">还原</el-button>
            </template>
          </el-table-column>
          </el-table>
          <div class="handle-row">
            <el-button type="danger" @click="handleEmptyRecycle">清空回收站</el-button>
          </div>
        </template>
      </el-tab-pane>
    </el-tabs>
  </div>
</template>

<script setup lang="ts" name="tabs">
import { ref, reactive, onMounted } from 'vue'; // 导入 onMounted
import { ElMessage } from 'element-plus';
import service from '../utils/request'; // 导入 service

const message = ref('first');
const state = reactive({
  unread: [],
  read: [],
  recycle: []
});

// 1. 从后端获取所有数据
const getData = async () => {
  try {
    const res = await service.get('/message/all');
    if (res.code === '200') {
      state.unread = res.data.unread || [];
      state.read = res.data.read || [];
      state.recycle = res.data.recycle || [];
    } else {
      ElMessage.error(res.message || '加载消息失败');
    }
  } catch (error) {
    ElMessage.error('连接后端失败');
  }
};

// 在组件挂载时自动加载数据
onMounted(() => {
  getData();
});

// 2. 标为已读 (0 -> 1)
const handleRead = async (id: number, index: number) => {
  try {
    const res = await service.put(`/message/read/${id}`);
    if (res.code === '200') {
      const item = state.unread.splice(index, 1);
      state.read = item.concat(state.read);
    } else {
      ElMessage.error(res.message || '操作失败');
    }
  } catch (error) {
    ElMessage.error('请求失败');
  }
};

// 3. 删除到回收站 (1 -> 2)
const handleDel = async (id: number, index: number) => {
  try {
    const res = await service.put(`/message/recycle/${id}`);
    if (res.code === '200') {
      const item = state.read.splice(index, 1);
      state.recycle = item.concat(state.recycle);
    } else {
      ElMessage.error(res.message || '删除失败');
    }
  } catch (error) {
    ElMessage.error('请求失败');
  }
};

// 4. 从回收站还原 (2 -> 1)
const handleRestore = async (id: number, index: number) => {
  try {
    const res = await service.put(`/message/restore/${id}`);
    if (res.code === '200') {
      const item = state.recycle.splice(index, 1);
      state.read = item.concat(state.read);
    } else {
      ElMessage.error(res.message || '还原失败');
    }
  } catch (error) {
    ElMessage.error('请求失败');
  }
};

// 5. 全部标为已读 (0 -> 1)
const handleReadAll = async () => {
  try {
    const res = await service.put('/message/read-all');
    if (res.code === '200') {
      ElMessage.success('全部已读');
      getData(); // 重新加载数据
    } else {
      ElMessage.error(res.message || '操作失败');
    }
  } catch (error) {
    ElMessage.error('请求失败');
  }
};

// 6. 删除全部已读 (1 -> 2)
const handleRecycleAllRead = async () => {
  try {
    const res = await service.put('/message/recycle-all-read');
    if (res.code === '200') {
      ElMessage.success('删除全部');
      getData(); // 重新加载数据
    } else {
      ElMessage.error(res.message || '操作失败');
    }
  } catch (error) {
    ElMessage.error('请求失败');
  }
};

// 7. 清空回收站 (DELETE status 2)
const handleEmptyRecycle = async () => {
  try {
    const res = await service.delete('/message/recycle-bin');
    if (res.code === '200') {
      ElMessage.success('已清空');
      getData(); // 重新加载数据
    } else {
      ElMessage.error(res.message || '操作失败');
    }
  } catch (error) {
    ElMessage.error('请求失败');
  }
};

</script>

<style>
.message-title {
  cursor: pointer;
}

.handle-row {
  margin-top: 30px;
}
</style>

--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\tabs.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\user.vue ---

<template>
  <div>
    <el-row :gutter="20">
      <el-col :span="12">
        <el-card shadow="hover">
          <template #header>
            <div class="clearfix">
              <span>基础信息</span>
            </div>
          </template>
          <div class="info">
            <div class="info-image" @click="showDialog">
              <el-avatar :size="100" :src="avatarImg" />
              <span class="info-edit">
                <i class="el-icon-lx-camerafill"></i>
              </span>
            </div>
            <div class="info-name">{{ name }}</div>
          </div>
        </el-card>
      </el-col>
      <el-col :span="12">
        <el-card shadow="hover">
          <template #header>
            <div class="clearfix">
              <span>账户编辑</span>
            </div>
          </template>
          <el-form label-width="90px">
            <el-form-item label="用户名："> {{ name }} </el-form-item>
            <el-form-item label="旧密码：">
              <el-input type="password" v-model="form.old"></el-input>
            </el-form-item>
            <el-form-item label="新密码：">
              <el-input type="password" v-model="form.new"></el-input>
            </el-form-item>
            <el-form-item label="个人简介：">
              <el-input v-model="form.desc"></el-input>
            </el-form-item>
            <el-form-item>
              <el-button type="primary" @click="onSubmit">保存</el-button>
            </el-form-item>
          </el-form>
        </el-card>
      </el-col>
    </el-row>
    <el-dialog title="裁剪图片" v-model="dialogVisible" width="600px">
      <vue-cropper
        ref="cropper"
        :src="imgSrc"
        :ready="cropImage"
        :zoom="cropImage"
        :cropmove="cropImage"
        style="width: 100%; height: 400px"
      ></vue-cropper>

      <template #footer>
        <span class="dialog-footer">
          <el-button class="crop-demo-btn" type="primary"
            >选择图片
            <input
              class="crop-input"
              type="file"
              name="image"
              accept="image/*"
              @change="setImage"
            />
          </el-button>
          <el-button type="primary" @click="saveAvatar">上传并保存</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts" name="user">
import { reactive, ref } from "vue";
import VueCropper from "vue-cropperjs";
import "cropperjs/dist/cropper.css";
import avatar from "../assets/img/img.jpg";

const name = localStorage.getItem("ms_username");
const form = reactive({
  old: "",
  new: "",
  desc: "不可能！我的代码怎么可能会有bug！",
});
const onSubmit = () => {};

const avatarImg = ref(avatar);
const imgSrc = ref("");
const cropImg = ref("");
const dialogVisible = ref(false);
const cropper: any = ref();

const showDialog = () => {
  dialogVisible.value = true;
  imgSrc.value = avatarImg.value;
};

const setImage = (e: any) => {
  const file = e.target.files[0];
  if (!file.type.includes("image/")) {
    return;
  }
  const reader = new FileReader();
  reader.onload = (event: any) => {
    dialogVisible.value = true;
    imgSrc.value = event.target.result;
    cropper.value && cropper.value.replace(event.target.result);
  };
  reader.readAsDataURL(file);
};

const cropImage = () => {
  cropImg.value = cropper.value.getCroppedCanvas().toDataURL();
};

const saveAvatar = () => {
  avatarImg.value = cropImg.value;
  dialogVisible.value = false;
};
</script>

<style scoped>
.info {
  text-align: center;
  padding: 35px 0;
}
.info-image {
  position: relative;
  margin: auto;
  width: 100px;
  height: 100px;
  background: #f8f8f8;
  border: 1px solid #eee;
  border-radius: 50px;
  overflow: hidden;
}

.info-edit {
  display: flex;
  justify-content: center;
  align-items: center;
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  opacity: 0;
  transition: opacity 0.3s ease;
}
.info-edit i {
  color: #eee;
  font-size: 25px;
}
.info-image:hover .info-edit {
  opacity: 1;
}
.info-name {
  margin: 15px 0 10px;
  font-size: 24px;
  font-weight: 500;
  color: #262626;
}
.crop-demo-btn {
  position: relative;
}
.crop-input {
  position: absolute;
  width: 100px;
  height: 40px;
  left: 0;
  top: 0;
  opacity: 0;
  cursor: pointer;
}
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\user.vue ---

--- START OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\WanDaMao.vue ---

<template>
  <el-container class="layout-container-demo" style="height: 100%">
    <el-container>
      <div style="display:block">
        <el-table
            :data="state.tableData"
            style="width: 100%; font-size: 20px; display: block; color: black"
            :row-class-name="tableRowClassName"
            :header-cell-style="{color:'black'}"
        >

          <el-table-column prop="humidity" label="湿度" width="180px" align="center" style="color: black"/>
          <el-table-column prop="temperature" label="最高温度" width="180px" align="center"/>
          <el-table-column prop="fire" label="是否存在火源" width="180px" align="center"/>
          <el-table-column prop="smoke" label="烟雾浓度" width="180px" align="center"/>
          <el-table-column prop="co" label="有害气体浓度" width="180px" align="center"/>
          <el-table-column prop="risk" label="火灾风险" width="180px" align="center"/>
        </el-table>
      </div>

    </el-container>
    <div class="example-pagination-block"
         style="padding-left: 10px; width: 100px;height: 50px; position: absolute; left: 10px ; bottom: 250px ">
      <div class="example-demonstration"></div>
      <el-pagination layout="prev, pager, next" :total="50" page-count="10" @current-change="handleCurrentChange"/>
    </div>

  </el-container>
</template>

<script setup lang="ts">
import {reactive, ref, onMounted} from "vue";
import service from "../utils/request";
import {ElNotification} from 'element-plus'
import {color} from "echarts";

interface environment {
  humidity: number;
  temperature: number;
  fire: number;
  smoke: number;
  co: number;
  risk: number;
}

let humidity; //8
let temperature; //50
let fire; //0
let smoke; //8
let co; //20
let risk; //0
const state = reactive({
  tableData: [],
  form: {},
});
const activeIndex = ref("1");
const activeIndex2 = ref("1");
const count = ref(0);

const tableRowClassName = ({
                             row,
                             rowIndex,
                           }: {
  row: environment;
  rowIndex: number;
}) => {
  if (row.risk === 1 || row.co > 20 || row.fire === 1) {
    return "warning-row";
  }


  return "";
};

// 请求后台数据
const load = () => {
  service.get('/environment/getTheLatest').then((res) => {
    const newData = res.data;
    // 清空表格数据
    state.tableData = [];
    // 将获得的五条数据添加到表格数据中
    for (let i = 0; i < newData.length; i++) {
      state.tableData.push(newData[i]);
    }
    // 更新数据到界面
    humidity = state.tableData[state.tableData.length - 1].humidity;
    temperature = state.tableData[state.tableData.length - 1].temperature;
    fire = state.tableData[state.tableData.length - 1].fire;
    smoke = state.tableData[state.tableData.length - 1].smoke;
    co = state.tableData[state.tableData.length - 1].co;
    risk = state.tableData[state.tableData.length - 1].risk;
  });
};

// 初始加载数据
onMounted(() => {
  load();
});

// 每三秒刷新一次数据
setInterval(() => {
  state.tableData.shift();
  state.tableData.shift();
  state.tableData.shift();
  state.tableData.shift();
  state.tableData.shift();
  load();
  if (humidity > 80 || temperature > 50 || fire === 1 || smoke > 80 || co > 20 || risk === 1) {
    ElNotification({
      title: 'Warning',
      message: '有火情',
      type: 'error',
    })
  }
}, 10000);

// 处理分页变化
const handleCurrentChange = (val) => {
  // 这里添加处理分页变化的逻辑，你可以在这个函数中重新加载数据
  // 例如：每次加载五条数据，根据当前页数计算加载的起始索引，然后获取对应数据
}
</script>

<style>
.el-table .warning-row {
  --el-table-tr-bg-color: var(--el-color-warning-light-9);
  background-color: #cc0033;
  color: #cccccc;
}

.el-table .success-row {
  --el-table-tr-bg-color: var(--el-color-success-light-9);
}
</style>

<style scoped>
.layout-container-demo .el-header {
  position: relative;
  color: var(--el-text-color-primary);
  width: 100%;
}

.layout-container-demo .el-aside {
  color: var(--el-text-color-primary);
}

.layout-container-demo .el-menu {
  border-right: none;
}

.layout-container-demo .el-main {
  padding: 0;
}

.layout-container-demo .toolbar {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  right: 20px;
}
</style>


--- END OF FILE: J:/FireRescue\ManageSystemVue\vue-manage-system\src\views\WanDaMao.vue ---

--- START OF FILE: J:/FireRescue\RadarThermogram\EscapeRout.py ---

import matplotlib.pyplot as plt
import cv2
import numpy as np
import pandas as pd
import seaborn as sns
from numpy.random import randint

# Convert image to binary matrix
def convert_to_binary(img):
    gray_img = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    _, binary_img = cv2.threshold(gray_img, 230, 255, cv2.THRESH_BINARY)
    inverted_binary_img = cv2.bitwise_not(binary_img)
    binary_matrix = (inverted_binary_img / 255).astype(np.uint8)
    return binary_matrix

# Read the image
image_path = 'image/source/nju_map.png'
image = cv2.imread(image_path)
binary_matrix = convert_to_binary(image)

# Initialize Map class
class Map():
    def __init__(self, width, height, binary_matrix):
        self.width = width
        self.height = height
        self.map = binary_matrix

    def generatePos(self, rangeX, rangeY):
        x, y = (randint(rangeX[0], rangeX[1]), randint(rangeY[0], rangeY[1]))
        while self.map[y][x] == 1:
            x, y = (randint(rangeX[0], rangeX[1]), randint(rangeY[0], rangeY[1]))
        return (x, y)

    def getMap(self):
        return self.map

# A* algorithm for pathfinding
def AStarSearch(map, source, dest):
    class SearchEntry():
        def __init__(self, x, y, g_cost, f_cost=0, pre_entry=None):
            self.x = x
            self.y = y
            self.g_cost = g_cost
            self.f_cost = f_cost
            self.pre_entry = pre_entry

        def getPos(self):
            return (self.x, self.y)

    def getNewPosition(map, location, offset):
        x, y = (location.x + offset[0], location.y + offset[1])
        if x < 0 or x >= map.width or y < 0 or y >= map.height or map.map[y][x] == 1:
            return None
        return (x, y)

    def getPositions(map, location):
        offsets = [(-1, 0), (0, -1), (1, 0), (0, 1), (-1, -1), (1, -1), (-1, 1), (1, 1)]
        feasibleDirection = []
        for offset in offsets:
            pos = getNewPosition(map, location, offset)
            if pos is not None:
                feasibleDirection.append(pos)
        return feasibleDirection

    def calHeuristic(pos, dest):
        return abs(dest.x - pos[0]) + abs(dest.y - pos[1])

    def getMoveCost(location, pos):
        if location.x != pos[0] and location.y != pos[1]:
            return 1.4
        else:
            return 1

    def isInList(list, pos):
        if pos in list:
            return list[pos]
        return None

    def addAdjacentPositions(map, location, dest, openlist, closedlist):
        poslist = getPositions(map, location)
        for pos in poslist:
            if isInList(closedlist, pos) is None:
                findEntry = isInList(openlist, pos)
                h_cost = calHeuristic(pos, dest)
                g_cost = location.g_cost + getMoveCost(location, pos)
                if findEntry is None:
                    openlist[pos] = SearchEntry(pos[0], pos[1], g_cost, g_cost + h_cost, location)
                elif findEntry.g_cost > g_cost:
                    findEntry.g_cost = g_cost
                    findEntry.f_cost = g_cost + h_cost
                    findEntry.pre_entry = location

    def getFastPosition(openlist):
        fast = None
        for entry in openlist.values():
            if fast is None:
                fast = entry
            elif fast.f_cost > entry.f_cost:
                fast = entry
        return fast

    openlist = {}
    closedlist = {}
    location = SearchEntry(source[0], source[1], 0.0)
    dest = SearchEntry(dest[0], dest[1], 0.0)
    openlist[source] = location
    while True:
        location = getFastPosition(openlist)
        if location is None:
            print("can't find valid path")
            break
        if location.x == dest.x and location.y == dest.y:
            break
        closedlist[location.getPos()] = location
        openlist.pop(location.getPos())
        addAdjacentPositions(map, location, dest, openlist, closedlist)
    path = []
    while location is not None:
        path.append(location.getPos())
        location = location.pre_entry
    return path[::-1]  # Reverse the path to go from source to dest

WIDTH = binary_matrix.shape[1]
HEIGHT = binary_matrix.shape[0]

map = Map(WIDTH, HEIGHT, binary_matrix)

# Generate the escape routes and move the start points along the paths
def get_escape_route(dest, source_coordinates, save_path=None):
    all_paths = []
    # Generate escape routes only once
    for source in source_coordinates:
        path = AStarSearch(map, source, dest)
        all_paths.append(path)

    def safety_factor(smoke, temperature, humidity):
        return temperature * 0.1 + humidity * 0.1 + smoke * 0.8

    def renew_safety_factor(temperature, humidity, smoke):
        return safety_factor(temperature, humidity, smoke)

    for path in all_paths:
        for pos in path:
            smoke = np.random.randint(1, 4)
            humidity = np.random.randint(1, 3)
            temperature = np.random.randint(1, 3)
            safety_factor_data = renew_safety_factor(temperature, humidity, smoke)
            binary_matrix[pos[1], pos[0]] = safety_factor_data

    df = pd.DataFrame(binary_matrix)
    cmap = "RdYlGn_r"

    # Move start points along the paths
    while any(tuple(pos) != dest for pos in source_coordinates):
        for i, path in enumerate(all_paths):
            if len(path) > 0:
                step = min(20, len(path))
                source_coordinates[i] = path[step - 1]
                all_paths[i] = path[step:]

        # Plot the map with paths and safety factor heatmap
        plt.figure(figsize=(12, 12))
        sns.heatmap(df, cmap=cmap, square=True, cbar=True, alpha=0.6)
        plt.gca().invert_yaxis()
        plt.imshow(map.getMap(), cmap='binary', interpolation='nearest', vmin=0, vmax=3, alpha=0.4)
        plt.scatter(dest[0], dest[1], color='purple', s=280, marker='x', label='End')
        for i, source in enumerate(source_coordinates):
            plt.scatter(source[0], source[1], color='blue', s=90, marker='o', label=f'Start {i + 1}')
            if len(all_paths[i]) > 0:
                path_array = np.array(all_paths[i])
                plt.plot(path_array[:, 0], path_array[:, 1], linewidth=4, label=f'Path {i + 1}')

        plt.legend()
        plt.title('Map with Paths and Safety Factor Heatmap')
        plt.xlabel('X Coordinate')
        plt.ylabel('Y Coordinate')

        if save_path:
            plt.savefig(save_path)
        plt.show()
        plt.pause(0.01)

# Example usage
dest = (736, 400)
source_coordinates = [(256, 140), (270, 145), (275, 148), (279, 152)]
save_path = '../ManageSystemVue/vue-manage-system/src/img/map.png'
get_escape_route(dest, source_coordinates, save_path)


--- END OF FILE: J:/FireRescue\RadarThermogram\EscapeRout.py ---

--- START OF FILE: J:/FireRescue\RadarThermogram\FinalMap.py ---

import EscapeRout as er

if __name__ == '__main__':
    # 出口
    dest = (150, 400)
    # 起点
    source_coordinates = [(290, 324), (290, 350)]
    er.get_escape_route(dest, source_coordinates)


--- END OF FILE: J:/FireRescue\RadarThermogram\FinalMap.py ---

--- START OF FILE: J:/FireRescue\RadarThermogram\GetPosition.py ---

from PIL import Image


# 定义一个函数，判断一个像素点是否是蓝色的
def is_blue(pixel, tolerance=80):
    blue_rgb = (0, 0, 255)
    return all(abs(component - blue_rgb[i]) <= tolerance for i, component in enumerate(pixel))


# 定义一个函数，获取图片中所有蓝色像素点的坐标
def get_blue_pixel_coordinates(image):
    blue_pixel_coordinates = []

    # 获取图片的大小
    width, height = image.size

    # 将图片转换为RGB模式（如果不是的话）
    image = image.convert('RGB')

    # 将图片转换为像素点数据
    pixels = image.load()

    # 搜索蓝色像素点，接受一定的误差
    for x in range(width):
        for y in range(height):
            if is_blue(pixels[x, y]):
                blue_pixel_coordinates.append((x, y))

    # print("coordinates before:{%s}" % len(blue_pixel_coordinates))

    return blue_pixel_coordinates


# 定义一个函数，检测blue_pixel_coordinates中点之间的距离是否小于某个阈值，如果是则合并
def merge_close_points(coordinates, threshold=10):
    merged_coordinates = []
    for coord in coordinates:
        x, y = coord
        merged = False
        for merged_coord in merged_coordinates:
            merged_x, merged_y = merged_coord
            if abs(x - merged_x) <= threshold and abs(y - merged_y) <= threshold:
                merged = True
                break
        if not merged:
            merged_coordinates.append(coord)
    # print("coordinates after:{%s}" % len(blue_pixel_coordinates))
    return merged_coordinates


# 定义一个函数，接收一个栈和一个坐标列表，将新出现的坐标点压入栈中，并且如果栈内所有坐标点中有与新坐标点距离较近则视为同一坐标点
def push_coordinates(stack, coordinates):
    original_len = len(stack)
    tolerance = 10
    for coord in coordinates:
        x, y = coord
        merged = False
        for i, stack_coord in enumerate(stack):
            stack_x, stack_y = stack_coord
            if abs(x - stack_x) <= tolerance and abs(y - stack_y) <= tolerance:
                stack[i] = coord
                merged = True
                break
        if not merged:
            stack.append(coord)
    return stack


def get_initial_position():
    # 新建一个栈用于存放所有出现过的坐标点，且栈顶元素为最新的坐标点
    stack = []
    time_interval = 3
    # 打开图片
    image_path = f'./img/test_map_1.png'
    image = Image.open(image_path)
    # 获取所有蓝色像素点的坐标
    blue_pixel_coordinates = get_blue_pixel_coordinates(image)
    # 合并距离较近的点
    blue_pixel_coordinates = merge_close_points(blue_pixel_coordinates)
    # 将新出现的坐标点压入栈中
    stack = push_coordinates(stack, blue_pixel_coordinates)
    # 获取栈顶元素
    top_element = stack[-1]
    return top_element


--- END OF FILE: J:/FireRescue\RadarThermogram\GetPosition.py ---

--- START OF FILE: J:/FireRescue\RadarThermogram\mqtt.py ---

import paho.mqtt.client as mqtt
import ssl
import keyboard
import time
import json
import matplotlib.pyplot as plt
import numpy as np

# 设置字体以支持中文显示
plt.rcParams['font.sans-serif'] = ['SimHei']  # 指定黑体
plt.rcParams['axes.unicode_minus'] = False  # 用来正常显示负号

# MQTT broker configuration
BROKER_HOSTNAME = "5e1d9e2307.st1.iotda-device.cn-north-4.myhuaweicloud.com"
BROKER_PORT = 8883
BROKER_USERNAME = "65feba432ccc1a58387dee47_java_server_01"
BROKER_PASSWORD = "da130da385d816b06447f2db309b25249a60913742c56fa4cc2d6aba9472b5cf"
CLIENT_ID = "65feba432ccc1a58387dee47_java_server_01_0_0_2024071308"

# Topic configuration
SUBSCRIBE_TOPIC = "$devices/java_server_01/user/get_post"
PUBLISH_TOPIC = "$oc/devices/65feba432ccc1a58387dee47_java_server_01/sys/properties/report"


def on_connect(client, userdata, flags, rc):
    if rc == 0:
        print("Connected to MQTT Broker")
        client.subscribe(SUBSCRIBE_TOPIC)
    else:
        print("Failed to connect, return code %d\n", rc)


def on_disconnect(client, userdata, rc):
    if rc != 0:
        print('Unexpected disconnection.')


position = None


def on_message(client, userdata, msg):
    global position
    string_content = msg.payload.decode("utf-8")
    json_content = json.loads(string_content)
    position = json_content['services'][0]['properties']['position']
    # print(f"Position updated: {position}")
    return position


def publish_message(client):
    payload = {
        "services": [
            {
                "service_id": "BaseStatics",
                "properties": {
                    "timestamp": int(time.time()),
                    "exist": 1,
                },
                "event_time": int(time.time())
            }
        ]
    }
    message = json.dumps(payload)
    client.publish(PUBLISH_TOPIC, message)


def get_position():
    global position
    client = mqtt.Client(client_id=CLIENT_ID)

    client.on_connect = on_connect
    client.on_disconnect = on_disconnect
    client.on_message = on_message

    client.username_pw_set(username=BROKER_USERNAME, password=BROKER_PASSWORD)

    client.tls_set(ca_certs=None, certfile=None, keyfile=None, cert_reqs=ssl.CERT_REQUIRED,
                   tls_version=ssl.PROTOCOL_TLSv1_2, ciphers=None)

    client.connect(BROKER_HOSTNAME, port=BROKER_PORT, keepalive=60)
    print(client.on_message)

    client.loop_start()

    try:
        while True:
            if keyboard.is_pressed('esc'):
                print("ESC pressed, exiting...")
                break

            if position is not None:
                print(f"Current position: {position}")
                plot_positions(position)

            else:
                print("Waiting for position update...")

            time.sleep(5)
    except KeyboardInterrupt:
        print("Program interrupted by user.")

    client.disconnect()
    client.loop_stop()


def plot_positions(position_str):
    # 移除多余的空格并用分号分割字符串
    parts = [part.strip() for part in position_str.split(';') if part.strip()]

    # 初始化两个空数组
    x = []
    y = []

    # 遍历分割后的每一部分，并按逗号分开
    for part in parts:
        before, after = part.split(',')
        x.append(float(before))
        y.append(float(after))

    # 创建图形
    plt.figure(figsize=(8, 6))

    # 在原点处绘制小盒子 (矩形)
    box_size = 0.5  # 盒子的大小
    rectangle = plt.Rectangle((-box_size / 2, -box_size / 2), box_size, box_size, color='green', alpha=0.5)
    plt.gca().add_patch(rectangle)

    # 绘制点
    plt.scatter(x, y, color='blue', marker='o')

    # 设置图形标题和标签
    plt.title('人员实时相对位置')
    plt.xlabel('X /m')
    plt.ylabel('Y /m')

    # 设置坐标轴范围
    plt.xlim(-8, 8)
    plt.ylim(-8, 8)

    # 绘制坐标轴经过原点
    plt.axhline(0, color='black', linewidth=0.8, linestyle='--')  # y=0 轴
    plt.axvline(0, color='black', linewidth=0.8, linestyle='--')  # x=0 轴

    # 显示网格
    plt.grid(True)

    plt.savefig("image/output/position.png")
    print("图片已刷新")
    # 显示图形
    plt.show()


# 使用函数时，将 position_str 作为参数传递
# 例如：
# position_str = "-2.1,1.3; 0,0 ; 0,0 ; 0,0 ; 0,0 ;"
# plot_positions(position_str)


if __name__ == '__main__':
    get_position()


--- END OF FILE: J:/FireRescue\RadarThermogram\mqtt.py ---

--- START OF FILE: J:/FireRescue\RadarThermogram\point.py ---

import matplotlib.pyplot as plt
import numpy as np
import mqtt

# 设置字体以支持中文显示
plt.rcParams['font.sans-serif'] = ['SimHei']  # 指定黑体  
plt.rcParams['axes.unicode_minus'] = False  # 用来正常显示负号

# 输入字符串
position_str = mqtt.on_message()
print(position_str)

# 移除多余的空格并用分号分割字符串
parts = [part.strip() for part in position_str.split(';') if part.strip()]

# 初始化两个空数组
x = []
y = []

# 遍历分割后的每一部分，并按逗号分开
for part in parts:
    before, after = part.split(',')
    x.append(float(before))
    y.append(float(after))
# 手动输入坐标
num_points = 5  # 点的数量  
# x = np.array([-2.8, -6.5, 7.0, 5.5, 2.8])  # X坐标
# y = np.array([-0.8, 2.5, -6.2, 3.5, -6.5])  # Y坐标

# 创建图形  
plt.figure(figsize=(8, 6))

# 在原点处绘制小盒子 (矩形)  
box_size = 0.5  # 盒子的大小
rectangle = plt.Rectangle((-box_size / 2, -box_size / 2), box_size, box_size, color='green', alpha=0.5)
plt.gca().add_patch(rectangle)

# 绘制点  
plt.scatter(x, y, color='blue', marker='o')

# 设置图形标题和标签  
plt.title('人员实时相对位置')
plt.xlabel('X /m')
plt.ylabel('Y /m')

# 设置坐标轴范围  
plt.xlim(-8, 8)
plt.ylim(-8, 8)

# 绘制坐标轴经过原点  
plt.axhline(0, color='black', linewidth=0.8, linestyle='--')  # y=0 轴  
plt.axvline(0, color='black', linewidth=0.8, linestyle='--')  # x=0 轴  

# 显示网格  
plt.grid(True)

# 显示图形  
plt.show()


--- END OF FILE: J:/FireRescue\RadarThermogram\point.py ---

--- START OF FILE: J:/FireRescue\RadarThermogram\PositionChange.py ---

import cv2
import numpy as np
import GetPosition as gp


def convert_to_binary(img):
    # 转换为灰度图
    gray_img = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

    # 根据像素亮度设置阈值
    _, binary_img = cv2.threshold(gray_img, 230, 255, cv2.THRESH_BINARY)

    # 反转二值图像
    inverted_binary_img = cv2.bitwise_not(binary_img)

    # 将二值图像转换为只含有0和1的矩阵
    binary_matrix = (inverted_binary_img / 255).astype(np.uint8)
    return binary_matrix


def get_changed_position():
    # 读取图像
    image_path = './img/test_map_1.png'
    image = cv2.imread(image_path)

    # 转换为只含有0和1的矩阵
    building = convert_to_binary(image)

    # 获取图像的尺寸
    rows, cols = building.shape

    # 确认起始位置在图像范围内
    start = (min(400, rows - 1), min(400, cols - 1))  # 起始位置
    print(building)
    # 获取无人机初始坐标
    x = gp.get_initial_position()[0]
    y = gp.get_initial_position()[1]
    print(x)
    print(y)
    # 新初始化一个矩阵，它的大小和building一致，但是里面存放的数值是根据无人机初始坐标偏移之之后的值
    new_building = {}
    for i in range(rows):
        for j in range(cols):
            new_building[(i - x, j - y)] = building[(i, j)]
    return new_building


--- END OF FILE: J:/FireRescue\RadarThermogram\PositionChange.py ---

--- START OF FILE: J:/FireRescue\RadarThermogram\SafetyFactor.py ---

import matplotlib.pyplot as plt
import cv2
import numpy as np
import pandas as pd
import seaborn as sns
import SearchRoute as SearchRoute

# 计算安全值权重
def safety_factor(temperature=1, humidity=2, smoke=3):
    return temperature * 0.1 + humidity * 0.1 + smoke * 0.8

# 根据传感器读数更新安全系数
def renew_safety_factor(temperature, humidity, smoke):
    return safety_factor(temperature, humidity, smoke)

# 将图像转换为二值矩阵
def convert_to_binary(img):
    gray_img = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    _, binary_img = cv2.threshold(gray_img, 230, 255, cv2.THRESH_BINARY)
    inverted_binary_img = cv2.bitwise_not(binary_img)
    binary_matrix = (inverted_binary_img / 255).astype(np.uint8)
    return binary_matrix

# 读取图像
image_path = './img/map_new.png'
image = cv2.imread(image_path)

# 转换为只含有0和1的矩阵
building = convert_to_binary(image)

# 获取图像的尺寸
rows, cols = building.shape

# 确认起始位置在图像范围内
start = (min(400, rows - 1), min(400, cols - 1))  # 起始位置

# 主函数
# 初始化无人机当前位置
positionX, positionY = min(240, rows - 1), min(400, cols - 1)

# 设置初始传感器参数
smoke = 1
humidity = 1
temperature = 2

# 初始化安全系数数据
safety_factor_data = safety_factor(smoke, humidity, temperature)

# 执行搜索以获取路径
path = SearchRoute.get_path(building, start)

# 确保路径中的所有点在图像范围内
path = [(max(0, min(p[0], rows - 1)), max(0, min(p[1], cols - 1))) for p in path]

# 动态更新建筑矩阵中的安全系数
for pos in path:
    # 模拟传感器数据更新
    smoke = np.random.randint(1, 4)
    humidity = np.random.randint(1, 3)
    temperature = np.random.randint(1, 3)

    # 根据更新的传感器数据更新安全系数
    safety_factor_data = renew_safety_factor(temperature, humidity, smoke)

    # 更新当前路径点的建筑矩阵
    building[pos[0]][pos[1]] = safety_factor_data

# 将二值矩阵转换为DataFrame
df = pd.DataFrame(building)

# 设置颜色映射
cmap = "RdYlGn_r"  # 选择热力图颜色映射

# 绘制热力图
plt.figure(figsize=(12, 12))  # 设置图像大小
sns.heatmap(df, cmap=cmap, square=True, cbar=True)  # 绘制热力图

plt.gca().invert_yaxis()  # 反转y轴，使(0,0)在左上角
plt.show()  # 显示图像


--- END OF FILE: J:/FireRescue\RadarThermogram\SafetyFactor.py ---

--- START OF FILE: J:/FireRescue\RadarThermogram\SearchRoute.py ---

import matplotlib.pyplot as plt
from collections import deque
import cv2
import numpy as np
import GetPosition as gp


def convert_to_binary(img):
    # 转换为灰度图
    gray_img = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

    # 根据像素亮度设置阈值
    _, binary_img = cv2.threshold(gray_img, 230, 255, cv2.THRESH_BINARY)

    # 反转二值图像
    inverted_binary_img = cv2.bitwise_not(binary_img)

    # 将二值图像转换为只含有0和1的矩阵
    binary_matrix = (inverted_binary_img / 255).astype(np.uint8)
    return binary_matrix


# 读取图像
image_path = './image/source/nju_map.png'
image = cv2.imread(image_path)

# 转换为只含有0和1的矩阵
building = convert_to_binary(image)

# 定义起始位置
start = (250, 250)  # 起始位置


# 以现在点为中心将附近的临近点标记为以探索
# 向左探测五格，向右探测5格
def mark_near_by(current, building):
    for i in range(current[0] - 2, current[0] + 3):
        for j in range(current[1] - 2, current[1] + 3):
            if 0 <= i < len(building) and 0 <= j < len(building[0]) and building[i][j] == 0:
                building[i][j] = 1
    return current


# 定义结合DFS和BFS的算法
def get_path(building, start):
    rows, cols = len(building), len(building[0])  # 获取建筑的行数和列数
    directions = [(0, 4), (0, -3), (4, 0), (-3, 0)]  # 定义四个移动方向：右、左、下、上 (在这里定义无人机的搜索能力# )
    stack = [start]  # 使用栈来实现深度优先搜索（DFS）
    queue = deque([start])  # 使用队列来记录已经探索过但还未完全展开的节点
    visited = set()  # 记录已访问的节点
    path = []  # 记录遍历路径

    while stack or queue:  # 当栈或队列不为空时继续循环
        if stack:  # 优先使用DFS
            current = stack.pop()
        else:  # 当栈为空时，使用队列中的节点继续搜索
            current = queue.popleft()

        if current not in visited:  # 如果当前节点未被访问
            visited.add(mark_near_by(current, building))  # 将当前节点标记为已访问
            path.append(current)  # 将当前节点添加到路径中
            for direction in directions:  # 遍历所有可能的移动方向
                neighbor = (current[0] + direction[0], current[1] + direction[1])
                if 0 <= neighbor[0] < rows and 0 <= neighbor[1] < cols:  # 检查邻居节点是否在建筑范围内
                    if building[neighbor[0]][neighbor[1]] == 0 and neighbor not in visited:  # 检查邻居节点是否可通过且未访问
                        stack.append(neighbor)  # 将邻居节点添加到栈中
                        queue.append(neighbor)  # 将邻居节点添加到队列中
    # 根据获取的无人机初始坐标偏移path对应的坐标
    x = gp.get_initial_position()[0]
    y = gp.get_initial_position()[1]

    # 将path中的坐标点根据无人机初始坐标偏移
    for i in range(len(path)):
        path[i] = (path[i][0] - x, path[i][1] - y)
    print(path)
    return path  # 返回覆盖所有区域的路径


if __name__ == '__main__':
    path = get_path(building, start)


--- END OF FILE: J:/FireRescue\RadarThermogram\SearchRoute.py ---

--- START OF FILE: J:/FireRescue\RadarThermogram\set_red_position.py ---

from PIL import Image
import numpy as np

# 打开图片
image_path = "./img/test_map_1.png"
img = Image.open(image_path)
img_rgb = img.convert("RGB")
img_array = np.array(img_rgb)

# 获取图片的大小
h, w, _ = img_array.shape
print(f"Image dimensions: {h} x {w}")

# 指定修改像素点的位置
pos = [(1000, 779), (1000, 784), (1000, 780), (1000, 781)]

# 修改指定位置的像素点为红色
for y, x in pos:
    if 0 <= y < h and 0 <= x < w:  # 确保坐标在图片范围内
        img_array[y, x] = [255, 0, 0]

# 将修改后的数组转换回图像
img_modified = Image.fromarray(img_array)

# 显示并保存修改后的图像
# img_modified.show()
img_modified.save("./img/red_position.png")

from PIL import ImageGrab

import pyautogui

# 定义截图区域 (left, top, width, height)
region = (0, 100, 300, 300)

# 获取特定区域的屏幕截图
screenshot = pyautogui.screenshot(region=region)

# 保存截图
screenshot.save("screenshot_region.png")


--- END OF FILE: J:/FireRescue\RadarThermogram\set_red_position.py ---

--- START OF FILE: J:/FireRescue\RadarThermogram\test.py ---

# 输入字符串
position_str = "-2.1,1.3; 0,0 ; 0,0 ; 0,0 ; 0,0 ;"

# 移除多余的空格并用分号分割字符串
parts = [part.strip() for part in position_str.split(';') if part.strip()]

# 初始化两个空数组
before_comma = []
after_comma = []

# 遍历分割后的每一部分，并按逗号分开
for part in parts:
    before, after = part.split(',')
    before_comma.append(float(before))
    after_comma.append(float(after))




--- END OF FILE: J:/FireRescue\RadarThermogram\test.py ---
